

<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>haddock.libs.libalign &mdash; haddock3 3.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.min.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

</head>

<body>
    <header>
        <div class="container">
            <a class="site-nav-toggle hidden-lg-up"><i class="icon-menu"></i></a>
            <a class="site-title" href="../../../index.html">
                haddock3
            </a>
        </div>
    </header>


<div class="breadcrumbs-outer hidden-xs-down">
    <div class="container">
        















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a></li>
        
          <li><a href="../../index.html">Module code</a></li>
        
      <li>haddock.libs.libalign</li>
    
    
      <li class="breadcrumbs-aside">
        
      </li>
    
  </ul>
</div>
    </div>
</div>
    <div class="main-outer">
        <div class="container">
            <div class="row">
                <div class="col-12 col-lg-3 site-nav">
                    
<div role="search">
    <form class="search" action="../../../search.html" method="get">
        <div class="icon-input">
            <input type="text" name="q" placeholder="Search" />
            <span class="icon-search"></span>
        </div>
        <input type="submit" value="Go" class="d-hidden" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div>
                    <div class="site-nav-tree">
                        
                            
                            
                                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">A brieft introduction to HADDOCK3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../INSTALL.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../INSTALL.html#clone-this-repository">1 Clone this repository:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../INSTALL.html#create-a-virtual-environment-with-python-3-9-and-install-dependencies">2 Create a virtual environment with Python 3.9+ and install dependencies:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../INSTALL.html#install-the-haddock3-package-and-command-line-clients">3 Install the HADDOCK3 package and command line clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../INSTALL.html#make-a-cns-binary-shortcut-to-the-expected-path">4 Make a CNS binary shortcut to the expected path:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../INSTALL.html#keep-your-installation-up-to-date">5 Keep your installation up to date</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../INSTALL.html#installing-third-party-packages">Installing third-party packages</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../INSTALL.html#lightdock"><code class="docutils literal notranslate"><span class="pre">lightdock</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../INSTALL.html#gdock"><code class="docutils literal notranslate"><span class="pre">gdock</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../USAGE.html">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../USAGE.html#run-haddock3">Run HADDOCK3</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Workflow Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#docking-antibogy-antigen">docking-antibogy-antigen</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#docking-protein-dna">docking-protein-dna</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#docking-protein-homotrimer">docking-protein-homotrimer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#docking-protein-ligand">docking-protein-ligand</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#docking-protein-ligand-shape">docking-protein-ligand-shape</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#docking-protein-peptide">docking-protein-peptide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#docking-protein-protein">docking-protein-protein</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#refine-complex">refine-complex</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../examples.html#scoring">scoring</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Advanced features</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/index.html#haddock3-functionalities">HADDOCK3 functionalities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/index.html#tutorials-for-developers">Tutorials for developers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../clients/index.html">Command-line interfaces</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../clients/clihd3.html">Run HADDOCK3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../clients/clicfg.html">Retrieve config</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../clients/cliscore.html">Calculate score</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../clients/clipp.html">PDB preprocessing client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../clients/clicp.html">Copy steps to new run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../clients/cliclean.html">Clean output Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../clients/cliunpack.html">Unpack output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../clients/climpi.html">HADDOCK3 MPI Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../clients/clibm.html">Benchmark Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../clients/clidmn.html">Benchmark Daemon</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/index.html">Modules</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/topology/index.html">Topology Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/sampling/index.html">Sampling Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/refinement/index.html">Model Refinement Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/scoring/index.html">Scoring Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/analysis/index.html">Analysis Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/extras/index.html">Extra modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#module-haddock.modules">Parent code for modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#module-haddock.modules.base_cns_module">Parent code for CNS modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../modules/index.html#general-default-parameters">General Default parameters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/index.html">Testing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../testing/integration_tests.html">Running integration tests manually</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing to HADDOCK3</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#contributing-new-code">1. Contributing new code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../contributing.html#contributing-with-documentation">2. Contributing with documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../citing.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Library Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/core/index.html">Core Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/libs/index.html">Libs Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/gear/index.html">Gear Reference</a></li>
</ul>
</li>
</ul>

                            
                        
                    </div>
                </div>
                <div class="col-12 col-lg-9">
                    <div class="document">
                        
                            
  <h1>Source code for haddock.libs.libalign</h1><div class="highlight"><pre>
<span></span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Library of functions to perform sequence and structural alignments.</span>

<span class="sd">Main functions</span>
<span class="sd">--------------</span>

<span class="sd">* :py:func:`calc_rmsd`</span>
<span class="sd">* :py:func:`centroid`</span>
<span class="sd">* :py:func:`kabsch`</span>
<span class="sd">* :py:func:`load_coords`</span>
<span class="sd">* :py:func:`pdb2fastadic`</span>
<span class="sd">* :py:func:`get_atoms`</span>
<span class="sd">* :py:func:`get_align`</span>
<span class="sd">* :py:func:`align_struct`</span>
<span class="sd">* :py:func:`align_seq`</span>
<span class="sd">* :py:func:`make_range`</span>
<span class="sd">* :py:func:`dump_as_izone`</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">Bio</span> <span class="kn">import</span> <span class="n">Align</span>
<span class="kn">from</span> <span class="nn">Bio.Align</span> <span class="kn">import</span> <span class="n">substitution_matrices</span>
<span class="kn">from</span> <span class="nn">Bio.Seq</span> <span class="kn">import</span> <span class="n">Seq</span>

<span class="kn">from</span> <span class="nn">haddock</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">haddock.libs.libontology</span> <span class="kn">import</span> <span class="n">PDBFile</span>
<span class="kn">from</span> <span class="nn">haddock.libs.libpdb</span> <span class="kn">import</span> <span class="n">split_by_chain</span>


<span class="n">RES_TO_BE_IGNORED</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SHA&quot;</span><span class="p">,</span> <span class="s2">&quot;WAT&quot;</span><span class="p">]</span>

<span class="n">PROT_RES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;ALA&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ARG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ASN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ASP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CYS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GLN&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GLU&quot;</span><span class="p">,</span>
    <span class="s2">&quot;GLY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;HIS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ILE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LEU&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LYS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MET&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PHE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PRO&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SER&quot;</span><span class="p">,</span>
    <span class="s2">&quot;THR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TRP&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TYR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;VAL&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<span class="n">DNA_RES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DA&quot;</span><span class="p">,</span> <span class="s2">&quot;DC&quot;</span><span class="p">,</span> <span class="s2">&quot;DT&quot;</span><span class="p">,</span> <span class="s2">&quot;DG&quot;</span><span class="p">]</span>
<span class="c1"># Backbone</span>
<span class="n">PROT_ATOMS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">]</span>
<span class="c1"># Bases</span>
<span class="n">DNA_ATOMS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;C5&quot;</span><span class="p">,</span>
    <span class="s2">&quot;N9&quot;</span><span class="p">,</span>
    <span class="s2">&quot;N2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C8&quot;</span><span class="p">,</span>
    <span class="s2">&quot;O2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;N4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;N7&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C7&quot;</span><span class="p">,</span>
    <span class="s2">&quot;N1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;N6&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;O4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C6&quot;</span><span class="p">,</span>
    <span class="s2">&quot;N3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C4&quot;</span><span class="p">,</span>
    <span class="s2">&quot;O6&quot;</span><span class="p">,</span>
    <span class="p">]</span>


<div class="viewcode-block" id="ALIGNError"><a class="viewcode-back" href="../../../reference/libs/libalign.html#haddock.libs.libalign.ALIGNError">[docs]</a><span class="k">class</span> <span class="nc">ALIGNError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised when something goes wrong with the ALIGNMENT library.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="calc_rmsd"><a class="viewcode-back" href="../../../reference/libs/libalign.html#haddock.libs.libalign.calc_rmsd">[docs]</a><span class="k">def</span> <span class="nf">calc_rmsd</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the RMSD from two vectors.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    V : np.array dtype=float, shape=(n_atoms,3)</span>
<span class="sd">    W : np.array dtype=float, shape=(n_atoms,3)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rmsd : float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">V</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">rmsd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">diff</span> <span class="o">*</span> <span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rmsd</span></div>


<div class="viewcode-block" id="kabsch"><a class="viewcode-back" href="../../../reference/libs/libalign.html#haddock.libs.libalign.kabsch">[docs]</a><span class="k">def</span> <span class="nf">kabsch</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the rotation matrix using Kabsch algorithm.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    P : np.array dtype=float, shape=(n_atoms,3)</span>
<span class="sd">    Q : np.array dtype=float, shape=(n_atoms,3)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    U : np.array dtype=float, shape=(3,3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Covariance matrix</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
    <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">P</span><span class="p">),</span> <span class="n">Q</span><span class="p">)</span>
    <span class="c1"># use SVD</span>
    <span class="n">V</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">V</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">W</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">S</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">S</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">V</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">V</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Create Rotation matrix U</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">U</span></div>


<div class="viewcode-block" id="centroid"><a class="viewcode-back" href="../../../reference/libs/libalign.html#haddock.libs.libalign.centroid">[docs]</a><span class="k">def</span> <span class="nf">centroid</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the centroid.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : np.array dtype=float, shape=(n_atoms,3)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    C : np.array dtype=float, shape=(3,)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">C</span></div>


<div class="viewcode-block" id="load_coords"><a class="viewcode-back" href="../../../reference/libs/libalign.html#haddock.libs.libalign.load_coords">[docs]</a><span class="k">def</span> <span class="nf">load_coords</span><span class="p">(</span><span class="n">pdb_f</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">filter_resdic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">numbering_dic</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load coordinates from PDB.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pdb_f : PDBFile</span>

<span class="sd">    atoms : dict</span>
<span class="sd">        dictionary of atoms</span>

<span class="sd">    filter_resdic : dict</span>
<span class="sd">        dictionary of residues to be loaded (one list per chain)</span>

<span class="sd">    numbering_dic : dict</span>
<span class="sd">        dict of numbering dictionaries (one dictionary per chain)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    coord_dic : dict</span>
<span class="sd">        dictionary of coordinates (one per chain)</span>

<span class="sd">    chain_ranges: dict</span>
<span class="sd">        dictionary of chain ranges</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coord_dic</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">chain_dic</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdb_f</span><span class="p">,</span> <span class="n">PDBFile</span><span class="p">):</span>
        <span class="n">pdb_f</span> <span class="o">=</span> <span class="n">pdb_f</span><span class="o">.</span><span class="n">rel_path</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdb_f</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ATOM&quot;</span><span class="p">):</span>
                <span class="n">atom_name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">resname</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">chain</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span>
                <span class="n">resnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">26</span><span class="p">])</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">38</span><span class="p">])</span>
                <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">38</span><span class="p">:</span><span class="mi">46</span><span class="p">])</span>
                <span class="n">z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">46</span><span class="p">:</span><span class="mi">54</span><span class="p">])</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">numbering_dic</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">resnum</span> <span class="o">=</span> <span class="n">numbering_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="n">resnum</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="c1"># this residue is not matched, and so it should</span>
                        <span class="c1">#  not be considered</span>
                        <span class="c1"># self.log(</span>
                        <span class="c1">#     f&quot;WARNING: {chain}.{resnum}.{atom_name}&quot;</span>
                        <span class="c1">#     &quot; was not matched!&quot;</span>
                        <span class="c1">#     )</span>
                        <span class="k">continue</span>
                <span class="c1"># identifier = f&quot;{chain}.{resnum}.{atom_name}&quot;</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">resnum</span><span class="p">,</span> <span class="n">atom_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">atom_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">[</span><span class="n">resname</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chain_dic</span><span class="p">:</span>
                    <span class="n">chain_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">filter_resdic</span><span class="p">:</span>
                    <span class="c1"># Only retrieve coordinates from the filter_resdic</span>
                    <span class="k">if</span> <span class="p">(</span>
                            <span class="n">chain</span> <span class="ow">in</span> <span class="n">filter_resdic</span>
                            <span class="ow">and</span> <span class="n">resnum</span> <span class="ow">in</span> <span class="n">filter_resdic</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span>
                            <span class="p">):</span>
                        <span class="n">coord_dic</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
                        <span class="n">chain_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># retrieve everything</span>
                    <span class="n">coord_dic</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">coords</span>
                    <span class="n">chain_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">chain_ranges</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chain_dic</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chain_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">]:</span>
            <span class="c1"># this may happen when filter_resdic is defined on a different set</span>
            <span class="c1"># of chains</span>
            <span class="k">raise</span> <span class="n">ALIGNError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Chain matching error on </span><span class="si">{</span><span class="n">pdb_f</span><span class="si">}</span><span class="s2">, chain </span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">min_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">chain_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">])</span>
            <span class="n">max_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">chain_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">])</span>
            <span class="n">chain_ranges</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_idx</span><span class="p">,</span> <span class="n">max_idx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coord_dic</span><span class="p">,</span> <span class="n">chain_ranges</span></div>


<div class="viewcode-block" id="get_atoms"><a class="viewcode-back" href="../../../reference/libs/libalign.html#haddock.libs.libalign.get_atoms">[docs]</a><span class="k">def</span> <span class="nf">get_atoms</span><span class="p">(</span><span class="n">pdb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify what is the molecule type of each PDB.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pdb : PosixPath or :py:class:`haddock.libs.libontology.PDBFile`</span>
<span class="sd">        PDB file to have its atoms identified</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    atom_dic : dict</span>
<span class="sd">        dictionary of atoms</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atom_dic</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">atom_dic</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">PROT_ATOMS</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">PROT_RES</span><span class="p">))</span>
    <span class="n">atom_dic</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">DNA_ATOMS</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">DNA_RES</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="n">PDBFile</span><span class="p">):</span>
        <span class="n">pdb</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="n">rel_path</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdb</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;ATOM&quot;</span><span class="p">,</span> <span class="s2">&quot;HETATM&quot;</span><span class="p">)):</span>
                <span class="n">resname</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">atom_name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">76</span><span class="p">:</span><span class="mi">78</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span>
                        <span class="n">resname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PROT_RES</span>
                        <span class="ow">and</span> <span class="n">resname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DNA_RES</span>
                        <span class="ow">and</span> <span class="n">resname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RES_TO_BE_IGNORED</span>
                        <span class="p">):</span>
                    <span class="c1"># its neither DNA nor protein, use the heavy atoms</span>
                    <span class="c1"># WARNING: Atoms that belong to unknown residues must</span>
                    <span class="c1">#  be bound to a residue name;</span>
                    <span class="c1">#   For example: residue NEP, also contains</span>
                    <span class="c1">#  CB and CG atoms, if we do not bind it to the</span>
                    <span class="c1">#  residue name, the next functions will include</span>
                    <span class="c1">#  CG and CG atoms in the calculations for all</span>
                    <span class="c1">#  other residue names</span>
                    <span class="k">if</span> <span class="n">element</span> <span class="o">!=</span> <span class="s2">&quot;H&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">resname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom_dic</span><span class="p">:</span>
                            <span class="n">atom_dic</span><span class="p">[</span><span class="n">resname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">atom_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom_dic</span><span class="p">[</span><span class="n">resname</span><span class="p">]:</span>
                            <span class="n">atom_dic</span><span class="p">[</span><span class="n">resname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">atom_dic</span></div>


<div class="viewcode-block" id="pdb2fastadic"><a class="viewcode-back" href="../../../reference/libs/libalign.html#haddock.libs.libalign.pdb2fastadic">[docs]</a><span class="k">def</span> <span class="nf">pdb2fastadic</span><span class="p">(</span><span class="n">pdb_f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write the sequence as a fasta.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pdb_f : PosixPath or :py:class:`haddock.libs.libontology.PDBFile`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    seq_dic : dict</span>
<span class="sd">        dict of fasta sequences (one per chain)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res_codes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;CYS&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;ASP&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;SER&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;GLN&quot;</span><span class="p">,</span> <span class="s2">&quot;Q&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;LYS&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;ILE&quot;</span><span class="p">,</span> <span class="s2">&quot;I&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;PRO&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;THR&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;PHE&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;ASN&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;GLY&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;HIS&quot;</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;LEU&quot;</span><span class="p">,</span> <span class="s2">&quot;L&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;ARG&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;TRP&quot;</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;ALA&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;VAL&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;GLU&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;TYR&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;MET&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;DA&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;DC&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;DT&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="n">seq_dic</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdb_f</span><span class="p">,</span> <span class="n">PDBFile</span><span class="p">):</span>
        <span class="n">pdb_f</span> <span class="o">=</span> <span class="n">pdb_f</span><span class="o">.</span><span class="n">rel_path</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdb_f</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ATOM&quot;</span><span class="p">):</span>
                <span class="n">res_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">26</span><span class="p">])</span>
                <span class="n">res_name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">chain</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">res_name</span> <span class="ow">in</span> <span class="n">RES_TO_BE_IGNORED</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">one_letter</span> <span class="o">=</span> <span class="n">res_codes</span><span class="p">[</span><span class="n">res_name</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">one_letter</span> <span class="o">=</span> <span class="s2">&quot;X&quot;</span>
                <span class="k">if</span> <span class="n">chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seq_dic</span><span class="p">:</span>
                    <span class="n">seq_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">seq_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="n">res_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">one_letter</span>
    <span class="k">return</span> <span class="n">seq_dic</span></div>


<div class="viewcode-block" id="get_align"><a class="viewcode-back" href="../../../reference/libs/libalign.html#haddock.libs.libalign.get_align">[docs]</a><span class="k">def</span> <span class="nf">get_align</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">lovoalign_exec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the alignment function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    method : str</span>
<span class="sd">        Available options: ``sequence`` and ``structure``.</span>

<span class="sd">    lovoalign_exec : str</span>
<span class="sd">        Path to the lovoalign executable.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    align_func : functools.partial</span>
<span class="sd">        desired alignment function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> alignment&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;structure&quot;</span><span class="p">:</span>
        <span class="n">align_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
            <span class="n">align_strct</span><span class="p">,</span>
            <span class="n">lovoalign_exec</span><span class="o">=</span><span class="n">lovoalign_exec</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;sequence&quot;</span><span class="p">:</span>
        <span class="n">align_func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">align_seq</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">available_alns</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;sequence&quot;</span><span class="p">,</span> <span class="s2">&quot;structure&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Alignment method </span><span class="si">{</span><span class="n">method</span><span class="si">!r}</span><span class="s2"> not recognized. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Available options are </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available_alns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">align_func</span></div>


<div class="viewcode-block" id="align_strct"><a class="viewcode-back" href="../../../reference/libs/libalign.html#haddock.libs.libalign.align_strct">[docs]</a><span class="k">def</span> <span class="nf">align_strct</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">lovoalign_exec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Structuraly align and get numbering relationship.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reference : :py:class:`haddock.libs.libontology.PDBFile`</span>

<span class="sd">    model : :py:class:`haddock.libs.libontology.PDBFile`</span>

<span class="sd">    output_path : Path</span>

<span class="sd">    lovoalign_exec : Path</span>
<span class="sd">        lovoalign executable</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numbering_dic : dict</span>
<span class="sd">        dict of numbering dictionaries (one dictionary per chain)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lovoalign_exec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s2">&quot;Structural alignment needs LovoAlign &quot;</span>
            <span class="s2">&quot;get it at github.com/m3g/lovoalign&quot;</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="n">ALIGNError</span><span class="p">(</span><span class="s2">&quot;Path to LovoAlign executable required.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">lovoalign_exec</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ALIGNError</span><span class="p">(</span><span class="s2">&quot;lovoalign_exec parameter not defined &quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">lovoalign_exec</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ALIGNError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lovoalign_exec</span><span class="si">!r}</span><span class="s2"> for LovoAlign is not executable&quot;</span><span class="p">)</span>

    <span class="n">numbering_dic</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">protein_a_dic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">split_by_chain</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">protein_b_dic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">split_by_chain</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># check if chain ids match</span>
    <span class="k">if</span> <span class="n">protein_a_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">!=</span> <span class="n">protein_b_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># TODO: Make this a clearer raise</span>
        <span class="k">return</span> <span class="n">numbering_dic</span>

    <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">protein_a_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">pa_seqdic</span> <span class="o">=</span> <span class="n">pdb2fastadic</span><span class="p">(</span><span class="n">protein_a_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">])</span>
        <span class="n">pb_seqdic</span> <span class="o">=</span> <span class="n">pdb2fastadic</span><span class="p">(</span><span class="n">protein_b_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">])</span>
        <span class="c1"># logging.debug(f&quot;Structurally aligning chain {chain}&quot;)</span>
        <span class="n">numbering_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lovoalign_exec</span><span class="si">}</span><span class="s2"> -p1 </span><span class="si">{</span><span class="n">protein_a_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;-p2 </span><span class="si">{</span><span class="n">protein_b_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;-c1 </span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s2"> -c2 </span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># logging.debug(f&quot;Command is: {cmd}&quot;)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">lovoalign_out</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="p">)</span>

        <span class="c1"># we don&quot;t need the splitted proteins anymore</span>
        <span class="n">protein_a_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="n">protein_b_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># find out where the alignment starts and ends</span>
        <span class="n">alignment_pass</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lovoalign_out</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;SEQUENCE ALIGNMENT&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># there are 2 extra white lines after this header</span>
                <span class="n">alignment_start_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="s2">&quot;FINAL&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="c1"># there are 2 extra white lines after this header</span>
                <span class="n">alignment_end_index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="s2">&quot;ERROR&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">failed_pdb</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">_msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;LovoAlign could not read </span><span class="si">{</span><span class="n">failed_pdb</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="s2">&quot;is it a ligand?&quot;</span>
                    <span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_msg</span><span class="p">)</span>
                <span class="n">alignment_pass</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">pa_seqdic</span><span class="p">[</span><span class="n">chain</span><span class="p">]]:</span>
                    <span class="n">numbering_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="n">elem</span><span class="p">]</span> <span class="o">=</span> <span class="n">elem</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">alignment_pass</span><span class="p">:</span>
            <span class="c1"># This alignment failed, move on to the next</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Skipping alignment of chain </span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;used sequential matching&quot;</span>
                <span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">aln_l</span> <span class="o">=</span> <span class="n">lovoalign_out</span><span class="p">[</span><span class="n">alignment_start_index</span><span class="p">:</span><span class="n">alignment_end_index</span><span class="p">]</span>

        <span class="c1"># dump this alignment to a file</span>
        <span class="n">aln_fname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;lovoalign_</span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s2">.aln&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing alignment to </span><span class="si">{</span><span class="n">aln_fname</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">aln_fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aln_l</span><span class="p">))</span>

        <span class="c1"># remove the line between the alignment segments</span>
        <span class="n">alignment</span> <span class="o">=</span> <span class="p">[</span><span class="n">aln_l</span><span class="p">[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">aln_l</span><span class="p">),</span> <span class="mi">3</span><span class="p">)]</span>
        <span class="c1"># 100% (5 identical nucleotides / min(length(A),length(B))).</span>
        <span class="n">len_seq_a</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa_seqdic</span><span class="p">[</span><span class="n">chain</span><span class="p">])</span>
        <span class="n">len_seq_b</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pb_seqdic</span><span class="p">[</span><span class="n">chain</span><span class="p">])</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">len_seq_a</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">alignment</span><span class="p">]))</span>
            <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="n">len_seq_a</span><span class="p">,</span> <span class="n">len_seq_b</span><span class="p">)</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">identity</span> <span class="o">&lt;=</span> <span class="mf">40.0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">Structural</span><span class="se">\&quot;</span><span class="s2"> identity of chain </span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">identity</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%,&quot;</span>
                <span class="s2">&quot; please check the results carefully&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">Structural</span><span class="se">\&quot;</span><span class="s2"> identity of chain </span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">identity</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
                <span class="p">)</span>

        <span class="c1"># logging.debug(&quot;Reading alignment and matching numbering&quot;)</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">alignment</span><span class="p">:</span>
            <span class="n">line_a</span><span class="p">,</span> <span class="n">line_b</span> <span class="o">=</span> <span class="n">element</span>

            <span class="n">resnum_a</span><span class="p">,</span> <span class="n">seq_a</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">line_a</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">resnum_b</span><span class="p">,</span> <span class="n">seq_b</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">line_b</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

            <span class="n">resnum_a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resnum_a</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">resnum_b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resnum_b</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">resname_a</span><span class="p">,</span> <span class="n">resname_b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">seq_a</span><span class="p">,</span> <span class="n">seq_b</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">resname_a</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                    <span class="n">resnum_a</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">resname_b</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                    <span class="n">resnum_b</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">resname_a</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span> <span class="ow">and</span> <span class="n">resname_b</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                    <span class="n">numbering_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="n">resnum_b</span><span class="p">]</span> <span class="o">=</span> <span class="n">resnum_a</span>

    <span class="n">izone_fname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;lovoalign.izone&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving .izone to </span><span class="si">{</span><span class="n">izone_fname</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">dump_as_izone</span><span class="p">(</span><span class="n">izone_fname</span><span class="p">,</span> <span class="n">numbering_dic</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">numbering_dic</span></div>


<div class="viewcode-block" id="align_seq"><a class="viewcode-back" href="../../../reference/libs/libalign.html#haddock.libs.libalign.align_seq">[docs]</a><span class="k">def</span> <span class="nf">align_seq</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sequence align and get the numbering relationship.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reference : PosixPath or :py:class:`haddock.libs.libontology.PDBFile`</span>

<span class="sd">    model : PosixPath or :py:class:`haddock.libs.libontology.PDBFile`</span>

<span class="sd">    output_path : Path</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    align_dic : dict</span>
<span class="sd">        dictionary of sequence alignments (one per chain)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seqdic_ref</span> <span class="o">=</span> <span class="n">pdb2fastadic</span><span class="p">(</span><span class="n">reference</span><span class="p">)</span>
    <span class="n">seqdic_model</span> <span class="o">=</span> <span class="n">pdb2fastadic</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">seqdic_ref</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">!=</span> <span class="n">seqdic_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1"># TODO: Implement chain-matching here</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">align_dic</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ref_chain</span><span class="p">,</span> <span class="n">model_chain</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">seqdic_ref</span><span class="p">,</span> <span class="n">seqdic_model</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">ref_chain</span> <span class="o">!=</span> <span class="n">model_chain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AlignError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Chain mismatch: </span><span class="si">{</span><span class="n">ref_chain</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">model_chain</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="n">align_dic</span><span class="p">[</span><span class="n">ref_chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">seq_ref</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seqdic_ref</span><span class="p">[</span><span class="n">ref_chain</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">seq_model</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seqdic_model</span><span class="p">[</span><span class="n">model_chain</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="n">aligner</span> <span class="o">=</span> <span class="n">Align</span><span class="o">.</span><span class="n">PairwiseAligner</span><span class="p">()</span>
        <span class="n">aligner</span><span class="o">.</span><span class="n">substitution_matrix</span> <span class="o">=</span> <span class="n">substitution_matrices</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;BLOSUM62&quot;</span><span class="p">)</span>
        <span class="n">alns</span> <span class="o">=</span> <span class="n">aligner</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">seq_ref</span><span class="p">,</span> <span class="n">seq_model</span><span class="p">)</span>
        <span class="n">top_aln</span> <span class="o">=</span> <span class="n">alns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">aln_fname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;blosum62_</span><span class="si">{</span><span class="n">ref_chain</span><span class="si">}</span><span class="s2">.aln&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing alignment to </span><span class="si">{</span><span class="n">aln_fname</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">aln_fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">top_aln</span><span class="p">))</span>
        <span class="n">aligned_ref_segment</span><span class="p">,</span> <span class="n">aligned_model_segment</span> <span class="o">=</span> <span class="n">top_aln</span><span class="o">.</span><span class="n">aligned</span>

        <span class="c1"># this should always be true</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">aligned_ref_segment</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">aligned_model_segment</span><span class="p">)</span>

        <span class="n">identity</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">top_aln</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">seq_ref</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_model</span><span class="p">)))</span>
            <span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">top_aln</span><span class="o">.</span><span class="n">aligned</span><span class="p">):</span>
            <span class="c1"># No alignment!</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No alignment for chain </span><span class="si">{</span><span class="n">ref_chain</span><span class="si">}</span><span class="s2"> is it protein/dna? &quot;</span>
                <span class="s2">&quot;Matching sequentially&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="s2">&quot;X&quot;</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seq_ref</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="s2">&quot;X&quot;</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">seq_model</span><span class="p">):</span>
                <span class="c1"># this sequence contains only ligands, do it manually</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_ref</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_model</span><span class="p">):</span>
                    <span class="c1"># we cannot handle this</span>
                    <span class="k">raise</span> <span class="sa">f</span><span class="s2">&quot;Cannot align chain </span><span class="si">{</span><span class="n">model_chain</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">ref_res</span><span class="p">,</span> <span class="n">model_res</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="n">seqdic_ref</span><span class="p">[</span><span class="n">ref_chain</span><span class="p">],</span>
                        <span class="n">seqdic_model</span><span class="p">[</span><span class="n">model_chain</span><span class="p">]):</span>

                    <span class="n">align_dic</span><span class="p">[</span><span class="n">ref_chain</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">model_res</span><span class="p">:</span> <span class="n">ref_res</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">identity</span> <span class="o">&lt;=</span> <span class="mf">40.0</span><span class="p">:</span>
                <span class="c1"># Identity is very low</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Sequence identity of chain </span><span class="si">{</span><span class="n">ref_chain</span><span class="si">}</span><span class="s2"> is &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">identity</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%, please check the results carefully&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Please use alignment_method = </span><span class="se">\&quot;</span><span class="s2">structure</span><span class="se">\&quot;</span><span class="s2"> instead&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Sequence identity between chain </span><span class="si">{</span><span class="n">ref_chain</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; of </span><span class="si">{</span><span class="n">reference</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> is &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">identity</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ref_segment</span><span class="p">,</span> <span class="n">model_segment</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">aligned_ref_segment</span><span class="p">,</span> <span class="n">aligned_model_segment</span><span class="p">):</span>

                <span class="n">start_ref_segment</span><span class="p">,</span> <span class="n">end_ref_segment</span> <span class="o">=</span> <span class="n">ref_segment</span>
                <span class="n">start_model_segment</span><span class="p">,</span> <span class="n">end_model_segment</span> <span class="o">=</span> <span class="n">model_segment</span>

                <span class="n">reslist_ref</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">seqdic_ref</span><span class="p">[</span><span class="n">ref_chain</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span>
                    <span class="n">start_ref_segment</span><span class="p">:</span><span class="n">end_ref_segment</span><span class="p">]</span>

                <span class="n">reslist_model</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">seqdic_model</span><span class="p">[</span><span class="n">model_chain</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span>
                    <span class="n">start_model_segment</span><span class="p">:</span><span class="n">end_model_segment</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">_ref_res</span><span class="p">,</span> <span class="n">_model_res</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">reslist_ref</span><span class="p">,</span> <span class="n">reslist_model</span><span class="p">):</span>
                    <span class="n">align_dic</span><span class="p">[</span><span class="n">ref_chain</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">_model_res</span><span class="p">:</span> <span class="n">_ref_res</span><span class="p">})</span>

    <span class="n">izone_fname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s2">&quot;blosum62.izone&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving .izone to </span><span class="si">{</span><span class="n">izone_fname</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">dump_as_izone</span><span class="p">(</span><span class="n">izone_fname</span><span class="p">,</span> <span class="n">align_dic</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">align_dic</span></div>


<div class="viewcode-block" id="make_range"><a class="viewcode-back" href="../../../reference/libs/libalign.html#haddock.libs.libalign.make_range">[docs]</a><span class="k">def</span> <span class="nf">make_range</span><span class="p">(</span><span class="n">chain_range_dic</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expand a chain dictionary into ranges.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chain_range_dic : dict</span>
<span class="sd">        dictionary of chain indexes (one list per chain)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chain_ranges : dict</span>
<span class="sd">        dictionary of chain ranges (one tuple per chain)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chain_ranges</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chain_range_dic</span><span class="p">:</span>
        <span class="n">min_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">chain_range_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">])</span>
        <span class="n">max_idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">chain_range_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">])</span>
        <span class="n">chain_ranges</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_idx</span><span class="p">,</span> <span class="n">max_idx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chain_ranges</span></div>


<div class="viewcode-block" id="dump_as_izone"><a class="viewcode-back" href="../../../reference/libs/libalign.html#haddock.libs.libalign.dump_as_izone">[docs]</a><span class="k">def</span> <span class="nf">dump_as_izone</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">numbering_dic</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dump the numbering dictionary as .izone.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        output filename</span>

<span class="sd">    numbering_dic : dict</span>
<span class="sd">        dict of numbering dictionaries (one dictionary per chain)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># FIXME: Collapse the izones so its faster to load in profit</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">numbering_dic</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bound_res</span> <span class="ow">in</span> <span class="n">numbering_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">]:</span>
                <span class="n">unbound_res</span> <span class="o">=</span> <span class="n">numbering_dic</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="n">bound_res</span><span class="p">]</span>
                <span class="c1">#</span>
                <span class="n">izone_str</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;ZONE &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">chain</span><span class="si">}{</span><span class="n">bound_res</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">chain</span><span class="si">}{</span><span class="n">unbound_res</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">izone_str</span><span class="p">)</span></div>


<div class="viewcode-block" id="AlignError"><a class="viewcode-back" href="../../../reference/libs/libalign.html#haddock.libs.libalign.AlignError">[docs]</a><span class="k">class</span> <span class="nc">AlignError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised when something goes wrong with the Alignment library.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span></div>
</pre></div>

                        
                    </div>
                </div>
            </div>
        </div>
    </div>    


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'3.0.0',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
    <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  
    <div class="footer" role="contentinfo">
        <div class="container">
            &#169; Copyright 2022, BonvinLab.
        Last updated on Sep 15, 2022.
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.1.1.
        </div>
    </div>  

</body>
</html>