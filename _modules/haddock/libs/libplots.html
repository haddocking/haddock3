

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>haddock.libs.libplots &mdash; haddock3 3.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=34bb78ad" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=acc74ff5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            haddock3
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">A brief introduction to HADDOCK3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../INSTALL.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../USAGE.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Workflow Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Advanced features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../clients/haddock.clis.html">Command-line interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/index.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/index.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing to HADDOCK3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../citing.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Library Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">haddock3</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../haddock.html">haddock</a></li>
      <li class="breadcrumb-item active">haddock.libs.libplots</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for haddock.libs.libplots</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Plotting functionalities.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px_colors</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.io._utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">plotly_cdn_url</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.offline.offline</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_plotlyjs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.subplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_subplots</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">haddock</span><span class="w"> </span><span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">haddock.core.typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">DataFrameGroupBy</span><span class="p">,</span>
    <span class="n">Figure</span><span class="p">,</span>
    <span class="n">FilePath</span><span class="p">,</span>
    <span class="n">ImgFormat</span><span class="p">,</span>
    <span class="n">NDFloat</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">haddock.libs.assets</span><span class="w"> </span><span class="kn">import</span> <span class="n">haddock_ui_path</span>


<span class="n">SCATTER_PAIRS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;irmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;irmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;desolv&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;irmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;vdw&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;irmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;elec&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;irmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;air&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;dockq&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;dockq&quot;</span><span class="p">,</span> <span class="s2">&quot;desolv&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;dockq&quot;</span><span class="p">,</span> <span class="s2">&quot;vdw&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;dockq&quot;</span><span class="p">,</span> <span class="s2">&quot;elec&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;dockq&quot;</span><span class="p">,</span> <span class="s2">&quot;air&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;lrmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;lrmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;desolv&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;lrmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;vdw&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;lrmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;elec&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;lrmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;air&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;ilrmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;ilrmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;desolv&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;ilrmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;vdw&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;ilrmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;elec&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;ilrmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;air&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;fnat&quot;</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;fnat&quot;</span><span class="p">,</span> <span class="s2">&quot;desolv&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;fnat&quot;</span><span class="p">,</span> <span class="s2">&quot;vdw&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;fnat&quot;</span><span class="p">,</span> <span class="s2">&quot;elec&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;fnat&quot;</span><span class="p">,</span> <span class="s2">&quot;air&quot;</span><span class="p">),</span>
    <span class="p">]</span>


<span class="c1"># if SCATTER_PAIRS changes, SCATTER_MATRIX_SIZE should change too!</span>
<span class="n">SCATTER_MATRIX_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># (number of rows, number of columns)</span>

<span class="n">TITLE_NAMES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="s2">&quot;HADDOCK score&quot;</span><span class="p">,</span>
    <span class="s2">&quot;irmsd&quot;</span><span class="p">:</span> <span class="s2">&quot;i-RMSD&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lrmsd&quot;</span><span class="p">:</span> <span class="s2">&quot;l-RMSD&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ilrmsd&quot;</span><span class="p">:</span> <span class="s2">&quot;il-RMSD&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dockq&quot;</span><span class="p">:</span> <span class="s2">&quot;DOCKQ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;desolv&quot;</span><span class="p">:</span> <span class="s2">&quot;Edesolv&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vdw&quot;</span><span class="p">:</span> <span class="s2">&quot;Evdw&quot;</span><span class="p">,</span>
    <span class="s2">&quot;elec&quot;</span><span class="p">:</span> <span class="s2">&quot;Eelec&quot;</span><span class="p">,</span>
    <span class="s2">&quot;air&quot;</span><span class="p">:</span> <span class="s2">&quot;Eair&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fnat&quot;</span><span class="p">:</span> <span class="s2">&quot;FCC&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bsa&quot;</span><span class="p">:</span> <span class="s2">&quot;BSA&quot;</span><span class="p">,</span>
    <span class="p">}</span>

<span class="n">AXIS_NAMES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="s2">&quot;HADDOCK score [a.u.]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;vdw&quot;</span><span class="p">:</span> <span class="s2">&quot;Van der Waals Energy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;elec&quot;</span><span class="p">:</span> <span class="s2">&quot;Electrostatic Energy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;air&quot;</span><span class="p">:</span> <span class="s2">&quot;Restraints Energy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;desolv&quot;</span><span class="p">:</span> <span class="s2">&quot;Desolvation Energy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;irmsd&quot;</span><span class="p">:</span> <span class="s2">&quot;interface RMSD [A]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lrmsd&quot;</span><span class="p">:</span> <span class="s2">&quot;ligand RMSD [A]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ilrmsd&quot;</span><span class="p">:</span> <span class="s2">&quot;interface-ligand RMSD [A]&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fnat&quot;</span><span class="p">:</span> <span class="s2">&quot;Fraction of Common Contacts&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dockq&quot;</span><span class="p">:</span> <span class="s2">&quot;DOCKQ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bsa&quot;</span><span class="p">:</span> <span class="s2">&quot;Buried Surface Area [A^2]&quot;</span><span class="p">,</span>
    <span class="p">}</span>

<span class="n">ClRank</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A dict representing clusters&#39; rank.</span>

<span class="sd">key  (int): cluster&#39;s id</span>

<span class="sd">value(int): cluster&#39;s rank</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">HEATMAP_DEFAULT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;contacts.html&#39;</span><span class="p">)</span>
<span class="n">SUPPORTED_OUTPUT_FORMATS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;webp&#39;</span><span class="p">,</span> <span class="s1">&#39;svg&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;eps&#39;</span><span class="p">,</span> <span class="p">)</span>

<div class="viewcode-block" id="create_html">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.create_html">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_html</span><span class="p">(</span>
        <span class="n">json_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">plot_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">plotly_js_import</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">figure_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
        <span class="n">figure_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create html content given a plotly json.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    json_content : str</span>
<span class="sd">        plotly json content</span>
<span class="sd">    </span>
<span class="sd">    plot_id : int</span>
<span class="sd">        plot id to be used in the html content</span>
<span class="sd">    </span>
<span class="sd">    figure_height : int</span>
<span class="sd">        figure height (in pixels)</span>
<span class="sd">    </span>
<span class="sd">    figure_width : int</span>
<span class="sd">        figure width (in pixels)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    html_content : str</span>
<span class="sd">        html content</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if plotly javascript must be flushed in this file</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">plotly_js_import</span><span class="p">:</span>
        <span class="n">plotly_js_import</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;script src=&quot;</span><span class="si">{</span><span class="n">plotly_cdn_url</span><span class="p">()</span><span class="si">}</span><span class="s1">&quot;&gt;&lt;/script&gt;&#39;</span>

    <span class="c1"># Write HTML content</span>
    <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;div&gt;</span>
<span class="s2">    &lt;script type=&quot;text/javascript&quot;&gt;window.PlotlyConfig = </span><span class="se">{{</span><span class="s2"> MathJaxConfig: &#39;local&#39; </span><span class="se">}}</span><span class="s2">;&lt;/script&gt;</span>
<span class="s2">    </span><span class="si">{</span><span class="n">plotly_js_import</span><span class="si">}</span>
<span class="s2">    &lt;div id=&quot;plot</span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s2">&quot; class=&quot;plotly-graph-div&quot; style=&quot;height:</span><span class="si">{</span><span class="n">figure_height</span><span class="si">}</span><span class="s2">px; width:</span><span class="si">{</span><span class="n">figure_width</span><span class="si">}</span><span class="s2">px;&quot;&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &lt;script id=&quot;data</span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s2">&quot; type=&quot;application/json&quot;&gt;</span>
<span class="s2">    </span><span class="si">{</span><span class="n">json_content</span><span class="si">}</span>
<span class="s2">    &lt;/script&gt;</span>
<span class="s2">    &lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="s2">        const dat</span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s2"> = JSON.parse(document.getElementById(&quot;data</span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s2">&quot;).text)</span>
<span class="s2">        window.PLOTLYENV = window.PLOTLYENV || </span><span class="se">{{}}</span><span class="s2">;</span>
<span class="s2">        if (document.getElementById(&quot;plot</span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s2">&quot;)) </span><span class="se">{{</span>
<span class="s2">            Plotly.newPlot(</span>
<span class="s2">                &quot;plot</span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s2">&quot;,</span>
<span class="s2">                dat</span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s2">.data,</span>
<span class="s2">                dat</span><span class="si">{</span><span class="n">plot_id</span><span class="si">}</span><span class="s2">.layout,</span>
<span class="s2">                </span><span class="se">{{</span><span class="s2"> responsive: true </span><span class="se">}}</span><span class="s2">,</span>
<span class="s2">            );</span>
<span class="s2">        </span><span class="se">}}</span>
<span class="s2">    &lt;/script&gt;</span>
<span class="s2">    &lt;/div&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>  <span class="c1"># noqa : E501</span>
    <span class="k">return</span> <span class="n">html_content</span></div>



<div class="viewcode-block" id="read_capri_table">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.read_capri_table">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_capri_table</span><span class="p">(</span>
        <span class="n">capri_filename</span><span class="p">:</span> <span class="n">FilePath</span><span class="p">,</span>
        <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read capri table with pandas.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    capri_filename : str or Path</span>
<span class="sd">        capri single structure filename</span>
<span class="sd">    comment : str</span>
<span class="sd">        the string used to denote a commented line in capri tables</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    capri_df : pandas DataFrame</span>
<span class="sd">        dataframe of capri values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">capri_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">capri_filename</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">capri_df</span></div>



<div class="viewcode-block" id="in_capri">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.in_capri">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">in_capri</span><span class="p">(</span><span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">df_columns</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the selected column is in the set of available columns.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    column : str</span>
<span class="sd">        column name</span>
<span class="sd">    df_columns : pandas.DataFrame.columns</span>
<span class="sd">        columns of a pandas.DataFrame</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    resp : bool</span>
<span class="sd">        if True, the column is present</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_columns</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;quantity </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2"> not present in capri table&quot;</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">resp</span></div>



<div class="viewcode-block" id="update_layout_plotly">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.update_layout_plotly">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_layout_plotly</span><span class="p">(</span>
        <span class="n">fig</span><span class="p">:</span> <span class="n">Figure</span><span class="p">,</span>
        <span class="n">x_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">y_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update layout of plotly plot.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fig : plotly Figure</span>
<span class="sd">        figure</span>
<span class="sd">    x_label : str</span>
<span class="sd">        x axis name</span>
<span class="sd">    y_label : str</span>
<span class="sd">        y axis name</span>
<span class="sd">    title : str or None</span>
<span class="sd">        plot title</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">px_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
        <span class="s2">&quot;xaxis&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">x_label</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">40</span><span class="p">)),</span>
            <span class="n">tickfont_size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="s2">&quot;yaxis&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">40</span><span class="p">)),</span>
            <span class="n">tickfont_size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="s2">&quot;legend&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">1.01</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">font_family</span><span class="o">=</span><span class="s2">&quot;Helvetica&quot;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
        <span class="s2">&quot;hoverlabel&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">font_family</span><span class="o">=</span><span class="s2">&quot;Helvetica&quot;</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">px_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="box_plot_plotly">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.box_plot_plotly">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">box_plot_plotly</span><span class="p">(</span>
        <span class="n">gb_full</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">y_ax</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">cl_rank</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="nb">format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ImgFormat</span><span class="p">],</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">offline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a scatter plot in plotly.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gb_full : pandas DataFrame</span>
<span class="sd">        data to box plot</span>
<span class="sd">    y_ax : str</span>
<span class="sd">        variable to plot</span>
<span class="sd">    cl_rank : dict</span>
<span class="sd">        {cluster_id : cluster_rank} dictionary</span>
<span class="sd">    format : str</span>
<span class="sd">        Produce images in the selected format.</span>
<span class="sd">    scale : int</span>
<span class="sd">        scale of image</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig_list : list</span>
<span class="sd">        a list of figures</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">px_colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Dark24</span>
    <span class="n">color_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">cl_id</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cl_rank</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">color_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">cl_rank</span><span class="p">[</span><span class="n">cl_id</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>  <span class="c1"># color index</span>

        <span class="c1"># Note: the rank format (float/int) in &quot;cl_rank&quot; is different from</span>
        <span class="c1"># gb_full[&quot;cluster_ranking&quot;]</span>
        <span class="n">rns</span> <span class="o">=</span> <span class="n">gb_full</span><span class="p">[</span><span class="n">gb_full</span><span class="p">[</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cl_id</span><span class="p">][</span><span class="s2">&quot;cluster_ranking&quot;</span><span class="p">]</span>
        <span class="n">rn</span> <span class="o">=</span> <span class="n">rns</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">color_map</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">color_idx</span><span class="p">]</span>

        <span class="c1"># Choose a different color for &quot;Other&quot; like in scatter plots</span>
        <span class="n">color_map</span><span class="p">[</span><span class="s2">&quot;Other&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#DDDBDA&quot;</span>

    <span class="c1"># to use color_discrete_map, cluster_ranking column should be str not int</span>
    <span class="n">gb_full_string</span> <span class="o">=</span> <span class="n">gb_full</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;cluster_ranking&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">})</span>

    <span class="c1"># Rename for a better name in legend</span>
    <span class="n">gb_full_string</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cluster_ranking&quot;</span><span class="p">:</span> <span class="s2">&quot;Cluster Rank&quot;</span><span class="p">},</span>
        <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># &quot;Cluster Rank&quot; is equivalent to &quot;capri_rank&quot;!</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">box</span><span class="p">(</span>
        <span class="n">gb_full_string</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s2">&quot;capri_rank&quot;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">y_ax</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;Cluster Rank&quot;</span><span class="p">,</span>
        <span class="n">color_discrete_map</span><span class="o">=</span><span class="n">color_map</span><span class="p">,</span>
        <span class="n">boxmode</span><span class="o">=</span><span class="s2">&quot;overlay&quot;</span><span class="p">,</span>
        <span class="n">points</span><span class="o">=</span><span class="s2">&quot;outliers&quot;</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
        <span class="n">hover_data</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;caprieval_rank&quot;</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="c1"># layout</span>
    <span class="n">update_layout_plotly</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="s2">&quot;Cluster Rank&quot;</span><span class="p">,</span> <span class="n">AXIS_NAMES</span><span class="p">[</span><span class="n">y_ax</span><span class="p">])</span>
    <span class="c1"># save figure</span>
    <span class="n">px_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">y_ax</span><span class="si">}</span><span class="s2">_clt.html&quot;</span><span class="p">)</span>
    <span class="n">json_content</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
    <span class="n">html_content</span> <span class="o">=</span> <span class="n">create_html</span><span class="p">(</span>
        <span class="n">json_content</span><span class="p">,</span>
        <span class="n">plotly_js_import</span><span class="o">=</span><span class="n">offline_js_manager</span><span class="p">(</span><span class="n">px_fpath</span><span class="p">,</span> <span class="n">offline</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="c1"># write html_content to px_fname</span>
    <span class="n">px_fpath</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">html_content</span><span class="p">)</span>
    <span class="c1"># create format boxplot if necessary</span>
    <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">y_ax</span><span class="si">}</span><span class="s2">_clt.</span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="box_plot_data">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.box_plot_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">box_plot_data</span><span class="p">(</span><span class="n">capri_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">cl_rank</span><span class="p">:</span> <span class="n">ClRank</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve box plot data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    capri_df : pandas DataFrame</span>
<span class="sd">        capri table dataframe</span>
<span class="sd">    cl_rank : dict</span>
<span class="sd">        {cluster_id : cluster_rank} dictionary</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    gb_full : pandas DataFrame</span>
<span class="sd">        DataFrame of all the clusters to be plotted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gb_cluster</span> <span class="o">=</span> <span class="n">capri_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">)</span>
    <span class="n">gb_other</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([])</span>
    <span class="n">gb_good</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">cl_id</span><span class="p">,</span> <span class="n">cl_df</span> <span class="ow">in</span> <span class="n">gb_cluster</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cl_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cl_rank</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">gb_other</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gb_other</span><span class="p">,</span> <span class="n">cl_df</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cl_df</span><span class="p">[</span><span class="s2">&quot;capri_rank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl_rank</span><span class="p">[</span><span class="n">cl_id</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
            <span class="n">gb_good</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gb_good</span><span class="p">,</span> <span class="n">cl_df</span><span class="p">])</span>

    <span class="n">gb_other</span><span class="p">[</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Other&quot;</span>
    <span class="n">gb_other</span><span class="p">[</span><span class="s2">&quot;capri_rank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cl_rank</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">gb_other</span><span class="p">[</span><span class="s2">&quot;cluster_ranking&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Other&quot;</span>
    <span class="n">gb_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gb_good</span><span class="p">,</span> <span class="n">gb_other</span><span class="p">])</span>

    <span class="c1"># Sort based on &quot;capri_rank&quot;</span>
    <span class="n">gb_full</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;capri_rank&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gb_full</span></div>



<div class="viewcode-block" id="box_plot_handler">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.box_plot_handler">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">box_plot_handler</span><span class="p">(</span>
        <span class="n">capri_filename</span><span class="p">:</span> <span class="n">FilePath</span><span class="p">,</span>
        <span class="n">cl_rank</span><span class="p">:</span> <span class="n">ClRank</span><span class="p">,</span>
        <span class="nb">format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ImgFormat</span><span class="p">],</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">offline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Figure</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create box plots.</span>

<span class="sd">    The idea is that for each of the top X-ranked clusters we create a box plot</span>
<span class="sd">    showing how the basic statistics are distributed within each model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    capri_filename : str or Path</span>
<span class="sd">        capri single structure filename</span>
<span class="sd">    cl_rank : dict</span>
<span class="sd">        {cluster_id : cluster_rank} dictionary</span>
<span class="sd">    format : str</span>
<span class="sd">        Produce images in the selected format.</span>
<span class="sd">    scale : int</span>
<span class="sd">        scale for images.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># generating the correct dataframe</span>
    <span class="n">capri_df</span> <span class="o">=</span> <span class="n">read_capri_table</span><span class="p">(</span><span class="n">capri_filename</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
    <span class="n">gb_full</span> <span class="o">=</span> <span class="n">box_plot_data</span><span class="p">(</span><span class="n">capri_df</span><span class="p">,</span> <span class="n">cl_rank</span><span class="p">)</span>
    
    <span class="c1"># iterate over the variables</span>
    <span class="n">fig_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Figure</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">y_ax</span> <span class="ow">in</span> <span class="n">AXIS_NAMES</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_capri</span><span class="p">(</span><span class="n">y_ax</span><span class="p">,</span> <span class="n">capri_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">box_plot_plotly</span><span class="p">(</span>
            <span class="n">gb_full</span><span class="p">,</span> <span class="n">y_ax</span><span class="p">,</span> <span class="n">cl_rank</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">offline</span><span class="o">=</span><span class="n">offline</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">fig_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig_list</span></div>



<div class="viewcode-block" id="scatter_plot_plotly">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.scatter_plot_plotly">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">scatter_plot_plotly</span><span class="p">(</span>
        <span class="n">gb_cluster</span><span class="p">:</span> <span class="n">DataFrameGroupBy</span><span class="p">,</span>
        <span class="n">gb_other</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cl_rank</span><span class="p">:</span> <span class="n">ClRank</span><span class="p">,</span>
        <span class="n">x_ax</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">y_ax</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">colors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="nb">format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ImgFormat</span><span class="p">],</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">offline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a scatter plot in plotly.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gb_cluster : pandas DataFrameGroupBy</span>
<span class="sd">        capri DataFrame grouped by cluster_id</span>
<span class="sd">    gb_other : pandas DataFrame</span>
<span class="sd">        DataFrame of clusters not in the top cluster ranking</span>
<span class="sd">    cl_rank : dict</span>
<span class="sd">        {cluster_id : cluster_rank} dictionary</span>
<span class="sd">    x_ax : str</span>
<span class="sd">        name of the x column</span>
<span class="sd">    y_ax : str</span>
<span class="sd">        name of the y column</span>
<span class="sd">    colors : list</span>
<span class="sd">        list of colors to be used</span>
<span class="sd">    format : str</span>
<span class="sd">        Produce images in the selected format.</span>
<span class="sd">    scale : int</span>
<span class="sd">        scale for images.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig :</span>
<span class="sd">        an instance of plotly.graph_objects.Figure</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_hover_text</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build a nice text for hover text.&quot;&quot;&quot;</span>
        <span class="n">text_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">model_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Model: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">score_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Score: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">caprieval_rank_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Caprieval rank: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;caprieval_rank&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">text_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_text</span><span class="si">}</span><span class="s2">&lt;br&gt;</span><span class="si">{</span><span class="n">score_text</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;&lt;br&gt;</span><span class="si">{</span><span class="n">caprieval_rank_text</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">text_list</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">})</span>
    <span class="n">traces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
    <span class="n">cl_rank_swap</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cl_rank</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">for</span> <span class="n">cl_rn</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cl_rank_swap</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">cl_id</span> <span class="o">=</span> <span class="n">cl_rank_swap</span><span class="p">[</span><span class="n">cl_rn</span><span class="p">]</span>
        <span class="n">cl_df</span> <span class="o">=</span> <span class="n">gb_cluster</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">cl_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cl_id</span> <span class="ow">in</span> <span class="n">cl_rank</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cl_id</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
                <span class="n">cl_name</span> <span class="o">=</span> <span class="s2">&quot;Unclustered&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cl_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">cl_rank</span><span class="p">[</span><span class="n">cl_id</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># use rank</span>
            <span class="n">color_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">cl_rank</span><span class="p">[</span><span class="n">cl_id</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n_colors</span>  <span class="c1"># color index</span>
            
            <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">cl_df</span><span class="p">[</span><span class="n">x_ax</span><span class="p">],</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">cl_df</span><span class="p">[</span><span class="n">y_ax</span><span class="p">],</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">cl_name</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">_build_hover_text</span><span class="p">(</span><span class="n">cl_df</span><span class="p">),</span>
                    <span class="n">legendgroup</span><span class="o">=</span><span class="n">cl_name</span><span class="p">,</span>
                    <span class="n">marker_color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">color_idx</span><span class="p">],</span>
                    <span class="n">hoverlabel</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">bgcolor</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">color_idx</span><span class="p">],</span>
                        <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                        <span class="n">font_family</span><span class="o">=</span><span class="s2">&quot;Helvetica&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">clt_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cl_name</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>
            
            <span class="c1"># mean and std deviations for the top 4 members</span>
            <span class="n">x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cl_df</span><span class="p">[</span><span class="n">x_ax</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">y_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cl_df</span><span class="p">[</span><span class="n">y_ax</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">x_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cl_df</span><span class="p">[</span><span class="n">x_ax</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">y_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cl_df</span><span class="p">[</span><span class="n">y_ax</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>

            <span class="k">if</span> <span class="s2">&quot;score&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x_ax</span><span class="p">,</span> <span class="n">y_ax</span><span class="p">]:</span>
                <span class="n">clt_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Score: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cl_df</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>
            <span class="n">clt_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x_ax</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">x_mean</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&lt;br&gt;</span><span class="si">{</span><span class="n">y_ax</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">y_mean</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">clt_text_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">clt_text</span><span class="p">]</span>
            <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">x_mean</span><span class="p">],</span>
                    <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">y_mean</span><span class="p">],</span>
                    <span class="c1"># error bars</span>
                    <span class="n">error_x</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="p">[</span><span class="n">x_std</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">),</span>
                    <span class="n">error_y</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">array</span><span class="o">=</span><span class="p">[</span><span class="n">y_std</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="kc">True</span>
                        <span class="p">),</span>
                    <span class="c1"># color and text</span>
                    <span class="n">marker_color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">color_idx</span><span class="p">],</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">clt_text_list</span><span class="p">,</span>
                    <span class="n">legendgroup</span><span class="o">=</span><span class="n">cl_name</span><span class="p">,</span>
                    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;square-dot&quot;</span><span class="p">),</span>
                    <span class="n">hovertemplate</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;</span><span class="si">{</span><span class="n">clt_text</span><span class="si">}</span><span class="s2">&lt;/b&gt;&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">,</span>
                    <span class="n">hoverlabel</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">bgcolor</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">color_idx</span><span class="p">],</span>
                        <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                        <span class="n">font_family</span><span class="o">=</span><span class="s2">&quot;Helvetica&quot;</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
    <span class="c1"># append trace other</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">gb_other</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">gb_other</span><span class="p">[</span><span class="n">x_ax</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="n">gb_other</span><span class="p">[</span><span class="n">y_ax</span><span class="p">],</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Other&quot;</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="n">_build_hover_text</span><span class="p">(</span><span class="n">gb_other</span><span class="p">),</span>
                <span class="n">legendgroup</span><span class="o">=</span><span class="s2">&quot;Other&quot;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;DarkSlateGrey&quot;</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="n">hoverlabel</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                    <span class="n">font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                    <span class="n">font_family</span><span class="o">=</span><span class="s2">&quot;Helvetica&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
    <span class="n">px_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x_ax</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">y_ax</span><span class="si">}</span><span class="s2">.html&quot;</span><span class="p">)</span>
    <span class="n">update_layout_plotly</span><span class="p">(</span>
        <span class="n">fig</span><span class="p">,</span>
        <span class="n">TITLE_NAMES</span><span class="p">[</span><span class="n">x_ax</span><span class="p">],</span>
        <span class="n">TITLE_NAMES</span><span class="p">[</span><span class="n">y_ax</span><span class="p">],</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">TITLE_NAMES</span><span class="p">[</span><span class="n">x_ax</span><span class="p">]</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">TITLE_NAMES</span><span class="p">[</span><span class="n">y_ax</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">json_content</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
    <span class="n">html_content</span> <span class="o">=</span> <span class="n">create_html</span><span class="p">(</span>
        <span class="n">json_content</span><span class="p">,</span>
        <span class="n">plotly_js_import</span><span class="o">=</span><span class="n">offline_js_manager</span><span class="p">(</span><span class="n">px_fpath</span><span class="p">,</span> <span class="n">offline</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="c1"># write html_content to px_fname</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">px_fpath</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">html_content</span><span class="p">)</span>

    <span class="c1"># create format boxplot if necessary</span>
    <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x_ax</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">y_ax</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="nb">format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="scatter_plot_data">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.scatter_plot_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">scatter_plot_data</span><span class="p">(</span>
        <span class="n">capri_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cl_rank</span><span class="p">:</span> <span class="n">ClRank</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">DataFrameGroupBy</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve scatter plot data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    capri_df : pandas DataFrame</span>
<span class="sd">        capri table dataframe</span>
<span class="sd">    cl_rank : dict</span>
<span class="sd">        {cluster_id : cluster_rank} dictionary</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    gb_cluster : pandas DataFrameGroupBy</span>
<span class="sd">        capri DataFrame grouped by cluster_id</span>
<span class="sd">    gb_other : pandas DataFrame</span>
<span class="sd">        DataFrame of clusters not in the top cluster ranking</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gb_cluster</span> <span class="o">=</span> <span class="n">capri_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">)</span>
    <span class="n">gb_other</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">cl_id</span><span class="p">,</span> <span class="n">cl_df</span> <span class="ow">in</span> <span class="n">gb_cluster</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cl_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cl_rank</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">gb_other</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gb_other</span><span class="p">,</span> <span class="n">cl_df</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">gb_cluster</span><span class="p">,</span> <span class="n">gb_other</span></div>



<div class="viewcode-block" id="scatter_plot_handler">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.scatter_plot_handler">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">scatter_plot_handler</span><span class="p">(</span>
        <span class="n">capri_filename</span><span class="p">:</span> <span class="n">FilePath</span><span class="p">,</span>
        <span class="n">cl_rank</span><span class="p">:</span> <span class="n">ClRank</span><span class="p">,</span>
        <span class="nb">format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ImgFormat</span><span class="p">],</span>
        <span class="n">scale</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">offline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Figure</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create scatter plots.</span>

<span class="sd">    The idea is that for each pair of variables of interest (SCATTER_PAIRS,</span>
<span class="sd">     declared as global) we create a scatter plot.</span>
<span class="sd">    If available, each scatter plot containts cluster information.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    capri_filename : str or Path</span>
<span class="sd">        capri single structure filename</span>
<span class="sd">    cl_rank : dict</span>
<span class="sd">        {cluster_id : cluster_rank} dictionary</span>
<span class="sd">    format : str</span>
<span class="sd">        Produce images in the selected format.</span>
<span class="sd">    scale : int</span>
<span class="sd">        scale for images.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig_list : list</span>
<span class="sd">        a list of figures</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">capri_df</span> <span class="o">=</span> <span class="n">read_capri_table</span><span class="p">(</span><span class="n">capri_filename</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
    <span class="n">gb_cluster</span><span class="p">,</span> <span class="n">gb_other</span> <span class="o">=</span> <span class="n">scatter_plot_data</span><span class="p">(</span><span class="n">capri_df</span><span class="p">,</span> <span class="n">cl_rank</span><span class="p">)</span>

    <span class="c1"># defining colors</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">px_colors</span><span class="o">.</span><span class="n">qualitative</span><span class="o">.</span><span class="n">Dark24</span>
    <span class="n">fig_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x_ax</span><span class="p">,</span> <span class="n">y_ax</span> <span class="ow">in</span> <span class="n">SCATTER_PAIRS</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_capri</span><span class="p">(</span><span class="n">x_ax</span><span class="p">,</span> <span class="n">capri_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_capri</span><span class="p">(</span><span class="n">y_ax</span><span class="p">,</span> <span class="n">capri_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">scatter_plot_plotly</span><span class="p">(</span>
            <span class="n">gb_cluster</span><span class="p">,</span>
            <span class="n">gb_other</span><span class="p">,</span>
            <span class="n">cl_rank</span><span class="p">,</span>
            <span class="n">x_ax</span><span class="p">,</span>
            <span class="n">y_ax</span><span class="p">,</span>
            <span class="n">colors</span><span class="p">,</span>
            <span class="nb">format</span><span class="p">,</span>
            <span class="n">scale</span><span class="p">,</span>
            <span class="n">offline</span><span class="o">=</span><span class="n">offline</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">fig_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig_list</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_report_grid_size</span><span class="p">(</span><span class="n">plot_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Figure</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the size of the grid in the report.</span>

<span class="sd">    By size, it means the number of rows/columns, and the width/height</span>
<span class="sd">    of an individual plot. In the report, some of the axes are shared. The</span>
<span class="sd">    settings for sharing axes depends on the type (scatters or boxes). The</span>
<span class="sd">    number of columns is set to the number of columns in SCATTER_MATRIX_SIZE. If</span>
<span class="sd">    the number of clusters is more than 5, it increases the width which causes</span>
<span class="sd">    horizontal scrolling in the report.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plot_list : list</span>
<span class="sd">        list of plots generated by analyse command</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    number_of_rows : int</span>
<span class="sd">        number of rows in the grid</span>
<span class="sd">    number_of_cols : int</span>
<span class="sd">        number of columns in the grid</span>
<span class="sd">    width : int</span>
<span class="sd">        the width of an individual plot</span>
<span class="sd">    height: int</span>
<span class="sd">        the height of an individual plot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate grid size for subplots</span>
    <span class="n">number_of_plots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_list</span><span class="p">)</span>
    <span class="n">number_of_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">({</span><span class="n">trace</span><span class="o">.</span><span class="n">legendgroup</span> <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">plot_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">})</span>
    <span class="c1"># same number of cols for both boxes and scatters</span>
    <span class="n">number_of_cols</span> <span class="o">=</span> <span class="n">SCATTER_MATRIX_SIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">number_of_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">number_of_plots</span> <span class="o">/</span> <span class="n">number_of_cols</span><span class="p">))</span>
    <span class="c1"># enable horizontal scroll</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mi">600</span> <span class="k">if</span> <span class="n">number_of_clusters</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="mi">350</span>
    <span class="n">height</span> <span class="o">=</span> <span class="mi">600</span> <span class="k">if</span> <span class="n">number_of_clusters</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="k">else</span> <span class="mi">350</span>
    <span class="k">return</span> <span class="n">number_of_rows</span><span class="p">,</span> <span class="n">number_of_cols</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span>


<div class="viewcode-block" id="report_plots_handler">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.report_plots_handler">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">report_plots_handler</span><span class="p">(</span><span class="n">plots</span><span class="p">,</span> <span class="n">shared_xaxes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shared_yaxes</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a figure that holds subplots.</span>

<span class="sd">    The idea is that for each type (scatters or boxes), the individual plots are</span>
<span class="sd">    considered subplots. In the report, some of the axes are shared. The</span>
<span class="sd">    settings for sharing axes depends on the type (scatters or boxes).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plots : list</span>
<span class="sd">        list of plots generated by `analyse` command</span>
<span class="sd">    shared_xaxes: boolean or str (default False)</span>
<span class="sd">        a parameter of plotly.subplots.make_subplots</span>
<span class="sd">    shared_yaxes: boolean or str (default False)</span>
<span class="sd">        a parameter of plotly.subplots.make_subplots</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig :</span>
<span class="sd">        an instance of plotly.graph_objects.Figure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">number_of_rows</span><span class="p">,</span> <span class="n">number_of_cols</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">_report_grid_size</span><span class="p">(</span><span class="n">plots</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
        <span class="n">rows</span><span class="o">=</span><span class="n">number_of_rows</span><span class="p">,</span>
        <span class="n">cols</span><span class="o">=</span><span class="n">number_of_cols</span><span class="p">,</span>
        <span class="n">shared_xaxes</span><span class="o">=</span><span class="n">shared_xaxes</span><span class="p">,</span>
        <span class="n">shared_yaxes</span><span class="o">=</span><span class="n">shared_yaxes</span><span class="p">,</span>
        <span class="n">vertical_spacing</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4</span> <span class="o">/</span> <span class="n">number_of_rows</span><span class="p">),</span>
        <span class="n">horizontal_spacing</span><span class="o">=</span><span class="p">(</span><span class="mf">0.3</span> <span class="o">/</span> <span class="n">number_of_cols</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sub_fig</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plots</span><span class="p">):</span>
        <span class="n">col_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">i</span> <span class="o">%</span> <span class="n">number_of_cols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">row_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">number_of_cols</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># hide legend of plots except one</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sub_fig</span><span class="o">.</span><span class="n">for_each_trace</span><span class="p">(</span><span class="k">lambda</span> <span class="n">trace</span><span class="p">:</span> <span class="n">trace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_traces</span><span class="p">(</span><span class="n">sub_fig</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="n">row_index</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">col_index</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span>
            <span class="n">title_text</span><span class="o">=</span><span class="n">sub_fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
            <span class="n">row</span><span class="o">=</span><span class="n">row_index</span><span class="p">,</span>
            <span class="n">col</span><span class="o">=</span><span class="n">col_index</span><span class="p">,</span>
            <span class="n">title_standoff</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># x title only on the last row</span>
        <span class="k">if</span> <span class="n">shared_xaxes</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">row_index</span> <span class="o">=</span> <span class="n">number_of_rows</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span>
            <span class="n">title_text</span><span class="o">=</span><span class="n">sub_fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
            <span class="n">row</span><span class="o">=</span><span class="n">row_index</span><span class="p">,</span>
            <span class="n">col</span><span class="o">=</span><span class="n">col_index</span><span class="p">,</span>
            <span class="n">title_standoff</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">automargin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">legend_title_text</span> <span class="o">=</span> <span class="n">sub_fig</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">legend_title_text</span><span class="o">=</span><span class="n">legend_title_text</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="n">height</span> <span class="o">*</span> <span class="n">number_of_rows</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="n">width</span> <span class="o">*</span> <span class="n">number_of_cols</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="find_best_struct">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.find_best_struct">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">find_best_struct</span><span class="p">(</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">max_best_structs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find best structures for each cluster.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df: pd.DataFrame</span>
<span class="sd">        The loaded capri_ss.tsv dataframe</span>
<span class="sd">    max_best_structs: int</span>
<span class="sd">        The maximum number of best structures to return.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    best_df: pd.DataFrame</span>
<span class="sd">        DataFrame of best structures with</span>
<span class="sd">        `cluster_id` and `best&lt;model-cluster_ranking&gt;` columns</span>
<span class="sd">        and empty strings for missing values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">,</span> <span class="s2">&quot;model-cluster_ranking&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">]]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;model-cluster_ranking&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_best_structs</span><span class="p">]</span>

    <span class="n">best_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
        <span class="n">index</span><span class="o">=</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;model-cluster_ranking&quot;</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">best_df</span> <span class="o">=</span> <span class="n">best_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">best_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;best</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s2">&quot;cluster_id&quot;</span> <span class="k">else</span> <span class="n">col</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">best_df</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">]</span>
    <span class="c1"># Remove empty columns</span>
    <span class="n">best_df</span> <span class="o">=</span> <span class="n">best_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">(</span><span class="n">best_df</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">best_df</span></div>



<div class="viewcode-block" id="clean_capri_table">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.clean_capri_table">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clean_capri_table</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a tidy capri table for the report.</span>

<span class="sd">    It also combines mean and std values in one column.</span>
<span class="sd">    Also it drops the columns that are not needed in the report.</span>

<span class="sd">    Makes inplace changes to the dataframe.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas DataFrame</span>
<span class="sd">        dataframe of capri values</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas DataFrame</span>
<span class="sd">        DataFrame of capri table with new column names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">AXIS_NAMES</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_capri</span><span class="p">(</span><span class="n">col_name</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">mean_value</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
        <span class="n">std_value</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">_std&quot;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">mean_value</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">:</span> <span class="n">std_value</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">mean_value</span><span class="p">,</span> <span class="n">std_value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mean_value</span><span class="p">,</span> <span class="n">std_value</span><span class="p">)</span>
            <span class="p">]</span>

    <span class="c1"># Drop columns ending with &#39;_std&#39;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s1">&#39;_std$&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="create_other_cluster">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.create_other_cluster">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_other_cluster</span><span class="p">(</span>
        <span class="n">clusters_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">structs_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">max_clusters</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine all clusters with rank &gt;= max_clusters into an &quot;Other&quot; cluster.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    clusters_df : pandas DataFrame</span>
<span class="sd">        DataFrame of clusters</span>
<span class="sd">    structs_df : pandas DataFrame</span>
<span class="sd">        DataFrame of structures</span>
<span class="sd">    max_clusters : int</span>
<span class="sd">        From which cluster rank to consider as &quot;Other&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        tuple with clusters_df and structs_df</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clusters_df</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_clusters</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">clusters_df</span><span class="p">,</span> <span class="n">structs_df</span>
    <span class="c1"># other clusters</span>
    <span class="n">other_structs_df</span> <span class="o">=</span> <span class="n">structs_df</span><span class="p">[</span><span class="n">structs_df</span><span class="p">[</span><span class="s1">&#39;cluster_ranking&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">max_clusters</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># drop other clusters from structs_df</span>
    <span class="n">structs_df</span> <span class="o">=</span> <span class="n">structs_df</span><span class="p">[</span><span class="n">structs_df</span><span class="p">[</span><span class="s1">&#39;cluster_ranking&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_clusters</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">other_structs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Other&#39;</span>
    <span class="n">other_structs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;cluster_ranking&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_clusters</span>
    <span class="n">inner_rank</span> <span class="o">=</span> <span class="n">other_structs_df</span><span class="p">[</span><span class="s1">&#39;caprieval_rank&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  <span class="c1"># noqa : E501</span>
    <span class="n">other_structs_df</span><span class="p">[</span><span class="s1">&#39;model-cluster_ranking&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inner_rank</span>
    <span class="n">structs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">structs_df</span><span class="p">,</span> <span class="n">other_structs_df</span><span class="p">])</span>

    <span class="n">clusters_df</span> <span class="o">=</span> <span class="n">clusters_df</span><span class="p">[</span><span class="n">clusters_df</span><span class="p">[</span><span class="s1">&#39;cluster_rank&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_clusters</span><span class="p">]</span>
    <span class="n">other_cluster</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;cluster_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Other&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cluster_rank&#39;</span><span class="p">:</span> <span class="n">max_clusters</span><span class="p">,</span>
        <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_structs_df</span><span class="p">),</span>
        <span class="s1">&#39;caprieval_rank&#39;</span><span class="p">:</span> <span class="n">max_clusters</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">AXIS_NAMES</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span>
                <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other_structs_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clusters_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                <span class="p">]):</span>
            <span class="k">continue</span>
        <span class="n">other_cluster</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">other_structs_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">other_cluster</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;_std&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">other_structs_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">other_cluster_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">other_cluster</span><span class="p">])</span>
    <span class="n">clusters_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">clusters_df</span><span class="p">,</span> <span class="n">other_cluster_df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clusters_df</span><span class="p">,</span> <span class="n">structs_df</span></div>



<div class="viewcode-block" id="clt_table_handler">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.clt_table_handler">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">clt_table_handler</span><span class="p">(</span>
        <span class="n">clt_file</span><span class="p">:</span> <span class="n">FilePath</span><span class="p">,</span>
        <span class="n">ss_file</span><span class="p">:</span> <span class="n">FilePath</span><span class="p">,</span>
        <span class="n">is_cleaned</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">topX_clusters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">clustered_topX</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">unclustered_topX</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">top_ranked_mapping</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a dataframe including data for tables.</span>

<span class="sd">    The idea is to create tidy tables that report statistics available in</span>
<span class="sd">    capri_clt.tsv and capri_ss.tsv files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    clt_file : str or Path</span>
<span class="sd">        path to capri_clt.tsv file</span>
<span class="sd">    ss_file: str or Path</span>
<span class="sd">        path to capri_ss.tsv file</span>
<span class="sd">    is_cleaned: bool</span>
<span class="sd">        is the run going to be cleaned?</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df_merged : pandas DataFrame</span>
<span class="sd">        a data frame including data for tables</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># table of statistics</span>
    <span class="n">clusters_df</span> <span class="o">=</span> <span class="n">read_capri_table</span><span class="p">(</span><span class="n">clt_file</span><span class="p">)</span>
    <span class="n">structs_df</span> <span class="o">=</span> <span class="n">read_capri_table</span><span class="p">(</span><span class="n">ss_file</span><span class="p">)</span>

    <span class="c1"># Round all numbers to 2 decimal places</span>
    <span class="n">clusters_df</span> <span class="o">=</span> <span class="n">clusters_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">structs_df</span> <span class="o">=</span> <span class="n">structs_df</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># if the run will be cleaned, the structures are going to be gzipped</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">top_ranked_mapping</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_cleaned</span><span class="p">:</span>
            <span class="c1"># substitute the values in the df by adding .gz at the end</span>
            <span class="n">structs_df</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structs_df</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="n">to_replace</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;(\.pdb)$&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;.pdb.gz&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># ss_file is in NN_caprieval/ while report is in</span>
        <span class="c1"># analysis/NN_caprieval_analysis/</span>
        <span class="c1"># need to correct model paths by prepending ../</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">correct_relative_paths</span><span class="p">(</span>
                <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">top_ranked_mapping</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">Path</span><span class="p">]],</span>
                <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Prepend model paths in capri_ss files get their relative paths.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            path : str</span>
<span class="sd">                Original path to a model file.</span>
<span class="sd">            top_ranked_mapping : Optional[dict[Path, Path]]</span>
<span class="sd">                Optional filepath mapping of top ranked models.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            new_path : str</span>
<span class="sd">                New path to the file</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If top ranked is provided, use that information</span>
                <span class="n">new_path</span> <span class="o">=</span> <span class="n">top_ranked_mapping</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="p">):</span>
                <span class="c1"># Otherwise just prepend by `../`</span>
                <span class="n">new_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;../</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="n">new_path</span>
        
        <span class="n">structs_df</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structs_df</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">correct_relative_paths</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">top_ranked_mapping</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">is_unclustered</span> <span class="o">=</span> <span class="n">clusters_df</span><span class="p">[</span><span class="s2">&quot;cluster_rank&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;-&quot;</span><span class="p">]</span>
    <span class="c1"># If unclustered, we only want to show the top 10 structures in a table.</span>
    <span class="k">if</span> <span class="n">is_unclustered</span><span class="p">:</span>
        <span class="n">structs_df</span> <span class="o">=</span> <span class="n">structs_df</span><span class="p">[:</span><span class="n">unclustered_topX</span><span class="p">]</span>
        <span class="n">cols2keep</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;caprieval_rank&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">AXIS_NAMES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">structs_df</span> <span class="o">=</span> <span class="n">structs_df</span><span class="p">[</span><span class="n">cols2keep</span><span class="p">]</span>
        <span class="c1"># model has ../../01_rigidbody/rigidbody_62.pdb.gz</span>
        <span class="c1"># add id column with 62 as value</span>
        <span class="n">structs_df</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">structs_df</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+).pdb&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">structs_df</span>

    <span class="n">clusters_df</span><span class="p">,</span> <span class="n">structs_df</span> <span class="o">=</span> <span class="n">create_other_cluster</span><span class="p">(</span>
        <span class="n">clusters_df</span><span class="p">,</span>
        <span class="n">structs_df</span><span class="p">,</span>
        <span class="n">max_clusters</span><span class="o">=</span><span class="n">topX_clusters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">clusters_df</span> <span class="o">=</span> <span class="n">clean_capri_table</span><span class="p">(</span><span class="n">clusters_df</span><span class="p">)</span>
    <span class="n">structs_df</span> <span class="o">=</span> <span class="n">find_best_struct</span><span class="p">(</span><span class="n">structs_df</span><span class="p">,</span> <span class="n">max_best_structs</span><span class="o">=</span><span class="n">clustered_topX</span><span class="p">)</span>
    <span class="n">df_merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">clusters_df</span><span class="p">,</span> <span class="n">structs_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_merged</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_css_styles_for_report</span><span class="p">(</span><span class="n">offline</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate custom CSS styles for an analysis report.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    offline : bool</span>
<span class="sd">        If True, the HTML will be generated for offline use.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The CSS styles as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">custom_css</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    .title {</span>
<span class="s2">        font-family: Arial, sans-serif;</span>
<span class="s2">        font-size: 32px;</span>
<span class="s2">        font-weight: bold;</span>
<span class="s2">    }</span>
<span class="s2">    body {</span>
<span class="s2">      margin-left: 1em;</span>
<span class="s2">    }</span>
<span class="s2">    table {</span>
<span class="s2">        border-collapse: collapse;</span>
<span class="s2">    }</span>
<span class="s2">    th {</span>
<span class="s2">        background-color: #f2f2f2;</span>
<span class="s2">        padding: 8px;</span>
<span class="s2">        border: 1px solid #ddd;</span>
<span class="s2">        text-align: left;</span>
<span class="s2">    }</span>
<span class="s2">    th[scope=&quot;row&quot;] {</span>
<span class="s2">        position: sticky;</span>
<span class="s2">        min-width: 16rem;</span>
<span class="s2">        left: 0;</span>
<span class="s2">        z-index: 1</span>
<span class="s2">    }</span>
<span class="s2">    td {</span>
<span class="s2">        border: 1px solid #ddd;</span>
<span class="s2">        padding: 8px;</span>
<span class="s2">        text-align: left;</span>
<span class="s2">    }</span>
<span class="s2">    tr:nth-child(even) {</span>
<span class="s2">        background-color: #f2f2f2</span>
<span class="s2">    }</span>
<span class="s2">    .js-plotly-plot .plotly .modebar svg {</span>
<span class="s2">	    display: inline;</span>
<span class="s2">    }</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">css_link</span> <span class="o">=</span> <span class="s2">&quot;https://cdn.jsdelivr.net/npm/@i-vresse/haddock3-ui@~0.3.0/dist/index.css&quot;</span>
    <span class="k">if</span> <span class="n">offline</span><span class="p">:</span>
        <span class="c1"># copy the css file to the report directory</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">haddock_ui_path</span> <span class="o">/</span> <span class="s1">&#39;index.css&#39;</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s2">&quot;../data/ui/index.css&quot;</span><span class="p">)</span>
        <span class="n">css_link</span> <span class="o">=</span> <span class="s2">&quot;../../data/ui/index.css&quot;</span>
    <span class="n">table_css</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; &lt;link href=&quot;</span><span class="si">{</span><span class="n">css_link</span><span class="si">}</span><span class="s1">&quot; rel=&quot;stylesheet&quot; /&gt;&#39;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_css</span><span class="si">}</span><span class="s2">&lt;style&gt;</span><span class="si">{</span><span class="n">custom_css</span><span class="si">}</span><span class="s2">&lt;/style&gt;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_generate_html_report</span><span class="p">(</span>
        <span class="n">step</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">figures</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Figure</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]],</span>
        <span class="n">report_path</span><span class="p">:</span> <span class="n">FilePath</span><span class="p">,</span>
        <span class="n">offline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate an HTML report for a specific step of analysis, including figures.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    step : str</span>
<span class="sd">        The step number.</span>
<span class="sd">    figures : list</span>
<span class="sd">        A list of figures to include in the HTML body.</span>
<span class="sd">        Each figure can be either a string representing a table or a</span>
<span class="sd">        plotly.graph_objects.Figure object.</span>
<span class="sd">    offline : bool</span>
<span class="sd">        If True, the HTML will be generated for offline use.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    html_report : str</span>
<span class="sd">        The generated HTML report as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">html_report</span> <span class="o">=</span> <span class="s2">&quot;&lt;!DOCTYPE html&gt;&lt;html lang=&#39;en&#39;&gt;&quot;</span>
    <span class="n">html_report</span> <span class="o">+=</span> <span class="n">_generate_html_head</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">offline</span><span class="p">)</span>
    <span class="n">html_report</span> <span class="o">+=</span> <span class="n">_generate_html_body</span><span class="p">(</span><span class="n">figures</span><span class="p">,</span> <span class="n">report_path</span><span class="p">,</span> <span class="n">offline</span><span class="o">=</span><span class="n">offline</span><span class="p">)</span>
    <span class="n">html_report</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/html&gt;&quot;</span>
    <span class="k">return</span> <span class="n">html_report</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_generate_html_head</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">offline</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the HTML head section for an analysis report.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    step : str</span>
<span class="sd">        The step number.</span>
<span class="sd">    offline : bool</span>
<span class="sd">        If True, the HTML will be generated for offline use.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    head : str</span>
<span class="sd">        The HTML head section as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">head</span> <span class="o">=</span> <span class="s2">&quot;&lt;head&gt;&quot;</span>
    <span class="n">head</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;title&gt;Analysis report of step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">&lt;/title&gt;&quot;</span>
    <span class="n">head</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;p class=&#39;title&#39;&gt;Analysis report of step </span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">&lt;/p&gt;&quot;</span>
    <span class="n">head</span> <span class="o">+=</span> <span class="n">_css_styles_for_report</span><span class="p">(</span><span class="n">offline</span><span class="p">)</span>
    <span class="n">head</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/head&gt;&quot;</span>
    <span class="k">return</span> <span class="n">head</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_generate_unclustered_table_html</span><span class="p">(</span>
        <span class="n">table_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">bundle_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s2">&quot;caprieval_rank&quot;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s2">&quot;Structure Rank&quot;</span><span class="p">,</span> <span class="s1">&#39;sorted&#39;</span><span class="p">:</span> <span class="s2">&quot;asc&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s2">&quot;Structure&quot;</span><span class="p">,</span>
         <span class="s1">&#39;sortable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s2">&quot;structure&quot;</span>
         <span class="p">},</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;stats&#39;</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">AXIS_NAMES</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
            <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s2">&quot;Structure ID&quot;</span><span class="p">},</span>
        <span class="p">]</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;div id=&quot;</span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2">&quot;&gt;&lt;/div&gt;</span>
<span class="s2">            &lt;script id=&quot;data</span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2">&quot; type=&quot;application/json&quot;&gt;</span>
<span class="s2">            </span><span class="se">{{</span>
<span class="s2">                &quot;structures&quot;: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                &quot;headers&quot;: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span><span class="si">}</span>
<span class="s2">            </span><span class="se">}}</span>
<span class="s2">            &lt;/script&gt;</span>
<span class="s2">            &lt;script type=&quot;module&quot;&gt;</span>
<span class="s2">            import </span><span class="se">{{</span><span class="s2"> renderStructureTable </span><span class="se">}}</span><span class="s2"> from &quot;</span><span class="si">{</span><span class="n">bundle_url</span><span class="si">}</span><span class="s2">&quot;;</span>

<span class="s2">            const props = JSON.parse(document.getElementById(&quot;data</span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2">&quot;).text)</span>

<span class="s2">            renderStructureTable(document.getElementById(&#39;</span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2">&#39;), props.headers, props.structures)</span>
<span class="s2">            &lt;/script&gt;&quot;&quot;&quot;</span>  <span class="c1"># noqa : E501</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_generate_clustered_table_html</span><span class="p">(</span>
        <span class="n">table_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">bundle_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
    <span class="n">nr_best_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s2">&quot;cluster_rank&quot;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s2">&quot;Cluster Rank&quot;</span><span class="p">,</span> <span class="s1">&#39;sorted&#39;</span><span class="p">:</span> <span class="s2">&quot;asc&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s2">&quot;cluster_id&quot;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s2">&quot;Cluster ID&quot;</span><span class="p">},</span>
        <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s2">&quot;Cluster size&quot;</span><span class="p">},</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;stats&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">AXIS_NAMES</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
        <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;best</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Nr </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> best structure&quot;</span><span class="p">,</span>
         <span class="s1">&#39;sortable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s2">&quot;structure&quot;</span>
         <span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nr_best_columns</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="n">caption</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cluster_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;Other&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">caption</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;The &quot;Other&quot; cluster is not a real cluster it contains&#39;</span>
            <span class="s1">&#39;all structures that are not in the top 10 clusters.&#39;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;div id=&quot;</span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2">&quot;&gt;&lt;/div&gt;</span>
<span class="s2">            &lt;div&gt;</span><span class="si">{</span><span class="n">caption</span><span class="si">}</span><span class="s2">&lt;/div&gt;</span>
<span class="s2">            &lt;script id=&quot;data</span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2">&quot; type=&quot;application/json&quot;&gt;</span>
<span class="s2">            </span><span class="se">{{</span>
<span class="s2">                &quot;clusters&quot;: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">                &quot;headers&quot;: </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span><span class="si">}</span>
<span class="s2">            </span><span class="se">}}</span>
<span class="s2">            &lt;/script&gt;</span>
<span class="s2">            &lt;script type=&quot;module&quot;&gt;</span>
<span class="s2">            import </span><span class="se">{{</span><span class="s2"> renderClusterTable </span><span class="se">}}</span><span class="s2"> from &quot;</span><span class="si">{</span><span class="n">bundle_url</span><span class="si">}</span><span class="s2">&quot;;</span>
<span class="s2">            const props = JSON.parse(document.getElementById(&quot;data</span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2">&quot;).text)</span>

<span class="s2">            renderClusterTable(document.getElementById(&#39;</span><span class="si">{</span><span class="n">table_id</span><span class="si">}</span><span class="s2">&#39;), props.headers, props.clusters);</span>
<span class="s2">            &lt;/script&gt;&quot;&quot;&quot;</span>  <span class="c1"># noqa : E501</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_generate_html_body</span><span class="p">(</span>
        <span class="n">figures</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Figure</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]],</span>
        <span class="n">report_path</span><span class="p">:</span> <span class="n">FilePath</span><span class="p">,</span>
        <span class="n">offline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate an HTML body section containing figures for an analysis report.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    figures : list</span>
<span class="sd">        A list of figures to include in the HTML body.</span>
<span class="sd">        Each figure can be either a string representing a table or a</span>
<span class="sd">        plotly.graph_objects.Figure object.</span>
<span class="sd">    offline : bool</span>
<span class="sd">        If True, the HTML will be generated for offline use.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    body : str</span>
<span class="sd">        The generated HTML body as a string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;&lt;body&gt;&quot;</span>
    <span class="n">table_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">fig_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">figure</span> <span class="ow">in</span> <span class="n">figures</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figure</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>  <span class="c1"># tables</span>
            <span class="n">table_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">table_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;table</span><span class="si">{</span><span class="n">table_index</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">is_unclustered</span> <span class="o">=</span> <span class="s1">&#39;cluster_rank&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">figure</span>
            <span class="n">bundle_url</span> <span class="o">=</span> <span class="s2">&quot;https://cdn.jsdelivr.net/npm/@i-vresse/haddock3-ui@~0.3.0/dist/report.bundle.js&quot;</span>
            <span class="k">if</span> <span class="n">offline</span><span class="p">:</span>
                <span class="c1"># copy the bundle to the run_dir folder</span>
                <span class="n">src</span> <span class="o">=</span> <span class="n">haddock_ui_path</span> <span class="o">/</span> <span class="s1">&#39;report.bundle.js&#39;</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="s2">&quot;../data/ui/report.bundle.js&quot;</span><span class="p">)</span>
                <span class="n">bundle_url</span> <span class="o">=</span> <span class="s2">&quot;../../data/ui/report.bundle.js&quot;</span>
            <span class="k">if</span> <span class="n">is_unclustered</span><span class="p">:</span>
                <span class="n">inner_html</span> <span class="o">=</span> <span class="n">_generate_unclustered_table_html</span><span class="p">(</span><span class="n">table_id</span><span class="p">,</span> <span class="n">figure</span><span class="p">,</span> <span class="n">bundle_url</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inner_html</span> <span class="o">=</span> <span class="n">_generate_clustered_table_html</span><span class="p">(</span><span class="n">table_id</span><span class="p">,</span> <span class="n">figure</span><span class="p">,</span> <span class="n">bundle_url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># plots</span>
            <span class="n">inner_json</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="n">inner_html</span> <span class="o">=</span> <span class="n">create_html</span><span class="p">(</span>
                <span class="n">inner_json</span><span class="p">,</span>
                <span class="n">fig_index</span><span class="p">,</span>
                <span class="n">plotly_js_import</span><span class="o">=</span><span class="n">offline_js_manager</span><span class="p">(</span><span class="n">report_path</span><span class="p">,</span> <span class="n">offline</span><span class="p">),</span>
                <span class="n">figure_height</span><span class="o">=</span><span class="n">figure</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
                <span class="n">figure_width</span><span class="o">=</span><span class="n">figure</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">fig_index</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># type: ignore</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="s2">&quot;&lt;br&gt;&quot;</span>  <span class="c1"># add a break between tables and plots</span>
        <span class="n">body</span> <span class="o">+=</span> <span class="n">inner_html</span>
    <span class="n">body</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/body&gt;&quot;</span>
    <span class="k">return</span> <span class="n">body</span>


<div class="viewcode-block" id="report_generator">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.report_generator">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">report_generator</span><span class="p">(</span>
        <span class="n">boxes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Figure</span><span class="p">],</span>
        <span class="n">scatters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Figure</span><span class="p">],</span>
        <span class="n">tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">step</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">directory</span><span class="p">:</span> <span class="n">FilePath</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
        <span class="n">offline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a figure include plots and tables.</span>

<span class="sd">    The idea is to create a report.html file that includes all the plots and</span>
<span class="sd">    tables generated by the command `analyse`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    boxes : list</span>
<span class="sd">        list of box plots generated by box_plot_handler</span>
<span class="sd">    scatters: list</span>
<span class="sd">        list of scatter plots generated by scatter_plot_handler</span>
<span class="sd">    table: list</span>
<span class="sd">        a list including tables generated by clt_table_handler</span>
<span class="sd">    directory : Path</span>
<span class="sd">        path to the output folder</span>
<span class="sd">    offline: bool</span>
<span class="sd">        If True, the HTML will be generated for offline use.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">figures</span> <span class="o">=</span> <span class="p">[</span><span class="n">tables</span><span class="p">]</span>
    <span class="c1"># Combine scatters</span>
    <span class="n">figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">report_plots_handler</span><span class="p">(</span>
            <span class="n">scatters</span><span class="p">,</span>
            <span class="n">shared_xaxes</span><span class="o">=</span><span class="s2">&quot;rows&quot;</span><span class="p">,</span>
            <span class="n">shared_yaxes</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="c1"># Combine boxes&quot;</span>
    <span class="n">figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report_plots_handler</span><span class="p">(</span><span class="n">boxes</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">offline</span><span class="p">:</span>
        <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../data/ui&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Write everything to a html file</span>
    <span class="n">report_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;report.html&quot;</span><span class="p">)</span>
    <span class="n">html_report</span> <span class="o">=</span> <span class="n">_generate_html_report</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">figures</span><span class="p">,</span> <span class="n">report_path</span><span class="p">,</span> <span class="n">offline</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">report</span><span class="p">:</span>
        <span class="n">report</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html_report</span><span class="p">)</span></div>



<div class="viewcode-block" id="heatmap_plotly">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.heatmap_plotly">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">heatmap_plotly</span><span class="p">(</span>
        <span class="n">matrix</span><span class="p">:</span> <span class="n">NDFloat</span><span class="p">,</span>
        <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">xlabels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ylabels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">color_scale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_fname</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">HEATMAP_DEFAULT_PATH</span><span class="p">,</span>
        <span class="n">offline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">hovertemplate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">customdata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">delineation_traces</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate a `plotly heatmap` based on matrix content.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    matrix : NDFloat</span>
<span class="sd">        The 2D matrix containing data to be shown.</span>
<span class="sd">    labels : dict</span>
<span class="sd">        Labels of the horizontal (x), vertical (y) and colorscale (color) axis.</span>
<span class="sd">    xlabels : list</span>
<span class="sd">        List of columns names.</span>
<span class="sd">    ylabels : list</span>
<span class="sd">        List of row names.</span>
<span class="sd">    color_scale : str</span>
<span class="sd">        Color scale to use.</span>
<span class="sd">    title : str</span>
<span class="sd">        Title of the figure.</span>
<span class="sd">    output_fname : Path</span>
<span class="sd">        Path to the output filename to generate.</span>
<span class="sd">    hovertemplate: Optional[str]</span>
<span class="sd">        Custrom string used to format data for hover annotation in plotly.</span>
<span class="sd">    customdata: Optional[list[list[list[int]]]]</span>
<span class="sd">        A matrix of cluster ids, used for extra hover annotation in plotly.</span>
<span class="sd">    delineation_traces: Optional[list[dict[str, float]]]</span>
<span class="sd">        A list of dict enabling to draw lines separating cluster ids.</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    output_fname : Path</span>
<span class="sd">        Path to the generated filename</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate heatmap trace</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">matrix</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="n">xlabels</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="n">ylabels</span><span class="p">,</span>
        <span class="n">color_continuous_scale</span><span class="o">=</span><span class="n">color_scale</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># Place X axis on top</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span>
        <span class="n">hovertemplate</span><span class="o">=</span><span class="n">hovertemplate</span><span class="p">,</span>
        <span class="n">customdata</span><span class="o">=</span><span class="n">customdata</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># Add delineation traces</span>
    <span class="k">if</span> <span class="n">delineation_traces</span><span class="p">:</span>
        <span class="c1"># Loop over lines</span>
        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">delineation_traces</span><span class="p">:</span>
            <span class="c1"># Draw them</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_shape</span><span class="p">(</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;line&quot;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;dash&quot;</span><span class="p">:</span> <span class="s2">&quot;5px&quot;</span><span class="p">},</span>
                <span class="n">x0</span><span class="o">=</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">],</span>
                <span class="n">x1</span><span class="o">=</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">],</span>
                <span class="n">y0</span><span class="o">=</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;y0&quot;</span><span class="p">],</span>
                <span class="n">y1</span><span class="o">=</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">],</span>
            <span class="p">)</span>

    <span class="c1"># Compute pixels</span>
    <span class="n">nb_entries</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">scaled_log</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nb_entries</span><span class="p">))</span> <span class="o">*</span> <span class="mi">200</span>
    <span class="n">lower_bound</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">scaled_log</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">uppder_bound</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lower_bound</span><span class="p">,</span> <span class="mi">2000</span><span class="p">)</span>
    <span class="c1"># Set hight and width</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">uppder_bound</span>
    <span class="c1"># Increment width for legend space</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">height</span> <span class="o">+</span> <span class="mi">70</span>

    <span class="c1"># Save figure as html file</span>
    <span class="n">export_plotly_figure</span><span class="p">(</span>
        <span class="n">fig</span><span class="p">,</span>
        <span class="n">output_fname</span><span class="p">,</span>
        <span class="n">offline</span><span class="o">=</span><span class="n">offline</span><span class="p">,</span>
        <span class="n">figure_height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
        <span class="n">figure_width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">output_fname</span></div>



<div class="viewcode-block" id="export_plotly_figure">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.export_plotly_figure">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">export_plotly_figure</span><span class="p">(</span>
        <span class="n">fig</span><span class="p">:</span> <span class="n">Figure</span><span class="p">,</span>
        <span class="n">output_fname</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
        <span class="n">figure_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">figure_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">offline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a plotly figure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fig : Figure</span>
<span class="sd">        The plotly Figure object</span>
<span class="sd">    output_fname : Union[str, Path]</span>
<span class="sd">        Where to write it</span>
<span class="sd">    figure_height : int, optional</span>
<span class="sd">        Height of the figure (in pixels), by default 1000</span>
<span class="sd">    figure_width : int, optional</span>
<span class="sd">        Width of the figure (in pixels), by default 1000</span>
<span class="sd">    offline : bool, optional</span>
<span class="sd">        If True add the plotly js library to the file, by default False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Detect output file extension</span>
    <span class="n">_suffix</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_fname</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">_suffix</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="c1"># Check corresponding function</span>
    <span class="k">if</span> <span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span>
        <span class="n">fig_to_html</span><span class="p">(</span>
            <span class="n">fig</span><span class="p">,</span>
            <span class="n">output_fname</span><span class="p">,</span>
            <span class="n">figure_height</span><span class="o">=</span><span class="n">figure_height</span><span class="p">,</span>
            <span class="n">figure_width</span><span class="o">=</span><span class="n">figure_width</span><span class="p">,</span>
            <span class="n">offline</span><span class="o">=</span><span class="n">offline</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">SUPPORTED_OUTPUT_FORMATS</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="n">output_fname</span><span class="p">)</span></div>

    
  
<div class="viewcode-block" id="make_alascan_plot">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.make_alascan_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_alascan_plot</span><span class="p">(</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">clt_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">scan_res</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ALA&quot;</span><span class="p">,</span>
        <span class="n">offline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a plotly interactive plot.</span>

<span class="sd">    Score components are here **weighted** by their respective</span>
<span class="sd">    contribution to the total score.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing the results of the alanine scan.</span>
<span class="sd">    clt_id : int</span>
<span class="sd">        Cluster ID.</span>
<span class="sd">    scan_res : str, optional</span>
<span class="sd">        Residue name used for the scan, by default &quot;ALA&quot;</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    html_output_filename : str</span>
<span class="sd">        Name of the plot generated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plot_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;scan_clt_</span><span class="si">{</span><span class="n">clt_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating </span><span class="si">{</span><span class="n">scan_res</span><span class="si">}</span><span class="s2"> scanning plot </span><span class="si">{</span><span class="n">plot_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># create figure</span>
    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">1000</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">height</span><span class="p">})</span>
    <span class="c1"># add traces</span>
    <span class="c1"># Delta HADDOCK score</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_resname&quot;</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;delta_score&quot;</span><span class="p">],</span>
            <span class="n">error_y</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;delta_score_std&quot;</span><span class="p">]},</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;delta_score&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="c1"># Delta VdW</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_resname&quot;</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;delta_vdw&quot;</span><span class="p">],</span>
            <span class="n">error_y</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;delta_vdw_std&quot;</span><span class="p">]},</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;delta_vdw&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="c1"># delta_elec is given its weight in the emscoring module</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_resname&quot;</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;delta_elec&quot;</span><span class="p">],</span>
            <span class="n">error_y</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;delta_elec_std&quot;</span><span class="p">]},</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;delta_elec&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="c1"># Delta desolvation score</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_resname&quot;</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;delta_desolv&quot;</span><span class="p">],</span>
            <span class="n">error_y</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;delta_desolv_std&quot;</span><span class="p">]},</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;delta_desolv&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="c1"># prettifying layout</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scan_res</span><span class="si">}</span><span class="s2"> scanning cluster </span><span class="si">{</span><span class="n">clt_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Residue Name&quot;</span><span class="p">,</span> <span class="s2">&quot;font&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">}},</span>
            <span class="s2">&quot;tickfont_size&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
            <span class="s2">&quot;tick0&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_resname&quot;</span><span class="p">],</span>
            <span class="c1"># in case we want to show less residues</span>
            <span class="c1"># &quot;dtick&quot;: 10,</span>
            <span class="p">},</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;Average Delta (WT - mutant)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;font&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">}</span>
                <span class="p">},</span>
            <span class="s2">&quot;tickfont_size&quot;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="n">legend</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mf">1.01</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">&quot;font_family&quot;</span><span class="p">:</span> <span class="s2">&quot;Helvetica&quot;</span><span class="p">,</span>
            <span class="s2">&quot;font_size&quot;</span><span class="p">:</span> <span class="mi">16</span>
            <span class="p">},</span>
        <span class="n">barmode</span><span class="o">=</span><span class="s2">&quot;group&quot;</span><span class="p">,</span>
        <span class="n">bargap</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
        <span class="n">bargroupgap</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s2">&quot;x unified&quot;</span><span class="p">,</span>
        <span class="n">hoverlabel</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;font_size&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;font_family&quot;</span><span class="p">:</span> <span class="s2">&quot;Helvetica&quot;</span><span class="p">},</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_vline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">line_color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

    <span class="c1"># save html</span>
    <span class="n">html_output_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plot_name</span><span class="si">}</span><span class="s2">.html&quot;</span>
    <span class="n">export_plotly_figure</span><span class="p">(</span>
        <span class="n">fig</span><span class="p">,</span>
        <span class="n">html_output_filename</span><span class="p">,</span>
        <span class="n">figure_height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span>
        <span class="n">figure_width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span>
        <span class="n">offline</span><span class="o">=</span><span class="n">offline</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">html_output_filename</span></div>



<div class="viewcode-block" id="fig_to_html">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.fig_to_html">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fig_to_html</span><span class="p">(</span>
        <span class="n">fig</span><span class="p">:</span> <span class="n">Figure</span><span class="p">,</span>
        <span class="n">fpath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">],</span>
        <span class="n">plot_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">figure_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span>
        <span class="n">figure_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="n">offline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Workaround plotly html file generation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fig : Figure</span>
<span class="sd">        A Figure object created by Plotly</span>
<span class="sd">    fpath : Union[str, Path]</span>
<span class="sd">        Where to write the content</span>
<span class="sd">    json_content : str</span>
<span class="sd">        plotly json content</span>
<span class="sd">    plot_id : int</span>
<span class="sd">        plot id to be used in the html content</span>
<span class="sd">    figure_height : int</span>
<span class="sd">        figure height (in pixels)</span>
<span class="sd">    figure_width : int</span>
<span class="sd">        figure width (in pixels)</span>
<span class="sd">    offline : bool</span>
<span class="sd">        If set to False, use the cdn url to obtain the javascript content</span>
<span class="sd">        for the rendering.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert to json</span>
    <span class="n">json_content</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
    <span class="c1"># Create custom html file</span>
    <span class="n">html_content</span> <span class="o">=</span> <span class="n">create_html</span><span class="p">(</span>
        <span class="n">json_content</span><span class="p">,</span>
        <span class="n">plot_id</span><span class="o">=</span><span class="n">plot_id</span><span class="p">,</span>
        <span class="n">plotly_js_import</span><span class="o">=</span><span class="n">offline_js_manager</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">offline</span><span class="p">),</span>
        <span class="n">figure_height</span><span class="o">=</span><span class="n">figure_height</span><span class="p">,</span>
        <span class="n">figure_width</span><span class="o">=</span><span class="n">figure_width</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="c1"># Write it</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">html_content</span><span class="p">)</span></div>



<div class="viewcode-block" id="offline_js_manager">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.offline_js_manager">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">offline_js_manager</span><span class="p">(</span><span class="n">fpath</span><span class="p">:</span> <span class="n">FilePath</span><span class="p">,</span> <span class="n">offline</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build string to access plotly javascript content.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fpath : FilePath</span>
<span class="sd">        Path to the figure about to be written.</span>
<span class="sd">    offline : bool</span>
<span class="sd">        if True use the offline approach.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plotly_js_import : str</span>
<span class="sd">        HTML solution for the importation of the plotly javascript content.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Case when offline is true</span>
    <span class="k">if</span> <span class="n">offline</span><span class="p">:</span>
        <span class="c1"># Obtain directory where the figure should be written</span>
        <span class="n">fig_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fpath</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
        <span class="c1"># Set plotly js filepath</span>
        <span class="n">plotly_js_fpath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">fig_dir</span><span class="p">,</span> <span class="s2">&quot;plotly_bundle.js&quot;</span><span class="p">)</span>
        <span class="c1"># Check that this file do not already exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">plotly_js_fpath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="c1"># Write the plotly java script content</span>
            <span class="n">plotly_js_fpath</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">get_plotlyjs</span><span class="p">())</span>
        <span class="c1"># Build HTML string</span>
        <span class="n">plotly_js_import</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;script src=&quot;</span><span class="si">{</span><span class="n">plotly_js_fpath</span><span class="si">}</span><span class="s1">&quot;&gt;&lt;/script&gt;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use CDN url to obtain the script</span>
        <span class="n">plotly_js_import</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;script src=&quot;</span><span class="si">{</span><span class="n">plotly_cdn_url</span><span class="p">()</span><span class="si">}</span><span class="s1">&quot;&gt;&lt;/script&gt;&#39;</span>
    <span class="k">return</span> <span class="n">plotly_js_import</span></div>

        

<div class="viewcode-block" id="make_traceback_plot">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.libplots.html#haddock.libs.libplots.make_traceback_plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">make_traceback_plot</span><span class="p">(</span><span class="n">tr_subset</span><span class="p">,</span> <span class="n">plot_filename</span><span class="p">,</span> <span class="n">offline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a traceback barplot with the 40 best ranked models.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tr_subset : pandas.DataFrame</span>
<span class="sd">        DataFrame containing the top traceback results</span>
<span class="sd">    plot_filename : Path</span>
<span class="sd">        Path to the output filename to generate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rank_columns</span> <span class="o">=</span> <span class="n">tr_subset</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">tr_subset</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;rank&quot;</span><span class="p">)]</span>
    <span class="c1"># for each row, plot a bar with the values of the rank columns</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">tr_subset</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Model&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">rank_columns</span><span class="p">)</span>
    <span class="c1"># vertical legend on the right with legend name &#39;Modules&#39;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">legend_orientation</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">legend_title</span><span class="o">=</span><span class="s2">&quot;Modules&quot;</span><span class="p">)</span>
    <span class="c1"># legend should have bigger font size</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">title_font_size</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
            <span class="n">font_size</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="c1"># y axis title &#39;Sum of Ranks&#39;</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;Sum of Ranks&quot;</span><span class="p">,</span> <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Models&quot;</span><span class="p">)</span>
    <span class="c1"># bigger axis labels</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title_font_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">tickfont_size</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title_font_size</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">tickfont_size</span><span class="o">=</span><span class="mi">16</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="c1"># bigger title</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title_text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Top ranked </span><span class="si">{</span><span class="n">tr_subset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> Models&quot;</span><span class="p">,</span>
        <span class="n">title_font_size</span><span class="o">=</span><span class="mi">30</span>
        <span class="p">)</span>
    <span class="n">fig_to_html</span><span class="p">(</span>
        <span class="n">fig</span><span class="p">,</span>
        <span class="n">plot_filename</span><span class="p">,</span>
        <span class="n">figure_height</span><span class="o">=</span><span class="mi">1200</span><span class="p">,</span>
        <span class="n">figure_width</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
        <span class="n">offline</span><span class="o">=</span><span class="n">offline</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">plot_filename</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, BonvinLab.
      <span class="lastupdated">Last updated on Oct 01, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>