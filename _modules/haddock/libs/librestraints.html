

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>haddock.libs.librestraints &mdash; haddock3 3.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=34bb78ad" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=acc74ff5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            haddock3
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../intro.html">A brief introduction to HADDOCK3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../INSTALL.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../USAGE.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Workflow Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Advanced features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../clients/haddock.clis.html">Command-line interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/index.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../testing/index.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing to HADDOCK3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../citing.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">Library Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">haddock3</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../haddock.html">haddock</a></li>
      <li class="breadcrumb-item active">haddock.libs.librestraints</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for haddock.libs.librestraints</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generator</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">Bio.PDB</span><span class="w"> </span><span class="kn">import</span> <span class="n">PDBParser</span><span class="p">,</span> <span class="n">NeighborSearch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">freesasa</span><span class="w"> </span><span class="kn">import</span> <span class="n">Classifier</span><span class="p">,</span> <span class="n">structureFromBioPDB</span><span class="p">,</span> <span class="n">calc</span>

<span class="c1"># Scaling factors for relative ASA</span>
<span class="c1"># Calculated using extended ALA-X-ALA peptides</span>
<span class="c1"># Taken from NACCESS</span>
<span class="n">REL_ASA</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;total&#39;</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="s1">&#39;ALA&#39;</span><span class="p">:</span> <span class="mf">107.95</span><span class="p">,</span>
            <span class="s1">&#39;CYS&#39;</span><span class="p">:</span> <span class="mf">134.28</span><span class="p">,</span>
            <span class="s1">&#39;ASP&#39;</span><span class="p">:</span> <span class="mf">140.39</span><span class="p">,</span>
            <span class="s1">&#39;GLU&#39;</span><span class="p">:</span> <span class="mf">172.25</span><span class="p">,</span>
            <span class="s1">&#39;PHE&#39;</span><span class="p">:</span> <span class="mf">199.48</span><span class="p">,</span>
            <span class="s1">&#39;GLY&#39;</span><span class="p">:</span> <span class="mf">80.10</span><span class="p">,</span>
            <span class="s1">&#39;HIS&#39;</span><span class="p">:</span> <span class="mf">182.88</span><span class="p">,</span>
            <span class="s1">&#39;ILE&#39;</span><span class="p">:</span> <span class="mf">175.12</span><span class="p">,</span>
            <span class="s1">&#39;LYS&#39;</span><span class="p">:</span> <span class="mf">200.81</span><span class="p">,</span>
            <span class="s1">&#39;LEU&#39;</span><span class="p">:</span> <span class="mf">178.63</span><span class="p">,</span>
            <span class="s1">&#39;MET&#39;</span><span class="p">:</span> <span class="mf">194.15</span><span class="p">,</span>
            <span class="s1">&#39;ASN&#39;</span><span class="p">:</span> <span class="mf">143.94</span><span class="p">,</span>
            <span class="s1">&#39;PRO&#39;</span><span class="p">:</span> <span class="mf">136.13</span><span class="p">,</span>
            <span class="s1">&#39;GLN&#39;</span><span class="p">:</span> <span class="mf">178.50</span><span class="p">,</span>
            <span class="s1">&#39;ARG&#39;</span><span class="p">:</span> <span class="mf">238.76</span><span class="p">,</span>
            <span class="s1">&#39;SER&#39;</span><span class="p">:</span> <span class="mf">116.50</span><span class="p">,</span>
            <span class="s1">&#39;THR&#39;</span><span class="p">:</span> <span class="mf">139.27</span><span class="p">,</span>
            <span class="s1">&#39;VAL&#39;</span><span class="p">:</span> <span class="mf">151.44</span><span class="p">,</span>
            <span class="s1">&#39;TRP&#39;</span><span class="p">:</span> <span class="mf">249.36</span><span class="p">,</span>
            <span class="s1">&#39;TYR&#39;</span><span class="p">:</span> <span class="mf">212.76</span><span class="p">,</span>
            <span class="s1">&#39;ASH&#39;</span><span class="p">:</span> <span class="mf">140.39</span><span class="p">,</span>
            <span class="s1">&#39;DDZ&#39;</span><span class="p">:</span> <span class="mf">107.95</span><span class="p">,</span>
            <span class="s1">&#39;GLH&#39;</span><span class="p">:</span> <span class="mf">172.25</span><span class="p">,</span>
            <span class="s1">&#39;CYM&#39;</span><span class="p">:</span> <span class="mf">134.28</span><span class="p">,</span>
            <span class="s1">&#39;CSP&#39;</span><span class="p">:</span> <span class="mf">134.28</span><span class="p">,</span>
            <span class="s1">&#39;CYF&#39;</span><span class="p">:</span> <span class="mf">134.28</span><span class="p">,</span>
            <span class="s1">&#39;CYC&#39;</span><span class="p">:</span> <span class="mf">134.28</span><span class="p">,</span>
            <span class="s1">&#39;CFE&#39;</span><span class="p">:</span> <span class="mf">134.28</span><span class="p">,</span>
            <span class="s1">&#39;NEP&#39;</span><span class="p">:</span> <span class="mf">182.88</span><span class="p">,</span>
            <span class="s1">&#39;ALY&#39;</span><span class="p">:</span> <span class="mf">200.81</span><span class="p">,</span>
            <span class="s1">&#39;MLZ&#39;</span><span class="p">:</span> <span class="mf">200.81</span><span class="p">,</span>
            <span class="s1">&#39;MLY&#39;</span><span class="p">:</span> <span class="mf">200.81</span><span class="p">,</span>
            <span class="s1">&#39;M3L&#39;</span><span class="p">:</span> <span class="mf">200.81</span><span class="p">,</span>
            <span class="s1">&#39;HYP&#39;</span><span class="p">:</span> <span class="mf">136.13</span><span class="p">,</span>
            <span class="s1">&#39;SEP&#39;</span><span class="p">:</span> <span class="mf">116.50</span><span class="p">,</span>
            <span class="s1">&#39;TOP&#39;</span><span class="p">:</span> <span class="mf">139.27</span><span class="p">,</span>
            <span class="s1">&#39;TYP&#39;</span><span class="p">:</span> <span class="mf">212.76</span><span class="p">,</span>
            <span class="s1">&#39;PTR&#39;</span><span class="p">:</span> <span class="mf">212.76</span><span class="p">,</span>
            <span class="s1">&#39;TYS&#39;</span><span class="p">:</span> <span class="mf">212.76</span><span class="p">,</span>
            <span class="s1">&#39;PNS&#39;</span><span class="p">:</span> <span class="mf">116.50</span><span class="p">,</span>
            <span class="p">},</span>
    <span class="s1">&#39;bb&#39;</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="s1">&#39;ALA&#39;</span><span class="p">:</span> <span class="mf">38.54</span><span class="p">,</span>
            <span class="s1">&#39;CYS&#39;</span><span class="p">:</span> <span class="mf">37.53</span><span class="p">,</span>
            <span class="s1">&#39;ASP&#39;</span><span class="p">:</span> <span class="mf">37.70</span><span class="p">,</span>
            <span class="s1">&#39;GLU&#39;</span><span class="p">:</span> <span class="mf">37.51</span><span class="p">,</span>
            <span class="s1">&#39;PHE&#39;</span><span class="p">:</span> <span class="mf">35.37</span><span class="p">,</span>
            <span class="s1">&#39;GLY&#39;</span><span class="p">:</span> <span class="mf">47.77</span><span class="p">,</span>
            <span class="s1">&#39;HIS&#39;</span><span class="p">:</span> <span class="mf">35.80</span><span class="p">,</span>
            <span class="s1">&#39;ILE&#39;</span><span class="p">:</span> <span class="mf">37.16</span><span class="p">,</span>
            <span class="s1">&#39;LYS&#39;</span><span class="p">:</span> <span class="mf">37.51</span><span class="p">,</span>
            <span class="s1">&#39;LEU&#39;</span><span class="p">:</span> <span class="mf">37.51</span><span class="p">,</span>
            <span class="s1">&#39;MET&#39;</span><span class="p">:</span> <span class="mf">37.51</span><span class="p">,</span>
            <span class="s1">&#39;ASN&#39;</span><span class="p">:</span> <span class="mf">37.70</span><span class="p">,</span>
            <span class="s1">&#39;PRO&#39;</span><span class="p">:</span> <span class="mf">16.23</span><span class="p">,</span>
            <span class="s1">&#39;GLN&#39;</span><span class="p">:</span> <span class="mf">37.51</span><span class="p">,</span>
            <span class="s1">&#39;ARG&#39;</span><span class="p">:</span> <span class="mf">37.51</span><span class="p">,</span>
            <span class="s1">&#39;SER&#39;</span><span class="p">:</span> <span class="mf">38.40</span><span class="p">,</span>
            <span class="s1">&#39;THR&#39;</span><span class="p">:</span> <span class="mf">37.57</span><span class="p">,</span>
            <span class="s1">&#39;VAL&#39;</span><span class="p">:</span> <span class="mf">37.16</span><span class="p">,</span>
            <span class="s1">&#39;TRP&#39;</span><span class="p">:</span> <span class="mf">38.10</span><span class="p">,</span>
            <span class="s1">&#39;TYR&#39;</span><span class="p">:</span> <span class="mf">35.38</span><span class="p">,</span>
            <span class="s1">&#39;ASH&#39;</span><span class="p">:</span> <span class="mf">37.70</span><span class="p">,</span>
            <span class="s1">&#39;DDZ&#39;</span><span class="p">:</span> <span class="mf">38.54</span><span class="p">,</span>
            <span class="s1">&#39;GLH&#39;</span><span class="p">:</span> <span class="mf">37.51</span><span class="p">,</span>
            <span class="s1">&#39;CYM&#39;</span><span class="p">:</span> <span class="mf">37.53</span><span class="p">,</span>
            <span class="s1">&#39;CYC&#39;</span><span class="p">:</span> <span class="mf">37.53</span><span class="p">,</span>
            <span class="s1">&#39;CSP&#39;</span><span class="p">:</span> <span class="mf">37.53</span><span class="p">,</span>
            <span class="s1">&#39;CYF&#39;</span><span class="p">:</span> <span class="mf">37.53</span><span class="p">,</span>
            <span class="s1">&#39;CFE&#39;</span><span class="p">:</span> <span class="mf">37.53</span><span class="p">,</span>
            <span class="s1">&#39;NEP&#39;</span><span class="p">:</span> <span class="mf">35.80</span><span class="p">,</span>
            <span class="s1">&#39;ALY&#39;</span><span class="p">:</span> <span class="mf">37.51</span><span class="p">,</span>
            <span class="s1">&#39;MLZ&#39;</span><span class="p">:</span> <span class="mf">37.51</span><span class="p">,</span>
            <span class="s1">&#39;MLY&#39;</span><span class="p">:</span> <span class="mf">37.51</span><span class="p">,</span>
            <span class="s1">&#39;M3L&#39;</span><span class="p">:</span> <span class="mf">37.51</span><span class="p">,</span>
            <span class="s1">&#39;HYP&#39;</span><span class="p">:</span> <span class="mf">16.23</span><span class="p">,</span>
            <span class="s1">&#39;SEP&#39;</span><span class="p">:</span> <span class="mf">38.40</span><span class="p">,</span>
            <span class="s1">&#39;TOP&#39;</span><span class="p">:</span> <span class="mf">37.57</span><span class="p">,</span>
            <span class="s1">&#39;TYP&#39;</span><span class="p">:</span> <span class="mf">35.38</span><span class="p">,</span>
            <span class="s1">&#39;PTR&#39;</span><span class="p">:</span> <span class="mf">35.38</span><span class="p">,</span>
            <span class="s1">&#39;TYS&#39;</span><span class="p">:</span> <span class="mf">35.38</span><span class="p">,</span>
            <span class="s1">&#39;PNS&#39;</span><span class="p">:</span> <span class="mf">38.40</span><span class="p">,</span>
            <span class="p">},</span>
    <span class="s1">&#39;sc&#39;</span><span class="p">:</span>
        <span class="p">{</span>
            <span class="s1">&#39;ALA&#39;</span><span class="p">:</span> <span class="mf">69.41</span><span class="p">,</span>
            <span class="s1">&#39;CYS&#39;</span><span class="p">:</span> <span class="mf">96.75</span><span class="p">,</span>
            <span class="s1">&#39;ASP&#39;</span><span class="p">:</span> <span class="mf">102.69</span><span class="p">,</span>
            <span class="s1">&#39;GLU&#39;</span><span class="p">:</span> <span class="mf">134.74</span><span class="p">,</span>
            <span class="s1">&#39;PHE&#39;</span><span class="p">:</span> <span class="mf">164.11</span><span class="p">,</span>
            <span class="s1">&#39;GLY&#39;</span><span class="p">:</span> <span class="mf">32.33</span><span class="p">,</span>
            <span class="s1">&#39;HIS&#39;</span><span class="p">:</span> <span class="mf">147.08</span><span class="p">,</span>
            <span class="s1">&#39;ILE&#39;</span><span class="p">:</span> <span class="mf">137.96</span><span class="p">,</span>
            <span class="s1">&#39;LYS&#39;</span><span class="p">:</span> <span class="mf">163.30</span><span class="p">,</span>
            <span class="s1">&#39;LEU&#39;</span><span class="p">:</span> <span class="mf">141.12</span><span class="p">,</span>
            <span class="s1">&#39;MET&#39;</span><span class="p">:</span> <span class="mf">156.64</span><span class="p">,</span>
            <span class="s1">&#39;ASN&#39;</span><span class="p">:</span> <span class="mf">106.24</span><span class="p">,</span>
            <span class="s1">&#39;PRO&#39;</span><span class="p">:</span> <span class="mf">119.90</span><span class="p">,</span>
            <span class="s1">&#39;GLN&#39;</span><span class="p">:</span> <span class="mf">140.99</span><span class="p">,</span>
            <span class="s1">&#39;ARG&#39;</span><span class="p">:</span> <span class="mf">201.25</span><span class="p">,</span>
            <span class="s1">&#39;SER&#39;</span><span class="p">:</span> <span class="mf">78.11</span><span class="p">,</span>
            <span class="s1">&#39;THR&#39;</span><span class="p">:</span> <span class="mf">101.70</span><span class="p">,</span>
            <span class="s1">&#39;VAL&#39;</span><span class="p">:</span> <span class="mf">114.28</span><span class="p">,</span>
            <span class="s1">&#39;TRP&#39;</span><span class="p">:</span> <span class="mf">211.26</span><span class="p">,</span>
            <span class="s1">&#39;TYR&#39;</span><span class="p">:</span> <span class="mf">177.38</span><span class="p">,</span>
            <span class="s1">&#39;ASH&#39;</span><span class="p">:</span> <span class="mf">102.69</span><span class="p">,</span>
            <span class="s1">&#39;DDZ&#39;</span><span class="p">:</span> <span class="mf">69.41</span><span class="p">,</span>
            <span class="s1">&#39;GLH&#39;</span><span class="p">:</span> <span class="mf">134.74</span><span class="p">,</span>
            <span class="s1">&#39;CYM&#39;</span><span class="p">:</span> <span class="mf">96.75</span><span class="p">,</span>
            <span class="s1">&#39;CYC&#39;</span><span class="p">:</span> <span class="mf">96.75</span><span class="p">,</span>
            <span class="s1">&#39;CSP&#39;</span><span class="p">:</span> <span class="mf">96.75</span><span class="p">,</span>
            <span class="s1">&#39;CYF&#39;</span><span class="p">:</span> <span class="mf">96.75</span><span class="p">,</span>
            <span class="s1">&#39;CFE&#39;</span><span class="p">:</span> <span class="mf">96.75</span><span class="p">,</span>
            <span class="s1">&#39;NEP&#39;</span><span class="p">:</span> <span class="mf">147.08</span><span class="p">,</span>
            <span class="s1">&#39;ALY&#39;</span><span class="p">:</span> <span class="mf">163.30</span><span class="p">,</span>
            <span class="s1">&#39;MLZ&#39;</span><span class="p">:</span> <span class="mf">163.30</span><span class="p">,</span>
            <span class="s1">&#39;MLY&#39;</span><span class="p">:</span> <span class="mf">163.30</span><span class="p">,</span>
            <span class="s1">&#39;M3L&#39;</span><span class="p">:</span> <span class="mf">163.30</span><span class="p">,</span>
            <span class="s1">&#39;HYP&#39;</span><span class="p">:</span> <span class="mf">119.90</span><span class="p">,</span>
            <span class="s1">&#39;SEP&#39;</span><span class="p">:</span> <span class="mf">78.11</span><span class="p">,</span>
            <span class="s1">&#39;TOP&#39;</span><span class="p">:</span> <span class="mf">101.70</span><span class="p">,</span>
            <span class="s1">&#39;TYP&#39;</span><span class="p">:</span> <span class="mf">177.38</span><span class="p">,</span>
            <span class="s1">&#39;PTR&#39;</span><span class="p">:</span> <span class="mf">177.38</span><span class="p">,</span>
            <span class="s1">&#39;TYS&#39;</span><span class="p">:</span> <span class="mf">177.38</span><span class="p">,</span>
            <span class="s1">&#39;PNS&#39;</span><span class="p">:</span> <span class="mf">78.11</span><span class="p">,</span>
            <span class="p">}</span>
    <span class="p">}</span>
<span class="n">DEFAULT_PROBE_RADIUS</span> <span class="o">=</span> <span class="mf">1.4</span>

<div class="viewcode-block" id="get_surface_resids">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.librestraints.html#haddock.libs.librestraints.get_surface_resids">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_surface_resids</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls freesasa using its Python API and returns</span>
<span class="sd">    per-residue accessibilities.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">asa_data</span><span class="p">,</span> <span class="n">rsa_data</span><span class="p">,</span> <span class="n">rel_main_chain</span><span class="p">,</span> <span class="n">rel_side_chain</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
    <span class="n">_rsa</span> <span class="o">=</span> <span class="n">REL_ASA</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
    <span class="n">_rsa_bb</span> <span class="o">=</span> <span class="n">REL_ASA</span><span class="p">[</span><span class="s1">&#39;bb&#39;</span><span class="p">]</span>
    <span class="n">_rsa_sc</span> <span class="o">=</span> <span class="n">REL_ASA</span><span class="p">[</span><span class="s1">&#39;sc&#39;</span><span class="p">]</span>

    <span class="c1">#classifier = Classifier(config_path)</span>
    <span class="n">classifier</span> <span class="o">=</span> <span class="n">Classifier</span><span class="p">()</span>

    <span class="n">struct</span> <span class="o">=</span> <span class="n">structureFromBioPDB</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">classifier</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">calc</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span>

    <span class="c1"># iterate over all atoms to get SASA and residue name</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">nAtoms</span><span class="p">()):</span>
        <span class="n">atname</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">atomName</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">resname</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">residueName</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">resid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">residueNumber</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">chainLabel</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">at_uid</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">atname</span><span class="p">)</span>
        <span class="n">res_uid</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">resid</span><span class="p">)</span>

        <span class="n">asa</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">atomArea</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">asa_data</span><span class="p">[</span><span class="n">at_uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">asa</span>
        <span class="c1"># add asa to residue</span>
        <span class="n">rsa_data</span><span class="p">[</span><span class="n">res_uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">rsa_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">res_uid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">asa</span>

        <span class="k">if</span> <span class="n">atname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">):</span>
            <span class="n">rel_main_chain</span><span class="p">[</span><span class="n">res_uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_main_chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">res_uid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">asa</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rel_side_chain</span><span class="p">[</span><span class="n">res_uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_side_chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">res_uid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">asa</span>

    <span class="c1"># convert total asa ro relative asa</span>
    <span class="n">rsa_data</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">res_uid</span><span class="p">,</span> <span class="n">asa</span> <span class="o">/</span> <span class="n">_rsa</span><span class="p">[</span><span class="n">res_uid</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="k">for</span> <span class="n">res_uid</span><span class="p">,</span> <span class="n">asa</span> <span class="ow">in</span> <span class="n">rsa_data</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">rel_main_chain</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">res_uid</span><span class="p">,</span> <span class="n">asa</span> <span class="o">/</span> <span class="n">_rsa_bb</span><span class="p">[</span><span class="n">res_uid</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">for</span> <span class="n">res_uid</span><span class="p">,</span> <span class="n">asa</span> <span class="ow">in</span> <span class="n">rel_main_chain</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">rel_side_chain</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">res_uid</span><span class="p">,</span> <span class="n">asa</span> <span class="o">/</span> <span class="n">_rsa_sc</span><span class="p">[</span><span class="n">res_uid</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">for</span> <span class="n">res_uid</span><span class="p">,</span> <span class="n">asa</span> <span class="ow">in</span> <span class="n">rel_side_chain</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="c1"># We format to fit the pipeline</span>
    <span class="n">resid_access</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">res_uid</span><span class="p">,</span> <span class="n">access</span> <span class="ow">in</span> <span class="n">rel_main_chain</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">resid_access</span><span class="p">[</span><span class="n">res_uid</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;side_chain_rel&#39;</span><span class="p">:</span> <span class="n">rel_side_chain</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">res_uid</span><span class="p">),</span> <span class="s1">&#39;main_chain_rel&#39;</span><span class="p">:</span> <span class="n">access</span><span class="p">}</span>
    <span class="n">surface_resids</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">resid_access</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;side_chain_rel&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cutoff</span> <span class="ow">or</span>
                      <span class="n">v</span><span class="p">[</span><span class="s1">&#39;main_chain_rel&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cutoff</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">surface_resids</span></div>



<div class="viewcode-block" id="parse_actpass_file">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.librestraints.html#haddock.libs.librestraints.parse_actpass_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_actpass_file</span><span class="p">(</span><span class="n">actpass_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse actpass file</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    actpass_file: str or Path</span>
<span class="sd">        path to actpass_file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    active: list</span>
<span class="sd">        list of active residues</span>
<span class="sd">    passive: list</span>
<span class="sd">        list of passive residues</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">actpass_file</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;actpass file </span><span class="si">{</span><span class="n">actpass_file</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">actpass_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">nlines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nlines</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;actpass file </span><span class="si">{</span><span class="n">actpass_file</span><span class="si">}</span><span class="s2"> does not have two lines (counted </span><span class="si">{</span><span class="n">nlines</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">active</span><span class="p">,</span> <span class="n">passive</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">active</span><span class="p">,</span> <span class="n">passive</span></div>



<div class="viewcode-block" id="active_passive_to_ambig">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.librestraints.html#haddock.libs.librestraints.active_passive_to_ambig">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">active_passive_to_ambig</span><span class="p">(</span><span class="n">active1</span><span class="p">,</span> <span class="n">passive1</span><span class="p">,</span> <span class="n">active2</span><span class="p">,</span> <span class="n">passive2</span><span class="p">,</span> <span class="n">segid1</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">segid2</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert active and passive residues to Ambiguous Interaction Restraints</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    active1 : list</span>
<span class="sd">        List of active residue numbers of the first segid</span>

<span class="sd">    passive1 : list</span>
<span class="sd">        List of passive residue numbers of the first segid</span>

<span class="sd">    passive2 : list</span>
<span class="sd">        List of passive residue numbers of the second segid</span>

<span class="sd">    active2 : list</span>
<span class="sd">        List of active residue numbers of the second segid</span>
<span class="sd">    </span>
<span class="sd">    active2 : list</span>
<span class="sd">        List of passive residue numbers of the second segid</span>

<span class="sd">    segid1 : string</span>
<span class="sd">        Segid to use for the first model</span>

<span class="sd">    segid2 : string</span>
<span class="sd">        Segid to use for the second model</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">all1</span> <span class="o">=</span> <span class="n">active1</span> <span class="o">+</span> <span class="n">passive1</span>
    <span class="n">all2</span> <span class="o">=</span> <span class="n">active2</span> <span class="o">+</span> <span class="n">passive2</span>

    <span class="k">for</span> <span class="n">resi1</span> <span class="ow">in</span> <span class="n">active1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;assign (resi </span><span class="si">{:d}</span><span class="s1"> and segid </span><span class="si">{:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resi1</span><span class="p">,</span> <span class="n">segid1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">resi2</span> <span class="ow">in</span> <span class="n">all2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;       (resi </span><span class="si">{:d}</span><span class="s1"> and segid </span><span class="si">{:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resi2</span><span class="p">,</span> <span class="n">segid2</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all2</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        or&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;) 2.0 2.0 0.0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            
    <span class="k">for</span> <span class="n">resi2</span> <span class="ow">in</span> <span class="n">active2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;assign (resi </span><span class="si">{:d}</span><span class="s1"> and segid </span><span class="si">{:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resi2</span><span class="p">,</span> <span class="n">segid2</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">resi1</span> <span class="ow">in</span> <span class="n">all1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;       (resi </span><span class="si">{:d}</span><span class="s1"> and segid </span><span class="si">{:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resi1</span><span class="p">,</span> <span class="n">segid1</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all1</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        or&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;) 2.0 2.0 0.0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>



<span class="c1"># Functions/Methods</span>

<div class="viewcode-block" id="calc_euclidean">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.librestraints.html#haddock.libs.librestraints.calc_euclidean">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_euclidean</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">i</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span></div>



<div class="viewcode-block" id="read_structure">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.librestraints.html#haddock.libs.librestraints.read_structure">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_structure</span><span class="p">(</span><span class="n">pdbf</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Reads a PDB file and returns a list of parsed atoms</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">_atoms</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">}</span>  <span class="c1"># Alpha-Carbon (Prot), Backbone Phosphorous (DNA)</span>
	<span class="n">_altloc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">}</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="n">exclude</span><span class="p">:</span>
		<span class="n">exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">exclude</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>

	<span class="n">res_list</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdbf</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdb_handle</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">pdb_handle</span><span class="p">:</span>
			<span class="n">field</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
			<span class="k">if</span> <span class="n">field</span> <span class="o">!=</span> <span class="s1">&#39;ATOM&#39;</span><span class="p">:</span>
				<span class="k">continue</span>

			<span class="n">aname</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
			<span class="n">chain</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="n">line</span><span class="p">[</span><span class="mi">72</span><span class="p">:</span><span class="mi">76</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># chain ID or segID</span>
			<span class="k">if</span> <span class="n">chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span> <span class="ow">and</span> <span class="n">aname</span> <span class="ow">in</span> <span class="n">_atoms</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="ow">in</span> <span class="n">_altloc</span><span class="p">:</span>
				<span class="n">resi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">26</span><span class="p">])</span>
				<span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">38</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">38</span><span class="p">:</span><span class="mi">46</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">46</span><span class="p">:</span><span class="mi">54</span><span class="p">]))</span>
				<span class="n">res_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">chain</span><span class="p">,</span> <span class="n">resi</span><span class="p">,</span> <span class="n">aname</span><span class="p">,</span> <span class="n">coords</span><span class="p">))</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="n">res_list</span><span class="p">:</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;[!] PDB File seems empty or no CA/P atoms found: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pdbf</span><span class="p">))</span>
		<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">res_list</span></div>



<div class="viewcode-block" id="get_bodies">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.librestraints.html#haddock.libs.librestraints.get_bodies">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_bodies</span><span class="p">(</span><span class="n">atom_lst</span><span class="p">,</span> <span class="n">prot_threshold</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">dna_threshold</span><span class="o">=</span><span class="mf">7.5</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Determines gaps in an atom list following simple distance based criteria.</span>
<span class="sd">	Returns continuous fragments.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="n">bodies</span> <span class="o">=</span> <span class="p">[]</span>

	<span class="n">threshold</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CA&#39;</span><span class="p">:</span> <span class="n">prot_threshold</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="n">dna_threshold</span><span class="p">}</span>

	<span class="n">body_start</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">i</span> <span class="o">=</span> <span class="kc">None</span>
	<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atom_lst</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
		<span class="n">p_atom</span> <span class="o">=</span> <span class="n">atom_lst</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

		<span class="n">chain</span><span class="p">,</span> <span class="n">resi</span><span class="p">,</span> <span class="n">aname</span><span class="p">,</span> <span class="n">xyz</span> <span class="o">=</span> <span class="n">atom</span>
		<span class="n">p_chain</span><span class="p">,</span> <span class="n">p_resi</span><span class="p">,</span> <span class="n">p_aname</span><span class="p">,</span> <span class="n">p_xyz</span> <span class="o">=</span> <span class="n">p_atom</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chain</span> <span class="o">==</span> <span class="n">p_chain</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">aname</span> <span class="o">==</span> <span class="n">p_aname</span><span class="p">):</span>  <span class="c1"># Internal Gap</span>
			<span class="n">d_xyz</span> <span class="o">=</span> <span class="n">calc_euclidean</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">p_xyz</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">d_xyz</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">[</span><span class="n">aname</span><span class="p">]:</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;[+++] (Internal) Body: </span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">body_start</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="n">bodies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">body_start</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="n">body_start</span> <span class="o">=</span> <span class="n">i</span>  <span class="c1"># Set new beginning</span>

		<span class="k">elif</span> <span class="p">(</span><span class="n">chain</span> <span class="o">!=</span> <span class="n">p_chain</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">aname</span> <span class="o">!=</span> <span class="n">p_aname</span><span class="p">):</span>  <span class="c1"># Different molecules/types</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;[+++] Body: </span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">body_start</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			<span class="n">bodies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">body_start</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			<span class="n">body_start</span> <span class="o">=</span> <span class="n">i</span>  <span class="c1"># Set new beginning</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="n">bodies</span><span class="p">:</span>  <span class="c1"># Single continuous molecule</span>
		<span class="n">bodies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom_lst</span><span class="p">)))</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;[+++] Body: </span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">body_start</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
		<span class="n">bodies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">body_start</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>  <span class="c1"># Last body</span>

	<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[++] Found </span><span class="si">{0}</span><span class="s1"> bodies&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bodies</span><span class="p">)))</span>

	<span class="k">return</span> <span class="n">bodies</span></div>



<div class="viewcode-block" id="build_restraints">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.librestraints.html#haddock.libs.librestraints.build_restraints">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_restraints</span><span class="p">(</span><span class="n">bodies</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Generates distance restraints to maintain the relative</span>
<span class="sd">	orientation of the different bodies during the simulations.</span>

<span class="sd">	Generates two unique restraints per pair of bodies.</span>

<span class="sd">	Each restraint is created using two random atoms on each body</span>
<span class="sd">	and using their exact euclidean distance as target distance.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">def</span><span class="w"> </span><span class="nf">pick_residues</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">max_trials</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
		<span class="c1"># Pick two random residues in each body</span>
		<span class="c1"># Make sure they are far apart from each other</span>
		<span class="n">n_trials</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">try</span><span class="p">:</span>
				<span class="n">res_i</span><span class="p">,</span> <span class="n">res_ii</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
				<span class="c1"># Likely, sample size is 1</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;[!] One-sized body found. This may lead to problems..&#39;</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

			<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;[+++] Trial </span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1"> &amp; </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_trials</span><span class="p">,</span> <span class="n">res_i</span><span class="p">,</span> <span class="n">res_ii</span><span class="p">))</span>
			<span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">res_i</span> <span class="o">-</span> <span class="n">res_ii</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[++] Picked residues </span><span class="si">{0}</span><span class="s1"> &amp; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_i</span><span class="p">,</span> <span class="n">res_ii</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">res_i</span><span class="p">,</span> <span class="n">res_ii</span>
			<span class="n">n_trials</span> <span class="o">+=</span> <span class="mi">1</span>
			<span class="k">if</span> <span class="n">n_trials</span> <span class="o">==</span> <span class="n">max_trials</span><span class="p">:</span>
				<span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;[!] Could not pick two unique distant residues in body after </span><span class="si">{0}</span><span class="s1"> tries&#39;</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_trials</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">res_i</span><span class="p">,</span> <span class="n">res_ii</span>

	<span class="n">restraints</span> <span class="o">=</span> <span class="p">[]</span>

	<span class="n">n_bodies</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bodies</span><span class="p">))</span>
	<span class="n">combinations</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">n_bodies</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">pair_bodies</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">:</span>
		<span class="n">body_i</span><span class="p">,</span> <span class="n">body_j</span> <span class="o">=</span> <span class="n">pair_bodies</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;[+++] Restraining body </span><span class="si">{0}</span><span class="s1"> to body </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">body_i</span><span class="p">,</span> <span class="n">body_j</span><span class="p">))</span>

		<span class="n">st_body_i</span><span class="p">,</span> <span class="n">en_body_i</span> <span class="o">=</span> <span class="n">bodies</span><span class="p">[</span><span class="n">body_i</span><span class="p">]</span>
		<span class="n">st_body_j</span><span class="p">,</span> <span class="n">en_body_j</span> <span class="o">=</span> <span class="n">bodies</span><span class="p">[</span><span class="n">body_j</span><span class="p">]</span>
		<span class="n">res_i</span><span class="p">,</span> <span class="n">res_ii</span> <span class="o">=</span> <span class="n">pick_residues</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">st_body_i</span><span class="p">,</span> <span class="n">en_body_i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">res_j</span><span class="p">,</span> <span class="n">res_jj</span> <span class="o">=</span> <span class="n">pick_residues</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">st_body_j</span><span class="p">,</span> <span class="n">en_body_j</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

		<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[++] Created restraint: </span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}</span><span class="s1"> &lt;--&gt; </span><span class="si">{2}</span><span class="s1">:</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">body_i</span><span class="p">,</span> <span class="n">res_i</span><span class="p">,</span> <span class="n">body_j</span><span class="p">,</span> <span class="n">res_j</span><span class="p">))</span>
		<span class="n">restraints</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">res_i</span><span class="p">,</span> <span class="n">res_j</span><span class="p">))</span>
		<span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[++] Created restraint: </span><span class="si">{0}</span><span class="s1">:</span><span class="si">{1}</span><span class="s1"> &lt;--&gt; </span><span class="si">{2}</span><span class="s1">:</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">body_i</span><span class="p">,</span> <span class="n">res_ii</span><span class="p">,</span> <span class="n">body_j</span><span class="p">,</span> <span class="n">res_jj</span><span class="p">))</span>
		<span class="n">restraints</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">res_ii</span><span class="p">,</span> <span class="n">res_jj</span><span class="p">))</span>

	<span class="k">return</span> <span class="n">restraints</span></div>



<div class="viewcode-block" id="generate_tbl">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.librestraints.html#haddock.libs.librestraints.generate_tbl">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_tbl</span><span class="p">(</span><span class="n">atom_lst</span><span class="p">,</span> <span class="n">restraints</span><span class="p">):</span>
<span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Makes a list of TBL-formatted restraints.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atom_lst : list</span>
<span class="sd">        List of atoms in the form (chain, resi, aname, coords)</span>
<span class="sd">    </span>
<span class="sd">    restraints : list</span>
<span class="sd">        List of restraints in the form (res_i, res_j)</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">restraints</span><span class="p">:</span>
		<span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">r</span>
		<span class="n">atom_i</span><span class="p">,</span> <span class="n">atom_j</span> <span class="o">=</span> <span class="n">atom_lst</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">atom_lst</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
		<span class="n">dist_ij</span> <span class="o">=</span> <span class="n">calc_euclidean</span><span class="p">(</span><span class="n">atom_i</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">atom_j</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

		<span class="n">tbl</span> <span class="o">=</span> <span class="s2">&quot;assign (segid </span><span class="si">{0[0]}</span><span class="s2"> and resi </span><span class="si">{0[1]}</span><span class="s2"> and name </span><span class="si">{0[2]}</span><span class="s2">) &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">atom_i</span><span class="p">)</span>
		<span class="n">tbl</span> <span class="o">+=</span> <span class="s2">&quot;(segid </span><span class="si">{0[0]}</span><span class="s2"> and resi </span><span class="si">{0[1]}</span><span class="s2"> and name </span><span class="si">{0[2]}</span><span class="s2">) &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">atom_j</span><span class="p">)</span>
		<span class="n">tbl</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{0:3.3f}</span><span class="s2"> 0.0 0.0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist_ij</span><span class="p">)</span>
		<span class="nb">print</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_parenthesis">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.librestraints.html#haddock.libs.librestraints.check_parenthesis">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_parenthesis</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
    <span class="n">open_parenthesis</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[(]&#39;</span><span class="p">)</span>
    <span class="n">close_parenthesis</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[)]&#39;</span><span class="p">)</span>
    <span class="n">quotation_marks</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[</span><span class="se">\&quot;</span><span class="s1">]&#39;</span><span class="p">)</span>
    <span class="n">opened</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">closed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_match</span> <span class="ow">in</span> <span class="n">open_parenthesis</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
        <span class="n">opened</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">_match</span> <span class="ow">in</span> <span class="n">close_parenthesis</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
        <span class="n">closed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">_match</span> <span class="ow">in</span> <span class="n">quotation_marks</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
        <span class="n">quote</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">opened</span> <span class="o">!=</span> <span class="n">closed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Problem with TBL file parentheses (</span><span class="si">{:d}</span><span class="s2"> opening for </span><span class="si">{:d}</span><span class="s2"> &quot;</span>
                        <span class="s2">&quot;closing parentheses)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opened</span><span class="p">,</span> <span class="n">closed</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">quote</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Problem with TBL file, odd number of quotation marks &quot;</span>
                        <span class="s2">&quot;(</span><span class="si">{:d}</span><span class="s2"> quotation marks)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">quote</span><span class="p">))</span></div>



<div class="viewcode-block" id="validate_tbldata">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.librestraints.html#haddock.libs.librestraints.validate_tbldata">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_tbldata</span><span class="p">(</span><span class="n">restraints</span><span class="p">,</span> <span class="n">pcs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># List of selection keywords</span>
    <span class="n">selectors</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;resn&#39;</span><span class="p">,</span> <span class="s1">&#39;atom&#39;</span><span class="p">,</span> <span class="s1">&#39;resi&#39;</span><span class="p">,</span> <span class="s1">&#39;attr&#39;</span><span class="p">,</span> <span class="s1">&#39;segi&#39;</span><span class="p">,</span> <span class="s1">&#39;chem&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;byres&#39;</span><span class="p">,</span> <span class="s1">&#39;not&#39;</span><span class="p">)</span>
    <span class="n">connectors</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;and&#39;</span><span class="p">,</span> <span class="s1">&#39;or&#39;</span><span class="p">,</span> <span class="s1">&#39;not&#39;</span><span class="p">,</span> <span class="s1">&#39;byres&#39;</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">parentmatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;[()]&#39;</span><span class="p">)</span>
    <span class="c1"># Global mode is activated outside any assign statement</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;global&quot;</span>
    <span class="c1"># Remove any carriage return/new line caracters</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">restraints</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Line number</span>
    <span class="n">lnr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Temporary line storage for future output</span>
    <span class="n">tmp_output</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">level</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">s</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">selections</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">postselections</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">numbers</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">types</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">lastassign</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">lnr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Take everything which is before putative &quot;!&quot; (comment) caracter</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)]</span>
        <span class="c1"># Remove whitespaces and merge with previous line if in OR statement</span>
        <span class="c1"># for AIR restraints</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;format&quot;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;postassign&quot;</span>
        <span class="c1"># End of line</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># Check if all &quot;&quot; are closed</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unclosed &quot; at line </span><span class="si">{:d}</span><span class="s1"> for line: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lnr</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;global&quot;</span><span class="p">,</span> <span class="s2">&quot;postglobal&quot;</span><span class="p">):</span>
            <span class="c1"># Start of an assign statement</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;assi&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;postglobal&quot;</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">output</span> <span class="o">+=</span> <span class="n">tmp_output</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;assign&quot;</span>
                <span class="n">selections</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># assign is the only character of the line,check following lines</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># Reset temporary buffer</span>
                <span class="n">tmp_output</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Check for &quot;OR&quot; restraint</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;postglobal&quot;</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;or&quot;</span><span class="p">):</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;postassign&quot;</span>
                <span class="n">selections</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;or&quot;</span><span class="p">):]</span>
                <span class="c1"># Case where &quot;OR&quot; statement is the only one on the line</span>
                <span class="c1"># (rest of selection at the next line)</span>
                <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="c1"># We are not treating an assign params (postglobal) or at the</span>
            <span class="c1"># end (global) and no &quot;OR&quot; restraint is present -&gt; ERROR</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid TBL file: Unknown statement (line </span><span class="si">{:d}</span><span class="s2">): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lnr</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
        <span class="c1"># We check if the selection is made over two lines</span>
        <span class="c1"># (thanks to &quot;segid&quot; keyword)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;postassign&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;segid&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;format&quot;</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">line</span>
                <span class="k">continue</span>

        <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">matched</span><span class="p">:</span>
            <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># We are looking for parenthesis as start of the selections</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;assign&quot;</span><span class="p">,</span> <span class="s2">&quot;postassign&quot;</span><span class="p">):</span>
                <span class="c1"># Ambiguous restraint for two different pairs of atoms</span>
                <span class="c1"># (ex: THR 1 B &lt;-&gt; ALA 2 A OR GLY 2 B &lt;-&gt; ASP 10 A )</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
                    <span class="c1"># We look for an &quot;OR&quot; selection</span>
                    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;postassign&quot;</span><span class="p">:</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;postsel&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;sel&quot;</span>
                    <span class="n">lastassign</span> <span class="o">=</span> <span class="n">lnr</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># Get the structural selections</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;sel&quot;</span><span class="p">,</span> <span class="s2">&quot;postsel&quot;</span><span class="p">):</span>
                <span class="c1"># Detect opening and closing parenthesis</span>
                <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">parentmatch</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;(&quot;</span><span class="p">:</span>
                        <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="c1"># End of the parenthesis content</span>
                    <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;postsel&quot;</span><span class="p">:</span>
                            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;postassign&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;assign&quot;</span>
                        <span class="n">matched</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># print l[:match.start()]</span>
                        <span class="c1"># Get back the parentheses content and check</span>
                        <span class="c1"># for selection keywords</span>
                        <span class="n">idx_connectors</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span>
                        <span class="c1"># We can directly check for the 1st keyword presence</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">syntax_ok</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selectors</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                                    <span class="n">syntax_ok</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">syntax_ok</span> <span class="ow">and</span> <span class="ow">not</span> \
                                    <span class="n">sel</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;byres&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> \
                                    <span class="n">sel</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;not&#39;</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;1) Missing or wrong keyword in-term </span><span class="si">{}</span><span class="s2"> (stopped at line </span><span class="si">{:d}</span><span class="s2">)&quot;</span><span class="o">.</span>
                                                <span class="nb">format</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">lnr</span><span class="p">))</span>
                        <span class="c1"># Get indexes of connectors (AND, OR, etc.)</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">connectors</span><span class="p">:</span>
                            <span class="n">idx_connectors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span>
                                                   <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">sel</span><span class="p">)])</span>
                        <span class="c1"># Flatten the list</span>
                        <span class="n">tmp_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">idx_connectors</span> <span class="k">for</span>
                                    <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
                        <span class="n">idx_connectors</span> <span class="o">=</span> <span class="n">tmp_list</span>
                        <span class="c1"># Check that each connector is followed by a keyword</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx_connectors</span><span class="p">:</span>
                            <span class="n">new_sel</span> <span class="o">=</span> <span class="n">sel</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_sel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">syntax_ok</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selectors</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">new_sel</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                                        <span class="n">syntax_ok</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">break</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">syntax_ok</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Missing or wrong keyword in-term </span><span class="si">{}</span><span class="s2"> (stopped at line </span><span class="si">{:d}</span><span class="s2">)&quot;</span><span class="o">.</span>
                                                    <span class="nb">format</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">lnr</span><span class="p">))</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">sel</span>
                        <span class="n">selections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="c1"># Get the rest of the line</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span>
                        <span class="c1"># Go to the process of the selection</span>
                        <span class="k">break</span>
                <span class="c1"># No parenthesis, we get the whole line</span>
                <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># To avoid multiple blank lines</span>
                        <span class="k">if</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">:</span>
                            <span class="c1"># print repr(l), repr(s), selections</span>
                            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span>
        <span class="c1"># TBD</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;sel&quot;</span><span class="p">,</span> <span class="s2">&quot;postsel&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># Selection parsed for &quot;OR&quot; line</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;postassign&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span> <span class="o">!=</span> <span class="n">postselections</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid TBL file: wrong number of selections: in-term </span><span class="si">{:d}</span><span class="s2">, cross-term </span><span class="si">{:d}</span><span class="s2"> &quot;</span>
                                <span class="s2">&quot;(stopped at line </span><span class="si">{:d}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">postselections</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">selections</span><span class="p">),</span> <span class="n">lnr</span><span class="p">))</span>
            <span class="n">tmp_output</span> <span class="o">+=</span> <span class="s2">&quot; or&quot;</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selections</span><span class="p">:</span>
                <span class="n">tmp_output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="c1"># We let the possibility for other &quot;OR&quot;</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;postglobal&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Define the distance restraints type to adapt the parsing</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;assign&quot;</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;numbers&quot;</span>
            <span class="k">if</span> <span class="n">pcs</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="n">types</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid TBL file: wrong number of selections (must be 5 in PCS mode)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">types</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">types</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; </span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid TBL file: wrong number of selections (can be 5 only in PCS mode)&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">types</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; </span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">check_parenthesis</span><span class="p">(</span><span class="n">restraints</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid TBL file: wrong number of selections (must be 2, 4 or 6)&quot;</span><span class="p">)</span>
            <span class="n">postselections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selections</span><span class="p">)</span>
            <span class="n">numbers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Distance restraints parsing</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;numbers&quot;</span><span class="p">:</span>
            <span class="n">ll</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">):</span>
                <span class="n">tmp_output</span> <span class="o">=</span> <span class="s2">&quot;assign &quot;</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selections</span><span class="p">:</span>
                    <span class="n">tmp_output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">tmp_output</span> <span class="o">=</span> <span class="n">tmp_output</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">numbers</span><span class="p">,</span> <span class="n">types</span><span class="p">):</span>
                    <span class="n">tmp_output</span> <span class="o">+=</span> <span class="n">t</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="n">tmp_output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;postglobal&quot;</span>
    <span class="c1"># &quot;OR&quot; lines have been parsed, we store the selections</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;postglobal&quot;</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="s2">&quot;!</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="n">tmp_output</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;global&quot;</span>
    <span class="c1"># If mode is not back to global, something has not been processed properly</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;global&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid TBL file: Malformed ASSIGN statement (line </span><span class="si">{:d}</span><span class="s2">), use --quick to check for &quot;</span>
                        <span class="s2">&quot;putative syntax issues&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lastassign</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid or empty TBL file&quot;</span><span class="p">)</span>

    <span class="c1"># Remove extra lines before each assign statement</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Remove extra line at the beginning of the file</span>
    <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="passive_from_active_raw">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.librestraints.html#haddock.libs.librestraints.passive_from_active_raw">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">passive_from_active_raw</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">chain_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">surface</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">6.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the passive residues.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    structure : str</span>
<span class="sd">        path to the PDB file</span>

<span class="sd">    active : list</span>
<span class="sd">        List of active residues</span>

<span class="sd">    chain_id : str</span>
<span class="sd">        Chain ID</span>
<span class="sd">    </span>
<span class="sd">    surface : list</span>
<span class="sd">       List of surface residues.</span>

<span class="sd">    radius : float</span>
<span class="sd">        Radius from active residues</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Parse the PDB file</span>
    <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">PDBParser</span><span class="p">(</span><span class="n">QUIET</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_structure</span><span class="p">(</span><span class="s1">&#39;pdb&#39;</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;File not found: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">structure</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">chain_id</span><span class="p">:</span>
            <span class="n">atom_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">chain_id</span><span class="p">]</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atom_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Chain </span><span class="si">{0}</span><span class="s1"> does not exist in the PDB file </span><span class="si">{1}</span><span class="s1">, please enter a proper chain id&#39;</span><span class="o">.</span>
              <span class="nb">format</span><span class="p">(</span><span class="n">chain_id</span><span class="p">,</span> <span class="n">structure</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="n">act_atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">get_coord</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atom_list</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">active</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">surface</span><span class="p">:</span>
            <span class="n">surface</span> <span class="o">=</span> <span class="n">get_surface_resids</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;There was an error while calculating surface residues: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="n">ns</span> <span class="o">=</span> <span class="n">NeighborSearch</span><span class="p">(</span><span class="n">atom_list</span><span class="p">)</span>
    <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">act_atoms</span><span class="p">:</span>
        <span class="n">neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">))</span>  <span class="c1"># HADDOCK used 6.5A as default</span>

    <span class="n">passive_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">passive_list</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">passive_list</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>
    <span class="n">passive_list</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">active</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">passive_list</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_restraint_subset">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.librestraints.html#haddock.libs.librestraints.get_restraint_subset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_restraint_subset</span><span class="p">(</span>
        <span class="n">tblfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">rd_removed_ratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">917</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generator of restraints subsets.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tblfile : str</span>
<span class="sd">        Path to a AIR.tbl file containing restraints.</span>
<span class="sd">    rd_removed_ratio : float</span>
<span class="sd">        Ratio of the number of restraints to remove.</span>
<span class="sd">    seed : int, optional</span>
<span class="sd">        Pseudo-random seed, by default 917</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    subset_restraints: list[str]</span>
<span class="sd">        A subset of the input restraints.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        When random removal ratio is too high and no restraints a kept.</span>
<span class="sd">    ValueError</span>
<span class="sd">        When random removal ratio is too low and all restraints a kept.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Extract all restraints</span>
    <span class="n">input_restraints</span> <span class="o">=</span> <span class="n">extract_restraint_entries</span><span class="p">(</span><span class="n">tblfile</span><span class="p">)</span>
    <span class="c1"># Compute number of restraints to be placed in each file</span>
    <span class="n">_nb_rest_per_file</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">rd_removed_ratio</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_restraints</span><span class="p">)</span>
    <span class="n">nb_rest_per_file</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">_nb_rest_per_file</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="c1"># Indicies</span>
    <span class="n">rest_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_restraints</span><span class="p">)))</span>
    <span class="c1"># Validate that it should result in something OK</span>
    <span class="k">if</span> <span class="n">nb_rest_per_file</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_restraints</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Subset of restraints equal to number of restraints&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">nb_rest_per_file</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Subset of restraints equal to 0&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Forever loop</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Reset seed</span>
            <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="c1"># Obtain a subset of restraints indices</span>
            <span class="n">subset_restraints_ids</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="n">rest_indices</span><span class="p">,</span>
                <span class="n">nb_rest_per_file</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="c1"># Get subset of restraints</span>
            <span class="n">subset_restraints</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;! restraint id </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}{</span><span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="si">}{</span><span class="n">input_restraints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subset_restraints_ids</span>
            <span class="p">]</span>
            <span class="c1"># Return / Yield them</span>
            <span class="k">yield</span> <span class="n">subset_restraints</span>
            <span class="c1"># Increase seed</span>
            <span class="n">seed</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">pass</span></div>



<div class="viewcode-block" id="extract_restraint_entries">
<a class="viewcode-back" href="../../../reference/libs/haddock.libs.librestraints.html#haddock.libs.librestraints.extract_restraint_entries">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_restraint_entries</span><span class="p">(</span><span class="n">tbl_filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read and extract restraints in a AIR.tbl file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tbl_filepath : str</span>
<span class="sd">        Path to a AIR.tbl file containing restraints.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    restraints: list[str]</span>
<span class="sd">        Loaded restraints as a list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">restraints</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">assi</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="c1"># Open the file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tbl_filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
        <span class="c1"># Loop over lines</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
            <span class="c1"># Chekf if the line is starting with `assi` == new restraint def</span>
            <span class="k">if</span> <span class="n">_</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;assi&quot;</span><span class="p">):</span>
                <span class="c1"># See if previous assign statement is not empty </span>
                <span class="k">if</span> <span class="n">assi</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="c1"># Hold this one</span>
                    <span class="n">restraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assi</span><span class="p">)</span>
                <span class="c1"># Reset the assign statement with current line</span>
                <span class="n">assi</span> <span class="o">=</span> <span class="n">_</span>
            <span class="c1"># Skip lines with comments</span>
            <span class="k">elif</span> <span class="n">_</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add line to current assign statement</span>
                <span class="k">if</span> <span class="n">assi</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">assi</span> <span class="o">+=</span> <span class="n">_</span>
    <span class="c1"># Hold last assign statement</span>
    <span class="k">if</span> <span class="n">assi</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">restraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assi</span><span class="p">)</span>
    <span class="c1"># Return loaded restraints as a list of string</span>
    <span class="k">return</span> <span class="n">restraints</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, BonvinLab.
      <span class="lastupdated">Last updated on Sep 04, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>