

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>haddock.modules.analysis.caprieval.capri &mdash; haddock3 3.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=34bb78ad" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=acc74ff5"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            haddock3
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro.html">A brief introduction to HADDOCK3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../INSTALL.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../USAGE.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples.html">Workflow Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../tutorials/index.html">Advanced features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../clients/haddock.clis.html">Command-line interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modules/index.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../testing/index.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributing.html">Contributing to HADDOCK3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../citing.html">Citing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../reference/index.html">Library Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">haddock3</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../haddock.html">haddock</a></li>
          <li class="breadcrumb-item"><a href="../../../modules.html">haddock.modules</a></li>
          <li class="breadcrumb-item"><a href="../../analysis.html">haddock.modules.analysis</a></li>
      <li class="breadcrumb-item active">haddock.modules.analysis.caprieval.capri</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for haddock.modules.analysis.caprieval.capri</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;CAPRI module.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">isnan</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>


<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OPENBLAS_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pdbtools</span><span class="w"> </span><span class="kn">import</span> <span class="n">pdb_segxchain</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial.distance</span><span class="w"> </span><span class="kn">import</span> <span class="n">cdist</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">haddock</span><span class="w"> </span><span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">haddock.core.defaults</span><span class="w"> </span><span class="kn">import</span> <span class="n">CNS_MODULES</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">haddock.core.typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">AtomsDict</span><span class="p">,</span>
    <span class="n">FilePath</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">NDFloat</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">ParamDict</span><span class="p">,</span>
    <span class="n">ParamMap</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">haddock.gear.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">load</span> <span class="k">as</span> <span class="n">read_config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">haddock.libs.libalign</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ALIGNError</span><span class="p">,</span>
    <span class="n">calc_rmsd</span><span class="p">,</span>
    <span class="n">centroid</span><span class="p">,</span>
    <span class="n">check_chains</span><span class="p">,</span>
    <span class="n">get_align</span><span class="p">,</span>
    <span class="n">get_atoms</span><span class="p">,</span>
    <span class="n">kabsch</span><span class="p">,</span>
    <span class="n">load_coords</span><span class="p">,</span>
    <span class="n">make_range</span><span class="p">,</span>
    <span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">haddock.libs.libio</span><span class="w"> </span><span class="kn">import</span> <span class="n">write_dic_to_file</span><span class="p">,</span> <span class="n">write_nested_dic_to_file</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">haddock.libs.libontology</span><span class="w"> </span><span class="kn">import</span> <span class="n">PDBFile</span><span class="p">,</span> <span class="n">PDBPath</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">haddock.modules</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_module_steps_folders</span>


<span class="n">WEIGHTS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;w_elec&quot;</span><span class="p">,</span> <span class="s2">&quot;w_vdw&quot;</span><span class="p">,</span> <span class="s2">&quot;w_desolv&quot;</span><span class="p">,</span> <span class="s2">&quot;w_bsa&quot;</span><span class="p">,</span> <span class="s2">&quot;w_air&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="get_previous_cns_step">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.get_previous_cns_step">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_previous_cns_step</span><span class="p">(</span><span class="n">sel_steps</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">st_order</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the previous CNS step.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    run_path : Path</span>
<span class="sd">        Path to the run folder.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cns_step : str</span>
<span class="sd">        Name of the CNS step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get the previous CNS step</span>
    <span class="n">cns_step</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># just to be careful, remove steps with more than one underscore</span>
    <span class="n">sel_steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">step</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">sel_steps</span> <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">st_order</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_steps</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># loop</span>
    <span class="k">while</span> <span class="n">mod</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">st_name</span> <span class="o">=</span> <span class="n">sel_steps</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">st_name</span> <span class="ow">in</span> <span class="n">CNS_MODULES</span><span class="p">:</span>
            <span class="n">cns_step</span> <span class="o">=</span> <span class="n">sel_steps</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="n">mod</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">cns_step</span></div>



<div class="viewcode-block" id="save_scoring_weights">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.save_scoring_weights">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_scoring_weights</span><span class="p">(</span><span class="n">cns_step</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save the scoring weights in a json file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cns_step : str</span>
<span class="sd">        Name of the CNS step.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scoring_params_fname : Path</span>
<span class="sd">        Path to the json file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cns_params</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">,</span> <span class="n">cns_step</span><span class="p">,</span> <span class="s2">&quot;params.cfg&quot;</span><span class="p">))</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cns_params</span><span class="p">[</span><span class="s2">&quot;final_cfg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">scoring_pars</span> <span class="o">=</span> <span class="p">{</span><span class="n">kv</span><span class="p">:</span> <span class="n">cns_params</span><span class="p">[</span><span class="s2">&quot;final_cfg&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="n">kv</span><span class="p">]</span> <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">WEIGHTS</span><span class="p">}</span>

    <span class="n">scoring_params_fname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;weights_params.json&quot;</span><span class="p">)</span>
    <span class="c1"># write json file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scoring_params_fname</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jsonf</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
            <span class="n">scoring_pars</span><span class="p">,</span>
            <span class="n">jsonf</span><span class="p">,</span>
            <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">scoring_params_fname</span></div>



<div class="viewcode-block" id="load_contacts">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.load_contacts">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_contacts</span><span class="p">(</span>
    <span class="n">pdb_f</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">PDBFile</span><span class="p">],</span>
    <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="n">numbering_dic</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model2ref_chain_dict</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load residue-based contacts.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pdb_f : PosixPath or :py:class:`haddock.libs.libontology.PDBFile`</span>
<span class="sd">        PDB file of the model to have its atoms identified</span>
<span class="sd">    cutoff : float, optional</span>
<span class="sd">        Cutoff distance for the interface identification.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    set(con_list) : set</span>
<span class="sd">        set of unique contacts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdb_f</span><span class="p">,</span> <span class="n">PDBFile</span><span class="p">):</span>
        <span class="n">pdb_f</span> <span class="o">=</span> <span class="n">pdb_f</span><span class="o">.</span><span class="n">rel_path</span>
    <span class="c1"># get also side chains atoms</span>
    <span class="n">atoms</span> <span class="o">=</span> <span class="n">get_atoms</span><span class="p">(</span><span class="n">pdb_f</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ref_coord_dic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_coords</span><span class="p">(</span>
        <span class="n">pdb_f</span><span class="p">,</span>
        <span class="n">atoms</span><span class="p">,</span>
        <span class="n">numbering_dic</span><span class="o">=</span><span class="n">numbering_dic</span><span class="p">,</span>
        <span class="n">model2ref_chain_dict</span><span class="o">=</span><span class="n">model2ref_chain_dict</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># create coordinate arrays</span>
    <span class="n">coord_arrays</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">NDFloat</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">coord_ids</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ref_coord_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">coord_arrays</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># initialize lists</span>
            <span class="n">coord_arrays</span><span class="p">[</span><span class="n">chain</span><span class="p">],</span> <span class="n">coord_ids</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>  <span class="c1"># type: ignore</span>
        <span class="n">coord_arrays</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref_coord_dic</span><span class="p">[</span><span class="n">atom</span><span class="p">])</span>  <span class="c1"># type: ignore</span>
        <span class="n">coord_ids</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># only the resid is appended</span>
    <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">coord_arrays</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">coord_arrays</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coord_arrays</span><span class="p">[</span><span class="n">chain</span><span class="p">])</span>

    <span class="c1"># combinations of chains</span>
    <span class="n">unique_chain_combs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">coord_arrays</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="mi">2</span><span class="p">))</span>

    <span class="c1"># calculating contacts</span>
    <span class="n">con_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">unique_chain_combs</span><span class="p">:</span>
        <span class="c1"># cycling over each coordinate of the first chain</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">coord_arrays</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">s_xyz</span> <span class="o">=</span> <span class="n">coord_arrays</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">s_cid</span> <span class="o">=</span> <span class="n">coord_ids</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">s</span><span class="p">]</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">cdist</span><span class="p">(</span><span class="n">s_xyz</span><span class="p">,</span> <span class="n">coord_arrays</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">npw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dist</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">dist</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">con</span> <span class="o">=</span> <span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s_cid</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">coord_ids</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">npw</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]])</span>
                <span class="n">con_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">con_list</span><span class="p">)</span></div>



<div class="viewcode-block" id="CAPRI">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.CAPRI">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CAPRI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CAPRI class.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">identificator</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PDBPath</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">reference</span><span class="p">:</span> <span class="n">PDBPath</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">ParamMap</span><span class="p">,</span>
        <span class="n">ref_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the class.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        identificator : int</span>
<span class="sd">            The identificator of the object.</span>
<span class="sd">        model : PosixPath or :py:class:`haddock.libs.libontology.PDBFile`</span>
<span class="sd">            The model to be evaluated.</span>
<span class="sd">        path : Path</span>
<span class="sd">            Reference that defines where output should be saved.</span>
<span class="sd">        reference : PosixPath or :py:class:`haddock.libs.libontology.PDBFile`</span>
<span class="sd">            The reference structure.</span>
<span class="sd">        params : dict</span>
<span class="sd">            The parameters for the CAPRI evaluation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="n">reference</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">PDBFile</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">PDBFile</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">md5</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">md5</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">md5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">score</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">irmsd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lrmsd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ilrmsd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dockq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmsd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allatoms</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;allatoms&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_atoms</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allatoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_chain</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;receptor_chain&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_chains</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;ligand_chains&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model2ref_numbering</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model2ref_chain_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_ss_fname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;capri_ss_</span><span class="si">{</span><span class="n">identificator</span><span class="si">}</span><span class="s2">.tsv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_clt_fname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;capri_clt_</span><span class="si">{</span><span class="n">identificator</span><span class="si">}</span><span class="s2">.tsv&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_ss_fname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identificator</span> <span class="o">=</span> <span class="n">identificator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core_model_idx</span> <span class="o">=</span> <span class="n">identificator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_id</span> <span class="o">=</span> <span class="n">ref_id</span>

<div class="viewcode-block" id="CAPRI.calc_irmsd">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.CAPRI.calc_irmsd">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_irmsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the I-RMSD.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cutoff : float</span>
<span class="sd">            The cutoff distance for the intermolecular contacts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Identify reference interface</span>
        <span class="n">ref_interface_resdic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_interface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_interface_resdic</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No reference interface found&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Load interface coordinates</span>
            <span class="n">ref_coord_dic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_coords</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">ref_interface_resdic</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mod_coord_dic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_coords</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span>
                    <span class="n">ref_interface_resdic</span><span class="p">,</span>
                    <span class="n">numbering_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model2ref_numbering</span><span class="p">,</span>
                    <span class="n">model2ref_chain_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model2ref_chain_dict</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">ALIGNError</span> <span class="k">as</span> <span class="n">alignerror</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">alignerror</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># Here _coord_dic keys are matched</span>
            <span class="c1">#  and formatted as (chain, resnum, atom)</span>
            <span class="c1">#  we will use atoms that are present in both</span>
            <span class="n">P</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ref_coord_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">mod_coord_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ref_xyz</span> <span class="o">=</span> <span class="n">ref_coord_dic</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">mod_xyz</span> <span class="o">=</span> <span class="n">mod_coord_dic</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

                <span class="n">Q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref_xyz</span><span class="p">)</span>
                <span class="n">P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mod_xyz</span><span class="p">)</span>

            <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
            <span class="c1"># write_coords(&quot;model.pdb&quot;, P)</span>
            <span class="c1"># write_coords(&quot;ref.pdb&quot;, Q)</span>

            <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
            <span class="n">U</span> <span class="o">=</span> <span class="n">kabsch</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">irmsd</span> <span class="o">=</span> <span class="n">calc_rmsd</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span></div>

            <span class="c1"># write_coords(&quot;model_aln.pdb&quot;, P)</span>
            <span class="c1"># write_coords(&quot;ref_aln.pdb&quot;, Q)</span>

<div class="viewcode-block" id="CAPRI.calc_lrmsd">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.CAPRI.calc_lrmsd">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_lrmsd</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the L-RMSD.&quot;&quot;&quot;</span>
        <span class="n">ref_coord_dic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mod_coord_dic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_coords</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span>
                <span class="n">numbering_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model2ref_numbering</span><span class="p">,</span>
                <span class="n">model2ref_chain_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model2ref_chain_dict</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">ALIGNError</span> <span class="k">as</span> <span class="n">alignerror</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">alignerror</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">Q</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Note: this MUST be sorted since we will use the indexes to</span>
        <span class="c1">#  separate between receptor and ligand coordinates</span>
        <span class="n">intersection</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ref_coord_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">mod_coord_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">chain_ranges</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">segment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">intersection</span><span class="p">):</span>
            <span class="n">chain</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">segment</span>
            <span class="k">if</span> <span class="n">chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chain_ranges</span><span class="p">:</span>
                <span class="n">chain_ranges</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">chain_ranges</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">chain_ranges</span> <span class="o">=</span> <span class="n">make_range</span><span class="p">(</span><span class="n">chain_ranges</span><span class="p">)</span>
        <span class="n">obs_chains</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain_ranges</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="c1"># observed chains</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs_chains</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not enough chains for calculating lrmsd&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r_chain</span><span class="p">,</span> <span class="n">l_chains</span> <span class="o">=</span> <span class="n">check_chains</span><span class="p">(</span><span class="n">obs_chains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_chain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_chains</span><span class="p">)</span>
            <span class="n">r_start</span><span class="p">,</span> <span class="n">r_end</span> <span class="o">=</span> <span class="n">chain_ranges</span><span class="p">[</span><span class="n">r_chain</span><span class="p">]</span>
            <span class="n">l_starts</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain_ranges</span><span class="p">[</span><span class="n">_l</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_l</span> <span class="ow">in</span> <span class="n">l_chains</span><span class="p">]</span>
            <span class="n">l_ends</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain_ranges</span><span class="p">[</span><span class="n">_l</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_l</span> <span class="ow">in</span> <span class="n">l_chains</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">intersection</span><span class="p">:</span>
                <span class="n">ref_xyz</span> <span class="o">=</span> <span class="n">ref_coord_dic</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="n">mod_xyz</span> <span class="o">=</span> <span class="n">mod_coord_dic</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

                <span class="n">Q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref_xyz</span><span class="p">)</span>
                <span class="n">P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mod_xyz</span><span class="p">)</span>

            <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

            <span class="c1"># write_coords(&quot;ref_first.pdb&quot;, Q)</span>
            <span class="c1"># write_coords(&quot;model_first.pdb&quot;, P)</span>

            <span class="c1"># get receptor and ligand coordinates</span>
            <span class="n">Q_r_first</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="n">r_start</span> <span class="p">:</span> <span class="n">r_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">P_r_first</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">r_start</span> <span class="p">:</span> <span class="n">r_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="c1"># write_coords(&quot;ref_r_first.pdb&quot;, Q_r_first)</span>
            <span class="c1"># write_coords(&quot;model_r_first.pdb&quot;, P_r_first)</span>
            <span class="c1"># Q_l_first = Q[l_start: l_end + 1]</span>
            <span class="c1"># P_l_first = P[l_start: l_end + 1]</span>
            <span class="c1"># write_coords(&quot;ref_l_first.pdb&quot;, Q_l_first)</span>
            <span class="c1"># write_coords(&quot;model_l_first.pdb&quot;, P_l_first)</span>

            <span class="c1"># move to the origin of the receptor</span>

            <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">(</span><span class="n">Q_r_first</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">(</span><span class="n">P_r_first</span><span class="p">)</span>

            <span class="c1"># get receptor coordinates</span>
            <span class="n">Q_r</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[</span><span class="n">r_start</span> <span class="p">:</span> <span class="n">r_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">P_r</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">r_start</span> <span class="p">:</span> <span class="n">r_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Center receptors and get rotation matrix</span>
            <span class="c1"># Q_r = Q_r - centroid(Q_r)</span>
            <span class="c1"># P_r = P_r - centroid(P_r)</span>
            <span class="c1"># write_coords(&quot;ref_r_centr.pdb&quot;, Q_r)</span>
            <span class="c1"># write_coords(&quot;model_r_centr.pdb&quot;, P_r)</span>

            <span class="n">U_r</span> <span class="o">=</span> <span class="n">kabsch</span><span class="p">(</span><span class="n">P_r</span><span class="p">,</span> <span class="n">Q_r</span><span class="p">)</span>

            <span class="c1"># Apply rotation to complex</span>
            <span class="c1">#  - complex are now aligned by the receptor</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">U_r</span><span class="p">)</span>

            <span class="c1"># write_coords(&quot;ref.pdb&quot;, Q)</span>
            <span class="c1"># write_coords(&quot;model.pdb&quot;, P)</span>

            <span class="c1"># Identify ligand coordinates concatenating all the ligand chains</span>
            <span class="n">Q_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">P_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">l_start</span><span class="p">,</span> <span class="n">l_end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_starts</span><span class="p">,</span> <span class="n">l_ends</span><span class="p">):</span>
                <span class="n">Q_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Q_l</span><span class="p">,</span> <span class="n">Q</span><span class="p">[</span><span class="n">l_start</span> <span class="p">:</span> <span class="n">l_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="n">P_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">P_l</span><span class="p">,</span> <span class="n">P</span><span class="p">[</span><span class="n">l_start</span> <span class="p">:</span> <span class="n">l_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="c1"># Q_l = Q[l_start: l_end + 1]</span>
            <span class="c1"># P_l = P[l_start: l_end + 1]</span>

            <span class="c1"># write_coords(&quot;ref_l.pdb&quot;, Q_l)</span>
            <span class="c1"># write_coords(&quot;model_l.pdb&quot;, P_l)</span>

            <span class="c1"># Calculate the RMSD of the ligands</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lrmsd</span> <span class="o">=</span> <span class="n">calc_rmsd</span><span class="p">(</span><span class="n">P_l</span><span class="p">,</span> <span class="n">Q_l</span><span class="p">)</span></div>


<div class="viewcode-block" id="CAPRI.calc_ilrmsd">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.CAPRI.calc_ilrmsd">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_ilrmsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the Interface Ligand RMSD.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cutoff : float</span>
<span class="sd">            The cutoff distance for the intermolecular contacts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Identify interface</span>
        <span class="n">ref_interface_resdic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_interface</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
        <span class="c1"># Load interface coordinates</span>

        <span class="n">ref_int_coord_dic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_coords</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">ref_interface_resdic</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mod_int_coord_dic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_coords</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span>
                <span class="n">ref_interface_resdic</span><span class="p">,</span>
                <span class="n">numbering_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model2ref_numbering</span><span class="p">,</span>
                <span class="n">model2ref_chain_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model2ref_chain_dict</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">ALIGNError</span> <span class="k">as</span> <span class="n">alignerror</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">alignerror</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># write_coord_dic(&quot;ref.pdb&quot;, ref_int_coord_dic)</span>
        <span class="c1"># write_coord_dic(&quot;model.pdb&quot;, mod_int_coord_dic)</span>

        <span class="c1"># find atoms present in both interfaces</span>
        <span class="n">Q_int</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">P_int</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">common_keys</span> <span class="o">=</span> <span class="n">ref_int_coord_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">mod_int_coord_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">common_keys</span><span class="p">):</span>
            <span class="n">ref_xyz</span> <span class="o">=</span> <span class="n">ref_int_coord_dic</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">mod_xyz</span> <span class="o">=</span> <span class="n">mod_int_coord_dic</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="n">Q_int</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref_xyz</span><span class="p">)</span>
            <span class="n">P_int</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mod_xyz</span><span class="p">)</span>

        <span class="n">Q_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Q_int</span><span class="p">)</span>
        <span class="n">P_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">P_int</span><span class="p">)</span>

        <span class="c1"># write_coords(&quot;ref.pdb&quot;, Q_int)</span>
        <span class="c1"># write_coords(&quot;model.pdb&quot;, P_int)</span>

        <span class="n">chain_ranges</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">segment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">common_keys</span><span class="p">)):</span>
            <span class="n">chain</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">segment</span>
            <span class="k">if</span> <span class="n">chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chain_ranges</span><span class="p">:</span>
                <span class="n">chain_ranges</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">chain_ranges</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">chain_ranges</span> <span class="o">=</span> <span class="n">make_range</span><span class="p">(</span><span class="n">chain_ranges</span><span class="p">)</span>
        <span class="n">obs_chains</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain_ranges</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="c1"># observed chains</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs_chains</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Not enough chains for calculating ilrmsd&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r_chain</span><span class="p">,</span> <span class="n">l_chains</span> <span class="o">=</span> <span class="n">check_chains</span><span class="p">(</span><span class="n">obs_chains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_chain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_chains</span><span class="p">)</span>
            <span class="n">r_start</span><span class="p">,</span> <span class="n">r_end</span> <span class="o">=</span> <span class="n">chain_ranges</span><span class="p">[</span><span class="n">r_chain</span><span class="p">]</span>
            <span class="n">l_starts</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain_ranges</span><span class="p">[</span><span class="n">l_chain</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l_chain</span> <span class="ow">in</span> <span class="n">l_chains</span><span class="p">]</span>
            <span class="n">l_ends</span> <span class="o">=</span> <span class="p">[</span><span class="n">chain_ranges</span><span class="p">[</span><span class="n">l_chain</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">l_chain</span> <span class="ow">in</span> <span class="n">l_chains</span><span class="p">]</span>

            <span class="c1"># write_coords(&quot;ref.pdb&quot;, Q)</span>
            <span class="c1"># write_coords(&quot;model.pdb&quot;, P)</span>

            <span class="c1"># put system at origin of the receptor interface</span>
            <span class="n">Q_r_int</span> <span class="o">=</span> <span class="n">Q_int</span><span class="p">[</span><span class="n">r_start</span> <span class="p">:</span> <span class="n">r_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">P_r_int</span> <span class="o">=</span> <span class="n">P_int</span><span class="p">[</span><span class="n">r_start</span> <span class="p">:</span> <span class="n">r_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">Q_int</span> <span class="o">=</span> <span class="n">Q_int</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">(</span><span class="n">Q_r_int</span><span class="p">)</span>
            <span class="n">P_int</span> <span class="o">=</span> <span class="n">P_int</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">(</span><span class="n">P_r_int</span><span class="p">)</span>
            <span class="c1"># put interfaces at the origin</span>

            <span class="c1"># find the rotation that minimizes the receptor interface rmsd</span>
            <span class="n">Q_r_int</span> <span class="o">=</span> <span class="n">Q_int</span><span class="p">[</span><span class="n">r_start</span> <span class="p">:</span> <span class="n">r_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">P_r_int</span> <span class="o">=</span> <span class="n">P_int</span><span class="p">[</span><span class="n">r_start</span> <span class="p">:</span> <span class="n">r_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">U_int</span> <span class="o">=</span> <span class="n">kabsch</span><span class="p">(</span><span class="n">P_r_int</span><span class="p">,</span> <span class="n">Q_r_int</span><span class="p">)</span>
            <span class="n">P_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P_int</span><span class="p">,</span> <span class="n">U_int</span><span class="p">)</span>
            <span class="c1"># just for checks.</span>
            <span class="c1"># the interface rmsd for the rec interface should be almost zero</span>
            <span class="c1"># Q_r_int = Q_int[r_start: r_end + 1]</span>
            <span class="c1"># P_r_int = P_int[r_start: r_end + 1]</span>
            <span class="c1"># r_rmsd = calc_rmsd(Q_r_int, P_int[r_start: r_end + 1])</span>
            <span class="c1"># print(r_rmsd)</span>
            <span class="c1"># Identify ligand coordinates concatenating all the ligand chains</span>
            <span class="n">Q_l_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">P_l_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">l_start</span><span class="p">,</span> <span class="n">l_end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l_starts</span><span class="p">,</span> <span class="n">l_ends</span><span class="p">):</span>
                <span class="n">Q_l_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Q_l_int</span><span class="p">,</span> <span class="n">Q_int</span><span class="p">[</span><span class="n">l_start</span> <span class="p">:</span> <span class="n">l_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="n">P_l_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">P_l_int</span><span class="p">,</span> <span class="n">P_int</span><span class="p">[</span><span class="n">l_start</span> <span class="p">:</span> <span class="n">l_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="c1"># prior to multibody:</span>
            <span class="c1"># Q_l_int = Q_int[l_start: l_end + 1]</span>
            <span class="c1"># P_l_int = P_int[l_start: l_end + 1]</span>
            <span class="c1"># write_coords(&quot;ref_l_int_fin.pdb&quot;, Q_l_int)</span>
            <span class="c1"># write_coords(&quot;mod_l_int_fin.pdb&quot;, P_l_int)</span>

            <span class="c1"># # this will be the interface-ligand-rmsd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ilrmsd</span> <span class="o">=</span> <span class="n">calc_rmsd</span><span class="p">(</span><span class="n">P_l_int</span><span class="p">,</span> <span class="n">Q_l_int</span><span class="p">)</span></div>


<div class="viewcode-block" id="CAPRI.calc_fnat">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.CAPRI.calc_fnat">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_fnat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the frequency of native contacts.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cutoff : float</span>
<span class="sd">            The cutoff distance for the intermolecular contacts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ref_contacts</span> <span class="o">=</span> <span class="n">load_contacts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_contacts</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">model_contacts</span> <span class="o">=</span> <span class="n">load_contacts</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                    <span class="n">cutoff</span><span class="p">,</span>
                    <span class="n">numbering_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model2ref_numbering</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                    <span class="n">model2ref_chain_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model2ref_chain_dict</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">ALIGNError</span> <span class="k">as</span> <span class="n">alignerror</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">alignerror</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">intersection</span> <span class="o">=</span> <span class="n">ref_contacts</span> <span class="o">&amp;</span> <span class="n">model_contacts</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fnat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ref_contacts</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No reference contacts found&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="CAPRI.calc_global_rmsd">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.CAPRI.calc_global_rmsd">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_global_rmsd</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the full structure RMSD.&quot;&quot;&quot;</span>
        <span class="c1"># Load reference atomic coordinates</span>
        <span class="n">ref_coord_dic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_coords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="c1"># Load model atomic coordinates</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">model_coord_dic</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_coords</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span>
                <span class="n">numbering_dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model2ref_numbering</span><span class="p">,</span>
                <span class="n">model2ref_chain_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model2ref_chain_dict</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">ALIGNError</span> <span class="k">as</span> <span class="n">alignerror</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">alignerror</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Obtain list of coordinates</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ref_coord_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">model_coord_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">ref_xyz</span> <span class="o">=</span> <span class="n">ref_coord_dic</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">mod_xyz</span> <span class="o">=</span> <span class="n">model_coord_dic</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">Q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref_xyz</span><span class="p">)</span>
            <span class="n">P</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mod_xyz</span><span class="p">)</span>
        <span class="c1"># Cast indo array</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="c1"># Center to 0</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="c1"># Obtain rotation matrix</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">kabsch</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span>
        <span class="c1"># Rotate model (the actual superimposition)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span>
        <span class="c1"># Compute full RMSD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmsd</span> <span class="o">=</span> <span class="n">calc_rmsd</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">)</span></div>


<div class="viewcode-block" id="CAPRI.calc_dockq">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.CAPRI.calc_dockq">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_dockq</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the DockQ metric.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dockq</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dockq</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fnat</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">irmsd</span><span class="p">:</span>
            <span class="n">irmsd_denom</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irmsd</span> <span class="o">/</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irmsd</span> <span class="o">/</span> <span class="mf">1.5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dockq</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">irmsd_denom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lrmsd</span><span class="p">:</span>
            <span class="n">lrmsd_denom</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrmsd</span> <span class="o">/</span> <span class="mf">8.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrmsd</span> <span class="o">/</span> <span class="mf">8.5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dockq</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">lrmsd_denom</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span></div>


<div class="viewcode-block" id="CAPRI.has_cluster_info">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.CAPRI.has_cluster_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_cluster_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check wether this object contains cluster information.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if this object contains cluster information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">has_cluster_info</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">clt_id</span><span class="p">:</span>
            <span class="n">has_cluster_info</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">has_cluster_info</span></div>


<div class="viewcode-block" id="CAPRI.run">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.CAPRI.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;CAPRI&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the CAPRI metrics.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">align_func</span> <span class="o">=</span> <span class="n">get_align</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;alignment_method&quot;</span><span class="p">],</span>
                <span class="n">lovoalign_exec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;lovoalign_exec&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model2ref_numbering</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model2ref_chain_dict</span> <span class="o">=</span> <span class="n">align_func</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">ALIGNError</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Alignment failed between </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reference</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">, skipping...&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># print(f&quot;model2ref_numbering {self.model2ref_numbering}&quot;)</span>
        <span class="c1"># print(f&quot;model2ref_chain_dict {self.model2ref_chain_dict}&quot;)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;fnat&quot;</span><span class="p">]:</span>
            <span class="n">fnat_cutoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;fnat_cutoff&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_fnat</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="n">fnat_cutoff</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;irmsd&quot;</span><span class="p">]:</span>
            <span class="n">irmsd_cutoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;irmsd_cutoff&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_irmsd</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="n">irmsd_cutoff</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;lrmsd&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_lrmsd</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;ilrmsd&quot;</span><span class="p">]:</span>
            <span class="n">ilrmsd_cutoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;irmsd_cutoff&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_ilrmsd</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="n">ilrmsd_cutoff</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;dockq&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_dockq</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;global_rmsd&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_global_rmsd</span><span class="p">()</span>

        <span class="c1"># The scheduler will use the return of the `run` method as the output of the tasks</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;dockq&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dockq</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">dockq</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dockq</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dockq</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;fnat&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fnat</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">fnat</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnat</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">fnat</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;ilrmsd&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ilrmsd</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">ilrmsd</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilrmsd</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ilrmsd</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;lrmsd&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrmsd</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">lrmsd</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lrmsd</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">lrmsd</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;irmsd&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irmsd</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">irmsd</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">irmsd</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">irmsd</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;global_rmsd&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmsd</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">rmsd</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmsd</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">rmsd</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;dockq&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dockq</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">dockq</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dockq</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">dockq</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;fnat&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fnat</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">fnat</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnat</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">fnat</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;ilrmsd&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ilrmsd</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">ilrmsd</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ilrmsd</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">ilrmsd</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;lrmsd&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrmsd</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">lrmsd</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lrmsd</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">lrmsd</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;irmsd&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">irmsd</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">irmsd</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">irmsd</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">irmsd</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;global_rmsd&quot;</span><span class="p">]</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="p">(</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmsd</span><span class="p">)</span> <span class="ow">or</span> <span class="n">isnan</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">rmsd</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmsd</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">rmsd</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_load_atoms</span><span class="p">(</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">PDBPath</span><span class="p">,</span>
        <span class="n">reference</span><span class="p">:</span> <span class="n">PDBPath</span><span class="p">,</span>
        <span class="n">full</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AtomsDict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load atoms from a model and reference.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : PosixPath or :py:class:`haddock.libs.libontology.PDBFile`</span>
<span class="sd">            PDB file of the model to have its atoms identified</span>
<span class="sd">        reference : PosixPath or :py:class:`haddock.libs.libontology.PDBFile`</span>
<span class="sd">            PDB file of the model to have its atoms identified</span>
<span class="sd">        full : bool</span>
<span class="sd">            If False, only backbone atoms will be retrieved, otherwise all atoms</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        atom_dic : dict</span>
<span class="sd">            Dictionary containing atoms observed in model and reference</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_atoms</span> <span class="o">=</span> <span class="n">get_atoms</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">)</span>
        <span class="n">reference_atoms</span> <span class="o">=</span> <span class="n">get_atoms</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">)</span>
        <span class="n">atoms_dict</span><span class="p">:</span> <span class="n">AtomsDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">atoms_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_atoms</span><span class="p">)</span>
        <span class="n">atoms_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reference_atoms</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">atoms_dict</span>

<div class="viewcode-block" id="CAPRI.identify_interface">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.CAPRI.identify_interface">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">identify_interface</span><span class="p">(</span>
        <span class="n">pdb_f</span><span class="p">:</span> <span class="n">PDBPath</span><span class="p">,</span>
        <span class="n">cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify the interface.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pdb_f : PosixPath or :py:class:`haddock.libs.libontology.PDBFile`</span>
<span class="sd">            PDB file of the model to have its atoms identified</span>
<span class="sd">        cutoff : float, optional</span>
<span class="sd">            Cutoff distance for the interface identification.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        interface_resdic : dict[str, list[int]]</span>
<span class="sd">            Dictionary holding list of interface residues ids for each chains.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdb_f</span><span class="p">,</span> <span class="n">PDBFile</span><span class="p">):</span>
            <span class="n">pdb_f</span> <span class="o">=</span> <span class="n">pdb_f</span><span class="o">.</span><span class="n">rel_path</span>

        <span class="n">interface_resdic</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">contacts</span> <span class="o">=</span> <span class="n">load_contacts</span><span class="p">(</span><span class="n">pdb_f</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">:</span>
            <span class="n">first_chain</span><span class="p">,</span> <span class="n">first_resid</span><span class="p">,</span> <span class="n">sec_chain</span><span class="p">,</span> <span class="n">sec_resid</span> <span class="o">=</span> <span class="n">contact</span>

            <span class="k">if</span> <span class="n">first_chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interface_resdic</span><span class="p">:</span>
                <span class="n">interface_resdic</span><span class="p">[</span><span class="n">first_chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">sec_chain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interface_resdic</span><span class="p">:</span>
                <span class="n">interface_resdic</span><span class="p">[</span><span class="n">sec_chain</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">first_resid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interface_resdic</span><span class="p">[</span><span class="n">first_chain</span><span class="p">]:</span>
                <span class="n">interface_resdic</span><span class="p">[</span><span class="n">first_chain</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_resid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sec_resid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">interface_resdic</span><span class="p">[</span><span class="n">sec_chain</span><span class="p">]:</span>
                <span class="n">interface_resdic</span><span class="p">[</span><span class="n">sec_chain</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sec_resid</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">interface_resdic</span></div>


<div class="viewcode-block" id="CAPRI.add_chain_from_segid">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.CAPRI.add_chain_from_segid">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_chain_from_segid</span><span class="p">(</span><span class="n">pdb_path</span><span class="p">:</span> <span class="n">PDBPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replace the chainID with the segID.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pdb_path : PosixPath or :py:class:`haddock.libs.libontology.PDBFile`</span>
<span class="sd">            PDB file to be replaced</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pdb_path</span><span class="p">,</span> <span class="n">PDBFile</span><span class="p">):</span>
            <span class="n">pdb_path</span> <span class="o">=</span> <span class="n">pdb_path</span><span class="o">.</span><span class="n">rel_path</span>
        <span class="n">temp_f</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w+t&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdb_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pdb_segxchain</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fh</span><span class="p">)):</span>
                <span class="n">temp_f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">temp_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># REPLACE!</span>
        <span class="n">new_pdb_path</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">temp_f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pdb_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_pdb_path</span></div>
</div>



<div class="viewcode-block" id="rank_according_to_score">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.rank_according_to_score">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">rank_according_to_score</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ParamDict</span><span class="p">],</span> <span class="n">sort_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sort_ascending</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ParamDict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ranks a dictionary of data based on a specified sort key and sort order,</span>
<span class="sd">    and assigns a rank to each entry based on its &#39;score&#39; attribute.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (dict[int, ParamDict]): Dictionary where each key is an index and each</span>
<span class="sd">                                     value is a ParamDict containing data attributes.</span>
<span class="sd">        sort_key (str): Key by which to sort the data within the ParamDict.</span>
<span class="sd">                        Must correspond to a valid attribute in ParamDict.</span>
<span class="sd">        sort_ascending (bool): If True, sorts the data in ascending order based on</span>
<span class="sd">                               the sort_key; if False, sorts in descending order.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[int, ParamDict]: A new dictionary where entries are sorted according</span>
<span class="sd">                              to the sort_key and optionally sorted order. Each entry</span>
<span class="sd">                              also includes a &#39;caprieval_rank&#39; attribute indicating</span>
<span class="sd">                              its rank based on the &#39;score&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">score_rankkey_values</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">score_rankkey_values</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">score_rankkey_values</span><span class="p">):</span>
        <span class="n">data_idx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">k</span>
        <span class="n">data</span><span class="p">[</span><span class="n">data_idx</span><span class="p">][</span><span class="s2">&quot;caprieval_rank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Sort according to the sort key</span>
    <span class="n">rankkey_values</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">sort_key</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">rankkey_values</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">sort_ascending</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">data_idx</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rankkey_values</span><span class="p">):</span>
        <span class="n">_data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data_idx</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">_data</span>

    <span class="k">return</span> <span class="n">_data</span></div>



<div class="viewcode-block" id="extract_models_best_references">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.extract_models_best_references">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_models_best_references</span><span class="p">(</span><span class="n">capri_objects</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CAPRI</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">CAPRI</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract best reference for each input model.</span>

<span class="sd">    Same input models are combined and best reference is later found by</span>
<span class="sd">    sorting the CAPRI objects. Only the best performing CAPRI object is</span>
<span class="sd">    kept and returned.</span>
<span class="sd">    This step was implemented to handle comparisons against multiple refs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    capri_objects : list[CAPRI]</span>
<span class="sd">        List of CAPRI object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    selected_capri_objects : list[CAPRI]</span>
<span class="sd">        List of selected best CAPIR object for each model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Group results by models</span>
    <span class="n">by_model_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">CAPRI</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">capri</span> <span class="ow">in</span> <span class="n">capri_objects</span><span class="p">:</span>
        <span class="n">model_data</span> <span class="o">=</span> <span class="n">by_model_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">capri</span><span class="o">.</span><span class="n">identificator</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">model_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">capri</span><span class="p">)</span>
    <span class="c1"># Finds best performances for each model</span>
    <span class="n">selected_capri_objects</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CAPRI</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Loop over model referneces performances</span>
    <span class="k">for</span> <span class="n">references_perfs</span> <span class="ow">in</span> <span class="n">by_model_data</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="c1"># Sort them using built in __eq__ and __lt__ CAPRI methods</span>
        <span class="n">sorted_perfs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">references_perfs</span><span class="p">)</span>
        <span class="c1"># Select first on (best)</span>
        <span class="n">best_perf</span> <span class="o">=</span> <span class="n">sorted_perfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Hold that guy</span>
        <span class="n">selected_capri_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_perf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">selected_capri_objects</span></div>



<div class="viewcode-block" id="extract_data_from_capri_class">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.extract_data_from_capri_class">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_data_from_capri_class</span><span class="p">(</span>
    <span class="n">capri_objects</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">CAPRI</span><span class="p">],</span>
    <span class="n">sort_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">sort_ascending</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">output_fname</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">add_reference_id</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ParamDict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extracts data attributes from a list of CAPRI objects into a structured</span>
<span class="sd">    dictionary, optionally sorts the data based on a specified key, and writes</span>
<span class="sd">    the sorted data to a file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    capri_objects : list[CAPRI]</span>
<span class="sd">        List of CAPRI objects containing data attributes to be extracted.</span>
<span class="sd">    sort_key : str</span>
<span class="sd">        Key by which to sort the extracted data. Must correspond to a valid</span>
<span class="sd">        attribute in the CAPRI object (e.g., &#39;score&#39;, &#39;irmsd&#39;).</span>
<span class="sd">    sort_ascending : bool</span>
<span class="sd">        If True, sorts the data in ascending order based on the sort_key;</span>
<span class="sd">        if False, sorts in descending order.</span>
<span class="sd">    output_fname : Path</span>
<span class="sd">        Path to the output file where the sorted data will be written.</span>
<span class="sd">    add_reference_id : bool, optional</span>
<span class="sd">        Should the reference id be added to the capri table?, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ranked_data : Union[dict[int, ParamDict], None]</span>
<span class="sd">        The sorted and structured data dictionary if successful,</span>
<span class="sd">        None if no data was processed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Retrieve data for each model</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ParamDict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">capri_objects</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
            <span class="s2">&quot;md5&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">md5</span><span class="p">,</span>
            <span class="s2">&quot;caprieval_rank&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
            <span class="s2">&quot;irmsd&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">irmsd</span><span class="p">,</span>
            <span class="s2">&quot;fnat&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">fnat</span><span class="p">,</span>
            <span class="s2">&quot;lrmsd&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">lrmsd</span><span class="p">,</span>
            <span class="s2">&quot;ilrmsd&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">ilrmsd</span><span class="p">,</span>
            <span class="s2">&quot;dockq&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">dockq</span><span class="p">,</span>
            <span class="s2">&quot;rmsd&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">rmsd</span><span class="p">,</span>
            <span class="s2">&quot;cluster_id&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">clt_id</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">clt_id</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;cluster_ranking&quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">clt_rank</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">clt_rank</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;model-cluster_ranking&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">c</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">clt_model_rank</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">clt_model_rank</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">unw_energies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">unw_energies</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_reference_id</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;ref_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">ref_id</span>
    <span class="c1"># Sort models</span>
    <span class="n">ranked_data</span> <span class="o">=</span> <span class="n">rank_according_to_score</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">sort_key</span><span class="o">=</span><span class="n">sort_key</span><span class="p">,</span> <span class="n">sort_ascending</span><span class="o">=</span><span class="n">sort_ascending</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ranked_data</span><span class="p">:</span>
        <span class="c1"># This means no files have been collected</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">write_nested_dic_to_file</span><span class="p">(</span><span class="n">data_dict</span><span class="o">=</span><span class="n">ranked_data</span><span class="p">,</span> <span class="n">output_fname</span><span class="o">=</span><span class="n">output_fname</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ranked_data</span></div>



<div class="viewcode-block" id="calc_stats">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.calc_stats">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calc_stats</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the mean and stdev.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : list</span>
<span class="sd">        List of values.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mean : float</span>
<span class="sd">        Mean of the values.</span>
<span class="sd">    stdev : float</span>
<span class="sd">        Standard deviation of the values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stdev</span></div>



<span class="c1"># Define dict types</span>
<span class="n">CltData</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">CAPRI</span><span class="p">,</span> <span class="n">PDBFile</span><span class="p">]]]</span>


<div class="viewcode-block" id="capri_cluster_analysis">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.capri_cluster_analysis">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">capri_cluster_analysis</span><span class="p">(</span>
    <span class="n">capri_list</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">CAPRI</span><span class="p">],</span>
    <span class="n">model_list</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">PDBFile</span><span class="p">],</span>
    <span class="n">output_fname</span><span class="p">:</span> <span class="n">FilePath</span><span class="p">,</span>
    <span class="n">clt_threshold</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">sort_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">sort_ascending</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">FilePath</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Consider the cluster results for the CAPRI evaluation.&quot;&quot;&quot;</span>
    <span class="n">capri_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;irmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;fnat&quot;</span><span class="p">,</span> <span class="s2">&quot;lrmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;dockq&quot;</span><span class="p">,</span> <span class="s2">&quot;ilrmsd&quot;</span><span class="p">,</span> <span class="s2">&quot;rmsd&quot;</span><span class="p">]</span>
    <span class="n">model_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;air&quot;</span><span class="p">,</span> <span class="s2">&quot;bsa&quot;</span><span class="p">,</span> <span class="s2">&quot;desolv&quot;</span><span class="p">,</span> <span class="s2">&quot;elec&quot;</span><span class="p">,</span> <span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="s2">&quot;vdw&quot;</span><span class="p">]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rearranging cluster information into </span><span class="si">{</span><span class="n">output_fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># get the cluster data</span>
    <span class="n">clt_data</span><span class="p">:</span> <span class="n">CltData</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">m</span><span class="o">.</span><span class="n">clt_rank</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">clt_id</span><span class="p">),</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model_list</span><span class="p">)</span>

    <span class="c1"># add models to each cluster</span>
    <span class="k">for</span> <span class="n">capri</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">capri_list</span><span class="p">,</span> <span class="n">model_list</span><span class="p">):</span>
        <span class="n">clt_data</span><span class="p">[(</span><span class="n">model</span><span class="o">.</span><span class="n">clt_rank</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">clt_id</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">capri</span><span class="p">,</span> <span class="n">model</span><span class="p">))</span>

    <span class="n">output_dic</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ParamDict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clt_data</span><span class="p">):</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">ParamDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">number_of_models_in_cluster</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clt_data</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
        <span class="c1"># rank, cluster id, number of models in cluster</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cluster_rank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">number_of_models_in_cluster</span>
        <span class="k">if</span> <span class="n">number_of_models_in_cluster</span> <span class="o">&lt;</span> <span class="n">clt_threshold</span><span class="p">:</span>
            <span class="c1"># under-evaluated, the mean was divided by a value</span>
            <span class="c1">#  larger than the total number of models in the cluster</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;under_eval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;under_eval&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="c1"># score</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">score_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">score</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">clt_data</span><span class="p">[</span><span class="n">element</span><span class="p">][:</span><span class="n">clt_threshold</span><span class="p">]]</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;score_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_stats</span><span class="p">(</span><span class="n">score_array</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;score_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

        <span class="c1"># capri keys</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">capri_keys</span><span class="p">:</span>
            <span class="n">std_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_std&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key_array</span> <span class="o">=</span> <span class="p">[</span><span class="nb">vars</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">clt_data</span><span class="p">[</span><span class="n">element</span><span class="p">][:</span><span class="n">clt_threshold</span><span class="p">]]</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">std_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_stats</span><span class="p">(</span><span class="n">key_array</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">std_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

        <span class="c1"># model keys</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">model_keys</span><span class="p">:</span>
            <span class="n">std_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_std&quot;</span>
            <span class="k">if</span> <span class="n">clt_data</span><span class="p">[</span><span class="n">element</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">unw_energies</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">key_array</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="nb">vars</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="s2">&quot;unw_energies&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">clt_data</span><span class="p">[</span><span class="n">element</span><span class="p">][:</span><span class="n">clt_threshold</span><span class="p">]</span>
                    <span class="p">]</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">std_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc_stats</span><span class="p">(</span><span class="n">key_array</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">std_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

        <span class="n">output_dic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

    <span class="c1"># Rank according to the score</span>
    <span class="n">score_rankkey_values</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;score&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">output_dic</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">score_rankkey_values</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">score_rankkey_values</span><span class="p">):</span>
        <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">k</span>
        <span class="n">output_dic</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;caprieval_rank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Rank according to the sorting key</span>
    <span class="n">rankkey_values</span> <span class="o">=</span> <span class="p">[(</span><span class="n">key</span><span class="p">,</span> <span class="n">v</span><span class="p">[</span><span class="n">sort_key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">output_dic</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">rankkey_values</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">sort_ascending</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_output_dic</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rankkey_values</span><span class="p">):</span>
        <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">k</span>
        <span class="n">_output_dic</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_dic</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">output_dic</span> <span class="o">=</span> <span class="n">_output_dic</span>

    <span class="n">output_fname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">output_fname</span><span class="p">)</span>

    <span class="n">info_header</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
    <span class="n">info_header</span> <span class="o">+=</span> <span class="s2">&quot;# `caprieval` cluster-based analysis&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
    <span class="n">info_header</span> <span class="o">+=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
    <span class="n">info_header</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;# &gt; sortby_key=</span><span class="si">{</span><span class="n">sort_key</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
    <span class="n">info_header</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;# &gt; sort_ascending=</span><span class="si">{</span><span class="n">sort_ascending</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
    <span class="n">info_header</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;# &gt; clt_threshold=</span><span class="si">{</span><span class="n">clt_threshold</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
    <span class="n">info_header</span> <span class="o">+=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
    <span class="n">info_header</span> <span class="o">+=</span> <span class="p">(</span>
        <span class="s2">&quot;# NOTE: if under_eval=yes, it means that there were less models in&quot;</span>
        <span class="s2">&quot; a cluster than&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
    <span class="p">)</span>
    <span class="n">info_header</span> <span class="o">+=</span> <span class="p">(</span>
        <span class="s2">&quot;#    clt_threshold, thus these values were under &quot;</span> <span class="s2">&quot;evaluated.&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
    <span class="p">)</span>
    <span class="n">info_header</span> <span class="o">+=</span> <span class="p">(</span>
        <span class="s2">&quot;#   You might need to tweak the value of clt_threshold or change&quot;</span>
        <span class="s2">&quot; some parameters&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
    <span class="p">)</span>
    <span class="n">info_header</span> <span class="o">+=</span> <span class="s2">&quot;#    in `clustfcc` depending on your &quot;</span> <span class="s2">&quot;analysis.&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
    <span class="n">info_header</span> <span class="o">+=</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>
    <span class="n">info_header</span> <span class="o">+=</span> <span class="s2">&quot;#&quot;</span> <span class="o">*</span> <span class="mi">40</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="c1"># This means there were only &quot;dummy&quot; values</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">write_nested_dic_to_file</span><span class="p">(</span>
            <span class="n">output_dic</span><span class="p">,</span>
            <span class="n">output_fname</span><span class="p">,</span>
            <span class="n">info_header</span><span class="o">=</span><span class="n">info_header</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="CAPRIError">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.CAPRIError">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CAPRIError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when something goes wrong with the CAPRI class.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="dump_weights">
<a class="viewcode-back" href="../../../../../modules/analysis/haddock.modules.analysis.caprieval.capri.html#haddock.modules.analysis.caprieval.capri.dump_weights">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">dump_weights</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">sel_steps</span> <span class="o">=</span> <span class="n">get_module_steps_folders</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">))</span>
    <span class="n">cns_step</span> <span class="o">=</span> <span class="n">get_previous_cns_step</span><span class="p">(</span><span class="n">sel_steps</span><span class="o">=</span><span class="n">sel_steps</span><span class="p">,</span> <span class="n">st_order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cns_step</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found previous CNS step: </span><span class="si">{</span><span class="n">cns_step</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">scoring_params_fname</span> <span class="o">=</span> <span class="n">save_scoring_weights</span><span class="p">(</span><span class="n">cns_step</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved scoring weights to: </span><span class="si">{</span><span class="n">scoring_params_fname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No previous CNS step found. Cannot save scoring weights.&quot;</span><span class="p">)</span></div>



<span class="c1"># # debug only</span>
<span class="c1"># def write_coord_dic(output_name, coord_dic):</span>
<span class="c1">#     &quot;&quot;&quot;Add a dummy atom to a PDB file according to a list of coordinates.&quot;&quot;&quot;</span>
<span class="c1">#     with open(output_name, &quot;w&quot;) as fh:</span>
<span class="c1">#         for i, k in enumerate(coord_dic):</span>
<span class="c1">#             atom_num = f&quot;{i+1}&quot;.rjust(4, &quot; &quot;)</span>
<span class="c1">#             chain, resnum, atom = k</span>
<span class="c1">#             resnum = int(resnum)</span>
<span class="c1">#             resnum = f&quot;{resnum}&quot;.rjust(3, &quot; &quot;)</span>
<span class="c1">#             atom_name = f&quot;{atom}&quot;.rjust(3, &quot; &quot;)</span>
<span class="c1">#             x, y, z = coord_dic[k]</span>
<span class="c1">#             dum_x = f&quot;{x:.3f}&quot;.rjust(7, &quot; &quot;)</span>
<span class="c1">#             dum_y = f&quot;{y:.3f}&quot;.rjust(7, &quot; &quot;)</span>
<span class="c1">#             dum_z = f&quot;{z:.3f}&quot;.rjust(7, &quot; &quot;)</span>
<span class="c1">#             dummy_line = (</span>
<span class="c1">#                 f&quot;ATOM   {atom_num} {atom_name}  DUM {chain} {resnum}   &quot;</span>
<span class="c1">#                 f&quot;  {dum_x} {dum_y} {dum_z}  1.00  1.00   &quot;</span>
<span class="c1">#                 &quot;        H  &quot; + os.linesep</span>
<span class="c1">#                 )</span>
<span class="c1">#             fh.write(dummy_line)</span>


<span class="c1"># # debug only</span>
<span class="c1"># def write_coords(output_name, coor_list):</span>
<span class="c1">#     &quot;&quot;&quot;Add a dummy atom to a PDB file according to a list of coordinates.&quot;&quot;&quot;</span>
<span class="c1">#     with open(output_name, &quot;w&quot;) as fh:</span>
<span class="c1">#         for i, dummy_coord in enumerate(coor_list):</span>
<span class="c1">#             atom_num = f&quot;{i}&quot;.rjust(4, &quot; &quot;)</span>
<span class="c1">#             resnum = f&quot;{i}&quot;.rjust(3, &quot; &quot;)</span>
<span class="c1">#             dum_x = f&quot;{dummy_coord[0]:.3f}&quot;.rjust(7, &quot; &quot;)</span>
<span class="c1">#             dum_y = f&quot;{dummy_coord[1]:.3f}&quot;.rjust(7, &quot; &quot;)</span>
<span class="c1">#             dum_z = f&quot;{dummy_coord[2]:.3f}&quot;.rjust(7, &quot; &quot;)</span>
<span class="c1">#             dummy_line = (</span>
<span class="c1">#                 f&quot;ATOM   {atom_num}  H   DUM X {resnum}   &quot;</span>
<span class="c1">#                 f&quot;  {dum_x} {dum_y} {dum_z}  1.00  1.00   &quot;</span>
<span class="c1">#                 &quot;        H  &quot; + os.linesep</span>
<span class="c1">#                 )</span>
<span class="c1">#             fh.write(dummy_line)</span>


<span class="c1"># # debug only</span>
<span class="c1"># def write_pymol_viz(resdic):</span>
<span class="c1">#     &quot;&quot;&quot;Write PyMol vizualitation.&quot;&quot;&quot;</span>
<span class="c1">#     for k in resdic:</span>
<span class="c1">#         reslist = &quot;+&quot;.join(map(str, resdic[k]))</span>
<span class="c1">#         cmd = f&quot;sele {k}, chain {k} and resid {reslist}&quot;</span>
<span class="c1">#         print(cmd)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, BonvinLab.
      <span class="lastupdated">Last updated on Jun 16, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>